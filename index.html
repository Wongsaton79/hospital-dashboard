<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hospital Dashboard (Fixed)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style> 
        body { font-family: 'Sarabun', sans-serif; background-color: #f8fafc; }
        .card { background: white; border-radius: 16px; padding: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .active-tab { border-bottom: 3px solid #f59e0b; color: #d97706; background-color: #fffbeb; }
        .inactive-tab { color: #64748b; }
        .inactive-tab:hover { background-color: #f8fafc; }
    </style>
</head>
<body class="p-6">
    
    <div id="loader" class="fixed inset-0 bg-white z-50 flex flex-col justify-center items-center">
        <div class="w-10 h-10 border-4 border-amber-500 border-t-transparent rounded-full animate-spin"></div>
        <p class="mt-4 text-gray-500 font-bold">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
    </div>

    <div class="max-w-7xl mx-auto flex justify-between items-center mb-6">
        <div>
            <h1 class="text-3xl font-bold text-slate-800">üè• Hospital Dashboard</h1>
            <p id="dateInfo" class="text-sm text-gray-500">Connecting...</p>
        </div>
        <div class="bg-white p-1 rounded-lg border shadow-sm flex">
            <button onclick="setView('1D')" id="btn1D" class="px-4 py-1 text-sm font-bold rounded-md">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</button>
            <button onclick="setView('7D')" id="btn7D" class="px-4 py-1 text-sm font-bold rounded-md">7 ‡∏ß‡∏±‡∏ô</button>
            <button onclick="setView('1M')" id="btn1M" class="px-4 py-1 text-sm font-bold rounded-md">30 ‡∏ß‡∏±‡∏ô</button>
        </div>
    </div>

    <div class="max-w-7xl mx-auto grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
        <div class="card border-l-4 border-gray-400">
            <p class="text-xs font-bold text-gray-400 uppercase">‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏Å‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p>
            <h2 class="text-4xl font-bold text-gray-800 mt-1" id="kpiTotal">0</h2>
        </div>
        <div class="card border-l-4 border-emerald-500">
            <p class="text-xs font-bold text-emerald-600 uppercase">‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô (Scan)</p>
            <h2 class="text-4xl font-bold text-emerald-600 mt-1" id="kpiScan">0</h2>
        </div>
        <div class="card border-l-4 border-blue-500">
            <p class="text-xs font-bold text-blue-600 uppercase">‡∏•‡∏≤‡∏á‡∏≤‡∏ô (Leave)</p>
            <h2 class="text-4xl font-bold text-blue-600 mt-1" id="kpiLeave">0</h2>
        </div>
        <div class="card border-l-4 border-red-500">
            <p class="text-xs font-bold text-red-600 uppercase">‡∏Ç‡∏≤‡∏î‡∏á‡∏≤‡∏ô (Missing)</p>
            <h2 class="text-4xl font-bold text-red-600 mt-1" id="kpiMissing">0</h2>
        </div>
    </div>

    <div class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
        <div class="card lg:col-span-2 h-80">
            <h3 class="font-bold text-gray-700 mb-4">üìà ‡∏Å‡∏£‡∏≤‡∏ü‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô (‡∏ï‡∏≤‡∏°‡πÄ‡∏ß‡∏•‡∏≤)</h3>
            <div class="h-60"><canvas id="lineChart"></canvas></div>
        </div>
        <div class="card h-80 flex flex-col items-center">
            <h3 class="font-bold text-gray-700 mb-4 w-full">üìä ‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</h3>
            <div class="h-56 w-56 relative"><canvas id="pieChart"></canvas></div>
        </div>
    </div>

    <div class="max-w-7xl mx-auto bg-white rounded-xl shadow overflow-hidden">
        <div class="flex border-b">
            <button onclick="switchTab('missing')" id="tab-missing" class="flex-1 py-3 text-sm font-bold active-tab">‚ö†Ô∏è ‡∏Ñ‡∏ô‡∏Ç‡∏≤‡∏î‡∏á‡∏≤‡∏ô (‡πÅ‡∏¢‡∏Å‡πÅ‡∏ú‡∏ô‡∏Å)</button>
            <button onclick="switchTab('late')" id="tab-late" class="flex-1 py-3 text-sm font-bold inactive-tab">‚è∞ ‡∏°‡∏≤‡∏™‡∏≤‡∏¢</button>
            <button onclick="switchTab('leave')" id="tab-leave" class="flex-1 py-3 text-sm font-bold inactive-tab">üìù ‡∏•‡∏≤‡∏á‡∏≤‡∏ô</button>
        </div>
        <div class="h-80 overflow-y-auto p-4 bg-gray-50">
            <div id="content-missing" class="block"></div>
            <div id="content-late" class="hidden"></div>
            <div id="content-leave" class="hidden"></div>
        </div>
    </div>

    <div id="modalList" class="fixed inset-0 z-50 hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
        <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" onclick="closeModal()"></div>
        <div class="fixed inset-0 z-10 overflow-y-auto">
            <div class="flex min-h-full items-end justify-center p-4 text-center sm:items-center sm:p-0">
                <div class="relative transform overflow-hidden rounded-lg bg-white text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-lg">
                    <div class="bg-white px-4 pb-4 pt-5 sm:p-6 sm:pb-4">
                        <h3 class="text-lg font-semibold leading-6 text-gray-900 mb-4" id="modalTitle">‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠</h3>
                        <div class="max-h-96 overflow-y-auto">
                            <table class="w-full text-sm text-left">
                                <thead class="bg-gray-100 text-gray-600" id="modalHeader"></thead>
                                <tbody id="tblModalContent"></tbody>
                            </table>
                        </div>
                    </div>
                    <div class="bg-gray-50 px-4 py-3 sm:flex sm:flex-row-reverse sm:px-6">
                        <button type="button" class="mt-3 inline-flex w-full justify-center rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50 sm:mt-0 sm:w-auto" onclick="closeModal()">‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = "https://bdlh-cs-default-rtdb.asia-southeast1.firebasedatabase.app/data.json";
        let db = { staff: {}, records: [] };
        let currentRecords = [];
        let chartL = null, chartP = null;
        let isRange = false;

        window.onload = async () => {
            try {
                // Cache Busting: ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏´‡∏°‡πà ‡πÑ‡∏°‡πà‡πÄ‡∏≠‡∏≤‡∏à‡∏≤‡∏Å‡πÅ‡∏Ñ‡∏ä
                const res = await fetch(`${API_URL}?t=${Date.now()}`);
                const json = await res.json();
                if(json) {
                    db = json;
                    if(!db.records) db.records = [];
                    // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà
                    db.records.sort((a,b) => new Date(a.date) - new Date(b.date));
                    setView('1D');
                } else {
                    alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö');
                }
            } catch(e) { console.error(e); alert('‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ'); }
            document.getElementById('loader').classList.add('hidden');
        };

        function setView(mode) {
            // Update Buttons
            ['1D','7D','1M'].forEach(id => {
                document.getElementById('btn'+id).className = id === mode 
                    ? "px-4 py-1 text-sm font-bold rounded-md bg-amber-500 text-white shadow" 
                    : "px-4 py-1 text-sm font-bold rounded-md text-gray-600 hover:bg-gray-100";
            });

            if(db.records.length === 0) return;

            isRange = mode !== '1D';
            if(mode === '1D') currentRecords = [db.records[db.records.length-1]];
            else if(mode === '7D') currentRecords = db.records.slice(-7);
            else currentRecords = db.records.slice(-30);

            renderDashboard();
        }

        function renderDashboard() {
            const latest = currentRecords[currentRecords.length-1];
            document.getElementById('dateInfo').innerText = isRange 
                ? `‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á ${currentRecords.length} ‡∏ß‡∏±‡∏ô` 
                : `‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${latest.date} (${latest.day})`;

            // KPI Calculation
            const staffCount = Object.keys(db.staff).length;
            let sumScan=0, sumLeave=0;
            currentRecords.forEach(r => {
                sumScan += r.summary.scanned;
                sumLeave += (r.summary.leave || 0);
            });
            
            // Average for range
            const div = currentRecords.length;
            const avgScan = Math.round(sumScan/div);
            const avgLeave = Math.round(sumLeave/div);
            // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Missing ‡πÉ‡∏´‡∏°‡πà‡∏à‡∏≤‡∏Å Staff ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô - Scan - Leave
            const avgMiss = staffCount - avgScan - avgLeave;

            document.getElementById('kpiTotal').innerText = staffCount;
            document.getElementById('kpiScan').innerText = avgScan;
            document.getElementById('kpiLeave').innerText = avgLeave;
            document.getElementById('kpiMissing').innerText = avgMiss < 0 ? 0 : avgMiss;

            renderCharts(avgScan, avgLeave, avgMiss);
            renderTables(latest); // Tables show ONLY latest day detail
        }

        function renderCharts(scan, leave, miss) {
            const ctxL = document.getElementById('lineChart');
            const ctxP = document.getElementById('pieChart');
            
            if(chartL) chartL.destroy();
            if(chartP) chartP.destroy();

            // Pie Chart
            chartP = new Chart(ctxP, {
                type: 'doughnut',
                data: {
                    labels: ['‡∏°‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô', '‡∏•‡∏≤‡∏á‡∏≤‡∏ô', '‡∏Ç‡∏≤‡∏î‡∏á‡∏≤‡∏ô'],
                    datasets: [{
                        data: [scan, leave, miss < 0 ? 0 : miss],
                        backgroundColor: ['#10b981', '#3b82f6', '#ef4444'],
                        borderWidth: 0
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, cutout: '70%' }
            });

            // Line Chart
            let labels = [], dataIn = [];
            if(isRange) {
                // Range View: Show trend by date
                labels = currentRecords.map(r => r.date.split('-').slice(1).join('/')); // MM/DD
                dataIn = currentRecords.map(r => r.summary.scanned);
            } else {
                // Daily View: Show hourly trend
                labels = Array.from({length: 15}, (_, i) => `${i+6}:00`); // 6:00 - 20:00
                const hourly = currentRecords[0].charts.hourly;
                dataIn = labels.map((_, i) => hourly[i+6] ? hourly[i+6].in : 0);
            }

            chartL = new Chart(ctxL, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô (‡∏Ñ‡∏ô)',
                        data: dataIn,
                        borderColor: '#f59e0b',
                        backgroundColor: '#fcd34d',
                        tension: 0.3,
                        fill: true
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }

        function renderTables(data) {
            // 1. Missing (Group by Dept)
            // Recalculate missing based on CURRENT Staff list (Anti-Crash)
            const missingDept = {};
            const scannedIds = new Set(data.scannedIds);
            
            // Loop Staff ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
            Object.values(db.staff).forEach(emp => {
                if(!scannedIds.has(emp.id)) {
                    // Check if Leave? (Optional: ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ logic leave id)
                    const dept = emp.dept || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
                    missingDept[dept] = (missingDept[dept] || 0) + 1;
                }
            });

            const missDiv = document.getElementById('content-missing');
            if(Object.keys(missingDept).length === 0) {
                missDiv.innerHTML = '<p class="text-center text-gray-400 py-4">‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô</p>';
            } else {
                let html = '<div class="grid grid-cols-2 md:grid-cols-3 gap-3">';
                Object.entries(missingDept).forEach(([dept, count]) => {
                    html += `<div onclick="openMissingModal('${dept}')" class="bg-white border border-red-100 p-3 rounded-lg shadow-sm cursor-pointer hover:bg-red-50 transition">
                        <div class="text-xs text-gray-500 truncate" title="${dept}">${dept}</div>
                        <div class="text-2xl font-bold text-red-600 mt-1">${count} <span class="text-xs font-normal text-gray-400">‡∏Ñ‡∏ô</span></div>
                    </div>`;
                });
                html += '</div>';
                missDiv.innerHTML = html;
            }

            // 2. Late
            const lateDiv = document.getElementById('content-late');
            if(!data.lists.late || data.lists.late.length === 0) {
                lateDiv.innerHTML = '<p class="text-center text-gray-400 py-4">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏ô‡∏™‡∏≤‡∏¢</p>';
            } else {
                lateDiv.innerHTML = '<table class="w-full text-sm text-left">' + 
                    data.lists.late.map(l => `
                        <tr class="border-b hover:bg-gray-50">
                            <td class="p-2 font-bold text-gray-700">${l.name || 'Unknown'}</td>
                            <td class="p-2 text-gray-500 text-xs">${l.dept}</td>
                            <td class="p-2 text-orange-600 font-mono text-right">${l.time}</td>
                            <td class="p-2 text-red-600 font-bold text-right">+${l.lateMins} ‡∏ô.</td>
                        </tr>
                    `).join('') + '</table>';
            }

            // 3. Leave
             const leaveDiv = document.getElementById('content-leave');
             if(!data.lists.leave || data.lists.leave.length === 0) {
                 leaveDiv.innerHTML = '<p class="text-center text-gray-400 py-4">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏ô‡∏•‡∏≤</p>';
             } else {
                 leaveDiv.innerHTML = '<table class="w-full text-sm text-left">' + 
                     data.lists.leave.map(l => `
                         <tr class="border-b hover:bg-gray-50">
                             <td class="p-2 font-bold text-gray-700">${l.name}</td>
                             <td class="p-2 text-blue-600">${l.type || '‡∏•‡∏≤'}</td>
                         </tr>
                     `).join('') + '</table>';
             }
        }

        // --- Tab Switching ---
        window.switchTab = function(tabName) {
            ['missing','late','leave'].forEach(t => {
                document.getElementById('content-'+t).className = t===tabName ? 'block' : 'hidden';
                document.getElementById('tab-'+t).className = t===tabName ? 'flex-1 py-3 text-sm font-bold active-tab' : 'flex-1 py-3 text-sm font-bold inactive-tab';
            });
        }

        // --- Modals ---
        window.openMissingModal = function(deptName) {
            const data = currentRecords[currentRecords.length-1];
            const scannedIds = new Set(data.scannedIds);
            const missingList = [];

            // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏ô‡∏Ç‡∏≤‡∏î‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÅ‡∏ú‡∏ô‡∏Å‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
            Object.values(db.staff).forEach(emp => {
                const empDept = emp.dept || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
                if(!scannedIds.has(emp.id) && empDept === deptName) {
                    missingList.push(emp);
                }
            });

            document.getElementById('modalTitle').innerText = `‡∏Ñ‡∏ô‡∏Ç‡∏≤‡∏î‡∏á‡∏≤‡∏ô: ${deptName}`;
            document.getElementById('modalHeader').innerHTML = `<tr><th class="p-2 text-left">ID</th><th class="p-2 text-left">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th></tr>`;
            
            const tbody = document.getElementById('tblModalContent');
            tbody.innerHTML = missingList.map(m => `
                <tr class="border-b">
                    <td class="p-2 font-mono text-xs text-gray-500">${m.id}</td>
                    <td class="p-2 font-bold text-red-600">${m.name}</td>
                </tr>
            `).join('');

            document.getElementById('modalList').classList.remove('hidden');
        }

        window.closeModal = function() {
            document.getElementById('modalList').classList.add('hidden');
        }
    </script>
</body>
</html>
