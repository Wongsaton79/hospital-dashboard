<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style> body { font-family: 'Sarabun', sans-serif; background: #f8fafc; } </style>
</head>
<body class="p-6">
    
    <div id="pageLoader" class="fixed inset-0 bg-white z-50 flex flex-col justify-center items-center">
        <div class="w-10 h-10 border-4 border-indigo-500 border-t-transparent rounded-full animate-spin"></div>
        <p class="mt-4 text-gray-500 font-bold">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
    </div>

    <div class="max-w-7xl mx-auto flex justify-between items-center mb-6">
        <div>
            <h1 class="text-3xl font-bold text-indigo-900">üè• Hospital Dashboard</h1>
            <p id="lastUpdate" class="text-sm text-gray-500">Connecting...</p>
        </div>
        <div class="flex gap-2">
            <button onclick="fetchData()" class="bg-indigo-50 text-indigo-600 px-4 py-2 rounded font-bold hover:bg-indigo-100">Refresh</button>
        </div>
    </div>

    <div class="max-w-7xl mx-auto grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
        <div class="bg-white p-5 rounded-xl shadow border-l-4 border-gray-400">
            <p class="text-xs font-bold text-gray-400 uppercase">‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏Å‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p>
            <h2 class="text-4xl font-bold text-gray-800 mt-1" id="kpiTotal">0</h2>
        </div>
        <div class="bg-white p-5 rounded-xl shadow border-l-4 border-green-500">
            <p class="text-xs font-bold text-green-600 uppercase">‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô (Scan)</p>
            <h2 class="text-4xl font-bold text-green-600 mt-1" id="kpiScan">0</h2>
        </div>
        <div class="bg-white p-5 rounded-xl shadow border-l-4 border-blue-500">
            <p class="text-xs font-bold text-blue-600 uppercase">‡∏•‡∏≤‡∏á‡∏≤‡∏ô (Leave)</p>
            <h2 class="text-4xl font-bold text-blue-600 mt-1" id="kpiLeave">0</h2>
        </div>
        <div class="bg-white p-5 rounded-xl shadow border-l-4 border-red-500">
            <p class="text-xs font-bold text-red-600 uppercase">‡∏Ç‡∏≤‡∏î‡∏á‡∏≤‡∏ô (Missing)</p>
            <h2 class="text-4xl font-bold text-red-600 mt-1" id="kpiMissing">0</h2>
        </div>
    </div>

    <div class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-6">
        <div class="bg-white p-5 rounded-xl shadow lg:col-span-2 h-80">
            <h3 class="font-bold text-gray-700 mb-2">üìà ‡∏Å‡∏£‡∏≤‡∏ü‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô (‡∏ï‡∏≤‡∏°‡πÄ‡∏ß‡∏•‡∏≤)</h3>
            <div class="h-64"><canvas id="lineChart"></canvas></div>
        </div>
        <div class="bg-white p-5 rounded-xl shadow h-80 flex flex-col items-center">
            <h3 class="font-bold text-gray-700 mb-2 w-full">üìä ‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</h3>
            <div class="h-56 w-56 relative">
                <canvas id="pieChart"></canvas>
            </div>
        </div>
    </div>

    <script>
        // ‚úÖ URL Firebase (‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢)
        const RAW_URL = "https://bdlh-cs-default-rtdb.asia-southeast1.firebasedatabase.app/"; 
        const CLEAN_URL = RAW_URL.endsWith('/') ? RAW_URL.slice(0, -1) : RAW_URL;
        const API_URL = `${CLEAN_URL}/data.json`;
        
        let chartL = null, chartP = null;

        window.onload = fetchData;

        async function fetchData() {
            try {
                const res = await fetch(API_URL);
                if(res.ok) {
                    const data = await res.json();
                    if(data && data.records && data.records.length > 0) {
                        // ‡πÄ‡∏≠‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏±‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
                        const latest = data.records[data.records.length - 1];
                        const staffCount = data.staff ? Object.keys(data.staff).length : 0;
                        renderDashboard(latest, staffCount);
                    } else {
                        alert("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö");
                        document.getElementById('pageLoader').classList.add('hidden');
                    }
                }
            } catch(e) { console.error(e); alert("‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ"); }
        }

        function renderDashboard(data, totalStaff) {
            document.getElementById('pageLoader').classList.add('hidden');
            document.getElementById('lastUpdate').innerText = `‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${data.date} (${data.day})`;

            // KPI
            document.getElementById('kpiTotal').innerText = totalStaff;
            document.getElementById('kpiScan').innerText = data.summary.scanned;
            document.getElementById('kpiLeave').innerText = data.summary.leave || 0;
            
            // üî• ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Missing ‡πÉ‡∏´‡∏°‡πà ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏±‡∏ß‡∏£‡πå (Total - Scan - Leave)
            // (‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏£‡∏ì‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤‡∏Ñ‡πâ‡∏≤‡∏á)
            const missing = totalStaff - data.summary.scanned - (data.summary.leave || 0);
            document.getElementById('kpiMissing').innerText = missing < 0 ? 0 : missing;

            // Charts
            const ctxL = document.getElementById('lineChart');
            const ctxP = document.getElementById('pieChart');

            if(chartL) chartL.destroy();
            if(chartP) chartP.destroy();

            // Pie Chart
            chartP = new Chart(ctxP, {
                type: 'doughnut',
                data: {
                    labels: ['‡∏°‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô', '‡∏•‡∏≤‡∏á‡∏≤‡∏ô', '‡∏Ç‡∏≤‡∏î‡∏á‡∏≤‡∏ô'],
                    datasets: [{
                        data: [data.summary.scanned, data.summary.leave || 0, missing < 0 ? 0 : missing],
                        backgroundColor: ['#10b981', '#3b82f6', '#ef4444'],
                        borderWidth: 0
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, cutout: '70%' }
            });

            // Line Chart (Hourly)
            const h = data.charts.hourly;
            const labels = [], dIn = [], dOut = [];
            for(let i=6; i<=20; i++) { // 06:00 - 20:00
                labels.push(`${i}:00`);
                dIn.push(h[i] ? h[i].in : 0);
                dOut.push(h[i] ? h[i].out : 0);
            }

            chartL = new Chart(ctxL, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        { label: '‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô', data: dIn, borderColor: '#10b981', backgroundColor: '#10b981', tension: 0.3 },
                        { label: '‡∏≠‡∏≠‡∏Å‡∏á‡∏≤‡∏ô', data: dOut, borderColor: '#3b82f6', backgroundColor: '#3b82f6', tension: 0.3 }
                    ]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }
    </script>
</body>
</html>
