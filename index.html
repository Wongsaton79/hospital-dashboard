<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard ‡∏ú‡∏π‡πâ‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£ (Premium UI)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style> 
        body { font-family: 'Sarabun', sans-serif; background-color: #f1f5f9; background-image: radial-gradient(#e2e8f0 1px, transparent 1px); background-size: 24px 24px; }
        
        /* Premium Card Style */
        .card { 
            background: rgba(255, 255, 255, 0.9); 
            backdrop-filter: blur(10px);
            border-radius: 20px; 
            padding: 24px; 
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.05), 0 8px 10px -6px rgba(0, 0, 0, 0.01);
            border: 1px solid rgba(255, 255, 255, 0.5);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }

        /* Modern Tabs */
        .tab-btn { transition: all 0.3s ease; border-bottom: 3px solid transparent; }
        .active-tab { 
            border-bottom: 3px solid #6366f1; 
            color: #4f46e5; 
            background: linear-gradient(to top, #eef2ff 0%, transparent 100%);
        }
        .inactive-tab { color: #64748b; }
        .inactive-tab:hover { color: #334155; background-color: #f8fafc; }

        /* Loader */
        .page-loader { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.95); backdrop-filter: blur(5px); z-index:9999; display:flex; justify-content:center; align-items:center; flex-direction:column; }
        .spinner { border: 4px solid #e2e8f0; border-top: 4px solid #6366f1; border-radius: 50%; width: 50px; height: 50px; animation: spin 0.8s cubic-bezier(0.4, 0, 0.2, 1) infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Table Styling */
        .custom-table th { font-weight: 600; text-transform: uppercase; font-size: 0.75rem; letter-spacing: 0.05em; color: #64748b; background-color: #f8fafc; }
        .clickable-row { cursor: pointer; transition: background 0.15s; }
        .clickable-row:hover { background-color: #f1f5f9; }

        /* Modal Animation */
        .modal { transition: opacity 0.3s ease-in-out, visibility 0.3s; }
        .modal-active { overflow: hidden; }
        .modal-content { transform: scale(0.95); opacity: 0; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .modal:not(.opacity-0) .modal-content { transform: scale(1); opacity: 1; }
    </style>
</head>
<body class="p-4 md:p-8 text-slate-800 antialiased">

    <div id="pageLoader" class="page-loader">
        <div class="spinner mb-6 shadow-lg"></div>
        <h2 class="text-2xl font-bold text-slate-800">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</h2>
        <p class="text-sm text-slate-500 mt-2">Connecting to Secure Cloud Database</p>
    </div>

    <div class="max-w-[1400px] mx-auto flex flex-col md:flex-row justify-between items-end mb-8 gap-4">
        <div>
            <div class="flex items-center gap-3 mb-1">
                <span class="bg-indigo-100 text-indigo-700 p-2 rounded-lg text-2xl">üè•</span>
                <h1 class="text-3xl font-bold text-slate-800 tracking-tight">Executive Dashboard</h1>
            </div>
            <p class="text-sm text-slate-500 ml-12">‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏Å‡∏£‡πÅ‡∏ö‡∏ö Real-time</p>
        </div>
        
        <div class="bg-white p-1.5 rounded-xl border border-slate-200 shadow-sm flex overflow-x-auto">
            <button onclick="setView('1D')" id="btn1D" class="px-5 py-2 text-sm font-semibold rounded-lg transition-all shadow-sm bg-indigo-600 text-white">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</button>
            <button onclick="setView('Yesterday')" id="btnYesterday" class="px-5 py-2 text-sm font-semibold rounded-lg text-slate-600 hover:bg-slate-50 transition-all">‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ß‡∏≤‡∏ô</button>
            <button onclick="setView('7D')" id="btn7D" class="px-5 py-2 text-sm font-semibold rounded-lg text-slate-600 hover:bg-slate-50 transition-all">7 ‡∏ß‡∏±‡∏ô</button>
            <button onclick="setView('1M')" id="btn1M" class="px-5 py-2 text-sm font-semibold rounded-lg text-slate-600 hover:bg-slate-50 transition-all">1 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</button>
        </div>
    </div>

    <div class="max-w-[1400px] mx-auto mb-8 bg-gradient-to-r from-indigo-600 to-violet-600 text-white px-8 py-5 rounded-2xl shadow-lg shadow-indigo-200 flex items-center justify-between relative overflow-hidden">
        <div class="absolute right-0 top-0 h-full w-1/3 bg-white/10 skew-x-12 transform origin-bottom-left"></div>
        <div class="relative z-10 flex flex-col md:flex-row md:items-center gap-4">
            <span id="badgeMode" class="bg-white/20 backdrop-blur-md border border-white/30 text-white text-xs font-bold px-3 py-1 rounded-full uppercase tracking-wider w-fit">TODAY VIEW</span>
            <div>
                <span class="text-indigo-100 text-xs uppercase font-semibold tracking-wider block mb-1">Period Selection</span>
                <span id="txtDate" class="text-white font-bold text-xl md:text-2xl drop-shadow-sm">-</span>
            </div>
        </div>
        <div id="badgeWeekend" class="hidden relative z-10 bg-orange-400/90 text-white text-xs font-bold px-4 py-1.5 rounded-full shadow-sm flex items-center gap-2">
            <span>üìÖ</span> ‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡πÄ‡∏™‡∏≤‡∏£‡πå-‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå
        </div>
    </div>

    <div class="max-w-[1400px] mx-auto grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
        <div class="card border-l-[6px] border-slate-400 group">
            <div class="flex justify-between items-start">
                <div>
                    <p class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏Å‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p>
                    <h2 class="text-4xl font-bold text-slate-700" id="kpiTotal">0</h2>
                </div>
                <div class="bg-slate-100 p-3 rounded-xl group-hover:bg-slate-200 transition">üë•</div>
            </div>
        </div>
        <div class="card border-l-[6px] border-emerald-500 group">
            <div class="flex justify-between items-start">
                <div>
                    <p class="text-xs font-bold text-emerald-600 uppercase tracking-wider mb-2">‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô (Scan)</p>
                    <h2 class="text-4xl font-bold text-emerald-600" id="kpiScan">0</h2>
                </div>
                <div class="bg-emerald-50 p-3 rounded-xl group-hover:bg-emerald-100 transition">‚úÖ</div>
            </div>
            <div class="mt-4 w-full bg-emerald-100 rounded-full h-1.5">
                <div class="bg-emerald-500 h-1.5 rounded-full transition-all duration-1000" id="barScan" style="width: 0%"></div>
            </div>
            <p class="text-xs text-emerald-600 mt-2 font-bold text-right" id="pctScan">0%</p>
        </div>
        <div class="card border-l-[6px] border-blue-500 cursor-pointer group hover:ring-4 hover:ring-blue-50 transition-all" onclick="openModal()">
            <div class="flex justify-between items-start">
                <div>
                    <p class="text-xs font-bold text-blue-600 uppercase tracking-wider mb-2 flex items-center gap-1">‡∏•‡∏≤‡∏á‡∏≤‡∏ô/‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£ <span class="text-[10px] bg-blue-100 px-1 rounded">CLICK</span></p>
                    <h2 class="text-4xl font-bold text-blue-600" id="kpiLeave">0</h2>
                </div>
                <div class="bg-blue-50 p-3 rounded-xl group-hover:bg-blue-100 transition">üìù</div>
            </div>
            <div class="mt-4 w-full bg-blue-100 rounded-full h-1.5">
                <div class="bg-blue-500 h-1.5 rounded-full transition-all duration-1000" id="barLeave" style="width: 0%"></div>
            </div>
            <p class="text-xs text-blue-600 mt-2 font-bold text-right" id="pctLeave">0%</p>
        </div>
        <div class="card border-l-[6px] border-rose-500 group">
            <div class="flex justify-between items-start">
                <div>
                    <p class="text-xs font-bold text-rose-600 uppercase tracking-wider mb-2">‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏™‡πÅ‡∏Å‡∏ô (Missing)</p>
                    <h2 class="text-4xl font-bold text-rose-600" id="kpiMissing">0</h2>
                </div>
                <div class="bg-rose-50 p-3 rounded-xl group-hover:bg-rose-100 transition">‚ö†Ô∏è</div>
            </div>
            <div class="mt-4 w-full bg-rose-100 rounded-full h-1.5">
                <div class="bg-rose-500 h-1.5 rounded-full transition-all duration-1000" id="barMissing" style="width: 0%"></div>
            </div>
            <p class="text-xs text-rose-600 mt-2 font-bold text-right" id="pctMissing">0%</p>
        </div>
    </div>

    <div class="max-w-[1400px] mx-auto grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
        <div class="card lg:col-span-2 min-h-[400px]">
            <div class="flex items-center justify-between mb-6">
                <h3 class="font-bold text-slate-700 text-lg flex items-center gap-2">
                    <span class="w-2 h-6 bg-indigo-500 rounded-full"></span>
                    <span id="titleLine">üìà ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô</span>
                </h3>
            </div>
            <div class="h-[320px] w-full"><canvas id="lineChart"></canvas></div>
        </div>
        
        <div class="card min-h-[400px] flex flex-col items-center justify-center relative">
            <h3 class="font-bold text-slate-700 text-lg absolute top-6 left-6 flex items-center gap-2">
                <span class="w-2 h-6 bg-slate-500 rounded-full"></span>
                üìä ‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
            </h3>
            <div class="h-64 w-64 relative mt-8">
                <canvas id="pieChart"></canvas>
                <div class="absolute inset-0 flex flex-col items-center justify-center pointer-events-none">
                    <span class="text-slate-400 text-xs font-semibold uppercase tracking-wider">Total</span>
                    <span class="text-4xl font-bold text-slate-700" id="centerPieTotal">0</span>
                </div>
            </div>
        </div>
    </div>

    <div class="max-w-[1400px] mx-auto bg-white rounded-2xl shadow-xl border border-slate-100 overflow-hidden mb-12">
        <div class="flex border-b border-slate-100 overflow-x-auto bg-slate-50/50 p-2 gap-2">
            <button onclick="tab('missing')" id="tab-missing" class="tab-btn flex-1 py-3 px-4 text-sm font-bold active-tab rounded-lg whitespace-nowrap">1. ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏™‡πÅ‡∏Å‡∏ô</button>
            <button onclick="tab('dept')" id="tab-dept" class="tab-btn flex-1 py-3 px-4 text-sm font-bold inactive-tab rounded-lg whitespace-nowrap">2. ‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡πÅ‡∏ú‡∏ô‡∏Å</button>
            <button onclick="tab('late')" id="tab-late" class="tab-btn flex-1 py-3 px-4 text-sm font-bold inactive-tab rounded-lg whitespace-nowrap">3. ‡∏™‡∏≤‡∏¢ (>08:30)</button>
            <button onclick="tab('arriveEarly')" id="tab-arriveEarly" class="tab-btn flex-1 py-3 px-4 text-sm font-bold inactive-tab rounded-lg whitespace-nowrap text-emerald-700">4. ‡∏°‡∏≤‡πÄ‡∏ä‡πâ‡∏≤ (<08:00)</button>
            <button onclick="tab('earlyLeave')" id="tab-earlyLeave" class="tab-btn flex-1 py-3 px-4 text-sm font-bold inactive-tab rounded-lg whitespace-nowrap">5. ‡∏Å‡∏•‡∏±‡∏ö‡∏Å‡πà‡∏≠‡∏ô (16:30)</button>
        </div>
        
        <div class="p-0 h-[450px] overflow-y-auto bg-white scrollbar-thin scrollbar-thumb-slate-200 scrollbar-track-transparent">
            <div id="content-missing" class="block p-4">
                <table class="w-full text-sm text-left custom-table rounded-lg overflow-hidden">
                    <thead class="sticky top-0 shadow-sm" id="headMissing"></thead>
                    <tbody id="tblMissing" class="divide-y divide-slate-100"></tbody>
                </table>
            </div>
            
            <div id="content-dept" class="hidden p-4">
                <div class="p-3 bg-amber-50 text-amber-800 text-xs font-semibold text-center rounded-lg mb-3 border border-amber-100">
                    üí° Tips: ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡πÅ‡∏ñ‡∏ß‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏ô‡∏Ç‡∏≤‡∏î‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡πÅ‡∏ú‡∏ô‡∏Å‡∏ô‡∏±‡πâ‡∏ô
                </div>
                <table class="w-full text-sm text-left custom-table rounded-lg overflow-hidden">
                    <tbody id="tblDept" class="divide-y divide-slate-100"></tbody>
                </table>
            </div>

            <div id="content-late" class="hidden p-4">
                <table class="w-full text-sm text-left custom-table rounded-lg overflow-hidden">
                    <thead class="sticky top-0 shadow-sm" id="headLate"></thead>
                    <tbody id="tblLate" class="divide-y divide-slate-100"></tbody>
                </table>
            </div>

            <div id="content-arriveEarly" class="hidden p-4">
                <table class="w-full text-sm text-left custom-table rounded-lg overflow-hidden">
                    <thead class="bg-emerald-50 text-emerald-900 sticky top-0 shadow-sm">
                        <tr><th class="p-4 rounded-tl-lg">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th><th class="p-4">‡πÅ‡∏ú‡∏ô‡∏Å</th><th class="p-4">‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤</th><th class="p-4 text-right rounded-tr-lg">‡∏°‡∏≤‡∏Å‡πà‡∏≠‡∏ô (‡∏ô‡∏≤‡∏ó‡∏µ)</th></tr>
                    </thead>
                    <tbody id="tblArriveEarly" class="divide-y divide-slate-100"></tbody>
                </table>
            </div>

            <div id="content-earlyLeave" class="hidden p-4">
                <table class="w-full text-sm text-left custom-table rounded-lg overflow-hidden">
                    <tbody id="tblEarlyLeave" class="divide-y divide-slate-100"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="modalList" class="modal opacity-0 pointer-events-none fixed inset-0 z-50 flex items-center justify-center bg-slate-900/60 backdrop-blur-sm p-4">
        <div class="bg-white w-full md:max-w-3xl rounded-2xl shadow-2xl overflow-hidden max-h-[85vh] flex flex-col modal-content">
            <div class="p-5 border-b bg-slate-50 flex justify-between items-center">
                <h3 class="font-bold text-slate-800 text-lg flex items-center gap-2">
                    <span class="w-1.5 h-6 bg-indigo-600 rounded-full"></span>
                    <span id="modalTitle">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</span>
                </h3>
                <button onclick="closeModal()" class="w-8 h-8 flex items-center justify-center rounded-full bg-white text-slate-400 hover:text-rose-500 hover:bg-rose-50 transition shadow-sm font-bold text-xl">&times;</button>
            </div>
            <div class="overflow-y-auto p-0 flex-1">
                <table class="w-full text-sm text-left custom-table">
                    <thead class="text-slate-500 bg-slate-50 sticky top-0" id="modalHeader"></thead>
                    <tbody id="tblModalContent" class="divide-y divide-slate-100"></tbody>
                </table>
            </div>
            <div class="p-4 border-t bg-slate-50 text-right">
                <button onclick="closeModal()" class="px-5 py-2 bg-white border border-slate-300 text-slate-700 font-bold rounded-lg hover:bg-slate-100 transition shadow-sm text-sm">‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á</button>
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        // üõë DO NOT TOUCH LOGIC BELOW - PURE COPY üõë
        // ==========================================
        const FIREBASE_URL = "https://bdlh-cs-default-rtdb.asia-southeast1.firebasedatabase.app/"; 

        const API_URL = `${FIREBASE_URL}/data.json`;
        let db = [], currentData = [], isRange = false, chartL = null, chartP = null;

        window.onload = async () => {
            if(FIREBASE_URL.includes("YOUR-PROJECT")) {
                document.getElementById('pageLoader').innerHTML = `<h2 class="text-xl font-bold text-red-600">Error: ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà FIREBASE_URL</h2>`;
                return;
            }
            await fetchData();
        };

        async function fetchData() {
            try {
                const res = await fetch(API_URL);
                if(res.ok) {
                    const json = await res.json();
                    if(json && json.records) {
                        db = json.records || [];
                        db.sort((a,b) => new Date(a.date) - new Date(b.date));
                        setView('1D');
                    } else { alert('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö'); }
                } else { alert('‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ'); }
            } catch(e) { console.error(e); alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ: ' + e.message); }
            document.getElementById('pageLoader').style.display = 'none';
        }

        // --- View & Render Logic ---
        function setView(mode) {
            ['1D','Yesterday','7D','1M'].forEach(id => {
                const btn = document.getElementById('btn'+id);
                btn.className = (id === mode) 
                    ? "px-5 py-2 text-sm font-semibold rounded-lg transition-all shadow-md bg-indigo-600 text-white transform scale-105" 
                    : "px-5 py-2 text-sm font-semibold rounded-lg text-slate-600 hover:bg-slate-100 transition-all";
            });
            if(db.length === 0) return;
            isRange = false;
            if (mode === '1D') {
                currentData = [db[db.length-1]];
                document.getElementById('badgeMode').innerText = "LATEST UPDATE";
            } else if (mode === 'Yesterday') {
                if(db.length < 2) return alert('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ß‡∏≤‡∏ô');
                currentData = [db[db.length-2]];
                document.getElementById('badgeMode').innerText = "YESTERDAY";
            } else if (mode === '7D') {
                currentData = db.slice(-7);
                isRange = true;
                document.getElementById('badgeMode').innerText = "7 DAYS AVG";
            } else if (mode === '1M') {
                currentData = db.slice(-30);
                isRange = true;
                document.getElementById('badgeMode').innerText = "30 DAYS AVG";
            }
            render();
        }

        function render() {
            const latest = currentData[currentData.length-1];
            if (isRange) {
                document.getElementById('txtDate').innerText = `${currentData[0].date} ‡∏ñ‡∏∂‡∏á ${latest.date} (${currentData.length} ‡∏ß‡∏±‡∏ô)`;
                document.getElementById('badgeWeekend').classList.add('hidden');
            } else {
                document.getElementById('txtDate').innerText = `${latest.date} (${latest.day})`;
                if (latest.isWeekend) document.getElementById('badgeWeekend').classList.remove('hidden'); else document.getElementById('badgeWeekend').classList.add('hidden');
            }

            let sTotal=0, sScan=0, sLeave=0, sMiss=0;
            currentData.forEach(d => { sTotal += d.summary.total; sScan += d.summary.scanned; sLeave += d.summary.leave; sMiss += d.summary.missing; });
            const count = currentData.length;
            const avgTotal = Math.round(sTotal/count), avgScan = Math.round(sScan/count), avgLeave = Math.round(sLeave/count), avgMiss = Math.round(sMiss/count);

            document.getElementById('kpiTotal').innerText = avgTotal;
            document.getElementById('kpiScan').innerText = avgScan;
            document.getElementById('kpiLeave').innerText = avgLeave;
            document.getElementById('kpiMissing').innerText = avgMiss;
            document.getElementById('centerPieTotal').innerText = avgTotal;

            const pct = (v,t) => t>0 ? ((v/t)*100).toFixed(1)+'%' : '0%';
            document.getElementById('pctScan').innerText = pct(avgScan, avgTotal);
            document.getElementById('pctLeave').innerText = pct(avgLeave, avgTotal);
            document.getElementById('pctMissing').innerText = pct(avgMiss, avgTotal);
            
            // Update Progress Bars
            const pb = (id, v, t) => {
                const p = t>0 ? (v/t)*100 : 0;
                document.getElementById(id).style.width = `${p}%`;
            };
            pb('barScan', avgScan, avgTotal);
            pb('barLeave', avgLeave, avgTotal);
            pb('barMissing', avgMiss, avgTotal);

            renderCharts(avgScan, avgLeave, avgMiss, avgTotal);
            renderTables(latest);
        }

        function renderCharts(s, l, m, t) {
            const ctxL = document.getElementById('lineChart'), ctxP = document.getElementById('pieChart');
            if (chartL) chartL.destroy(); if (chartP) chartP.destroy();

            chartP = new Chart(ctxP, { type: 'doughnut', data: { labels: ['Scan', 'Leave', 'Missing'], datasets: [{ data: [s, l, m], backgroundColor: ['#10b981', '#3b82f6', '#f43f5e'], borderWidth: 0, hoverOffset: 4 }] }, options: { responsive: true, maintainAspectRatio: false, cutout: '75%', plugins: { legend: { position: 'bottom', labels: { usePointStyle: true, padding: 20 } } } } });

            let labels=[], dGreen=[], dBlue=[], dRed=[];
            if (isRange) {
                document.getElementById('titleLine').innerText = "üìà ‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô (‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á)";
                labels = currentData.map(d => d.date); dGreen = currentData.map(d => d.summary.scanned); dBlue = currentData.map(d => d.summary.checkedOut || 0); dRed = currentData.map(d => d.summary.lateCount || 0);
            } else {
                document.getElementById('titleLine').innerText = "üìà ‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤-‡∏≠‡∏≠‡∏Å (‡∏£‡∏≤‡∏¢‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á)";
                const h = currentData[0].charts.hourly;
                for(let i=5; i<=20; i++) { labels.push(i+":00"); dGreen.push(h[i].in); dBlue.push(h[i].out); dRed.push(h[i].late); }
            }
            
            // Gradient for Line Chart
            const gradientGreen = ctxL.getContext('2d').createLinearGradient(0, 0, 0, 400);
            gradientGreen.addColorStop(0, 'rgba(16, 185, 129, 0.2)');
            gradientGreen.addColorStop(1, 'rgba(16, 185, 129, 0)');

            chartL = new Chart(ctxL, { type: 'line', data: { labels: labels, datasets: [{ label: '‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô (Green)', data: dGreen, borderColor: '#10b981', backgroundColor: gradientGreen, tension: 0.4, fill: true, pointRadius: 4, pointHoverRadius: 6 }, { label: '‡∏≠‡∏≠‡∏Å‡∏á‡∏≤‡∏ô (Blue)', data: dBlue, borderColor: '#3b82f6', backgroundColor: 'transparent', tension: 0.4, pointRadius: 2 }, { label: '‡∏™‡∏≤‡∏¢ (Red)', data: dRed, borderColor: '#f43f5e', backgroundColor: 'transparent', borderDash: [5,5], tension: 0.4, pointRadius: 2 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'top', align: 'end' } }, scales: { y: { grid: { borderDash: [2, 4], color: '#f1f5f9' }, beginAtZero: true }, x: { grid: { display: false } } } } });
        }

        function renderTables(latest) {
            const tMiss = document.getElementById('tblMissing'), hMiss = document.getElementById('headMissing');
            if (isRange) {
                hMiss.innerHTML = `<tr><th class="p-4 rounded-tl-lg">‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö</th><th class="p-4">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th><th class="p-4">‡πÅ‡∏ú‡∏ô‡∏Å</th><th class="p-4 text-right rounded-tr-lg">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏î</th></tr>`;
                const counter = {}; currentData.forEach(d => { if(!d.isWeekend) d.lists.missing.forEach(m => { if(!counter[m.id]) counter[m.id] = {...m, cnt:0}; counter[m.id].cnt++; }); });
                const list = Object.values(counter).sort((a,b) => b.cnt - a.cnt);
                tMiss.innerHTML = list.map((m,i) => `<tr class="border-b border-slate-50 hover:bg-rose-50/50 transition"><td class="p-4 text-slate-500 font-mono">${String(i+1).padStart(2,'0')}</td><td class="p-4 font-bold text-slate-700">${m.name}</td><td class="p-4 text-xs text-slate-500">${m.dept}</td><td class="p-4 text-right"><span class="bg-rose-100 text-rose-800 font-bold px-3 py-1 rounded-full text-xs">${m.cnt} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</span></td></tr>`).join('');
            } else {
                hMiss.innerHTML = `<tr><th class="p-4 rounded-tl-lg">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th><th class="p-4">‡πÅ‡∏ú‡∏ô‡∏Å</th><th class="p-4 rounded-tr-lg">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th></tr>`;
                if (latest.isWeekend) tMiss.innerHTML = '<tr><td colspan="3" class="p-6 text-center text-emerald-600 font-bold bg-emerald-50/50 rounded-lg">üå¥ ‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î (Weekend)</td></tr>'; else tMiss.innerHTML = latest.lists.missing.map(m => `<tr class="border-b border-slate-50 hover:bg-rose-50/30 transition"><td class="p-4 font-medium text-slate-700">${m.name}</td><td class="p-4 text-xs text-slate-500">${m.dept}</td><td class="p-4"><span class="bg-rose-100 text-rose-700 text-[10px] font-bold px-2 py-1 rounded-full uppercase tracking-wide">No Scan</span></td></tr>`).join('');
            }

            const tDept = document.getElementById('tblDept');
            if (isRange) tDept.innerHTML = '<tr><td class="p-6 text-center text-slate-400">Not available in range view</td></tr>';
            else { const sorted = Object.entries(latest.lists.missingDept).sort((a,b)=>b[1]-a[1]); tDept.innerHTML = sorted.map(([d, c]) => `<tr class="border-b border-slate-50 clickable-row" onclick="openMissingDeptModal('${d}')"><td class="p-4 text-slate-600 flex items-center justify-between group"><span class="font-medium">${d}</span> <span class="text-xs text-indigo-500 bg-indigo-50 px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition">üîé ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠</span></td><td class="p-4 text-right font-bold text-rose-600 text-lg">${c}</td></tr>`).join(''); }

            const tLate = document.getElementById('tblLate'), hLate = document.getElementById('headLate');
            if (isRange) {
                hLate.innerHTML = `<tr><th class="p-4 rounded-tl-lg">‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö</th><th class="p-4">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th><th class="p-4">‡πÅ‡∏ú‡∏ô‡∏Å</th><th class="p-4 text-right">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á</th><th class="p-4 text-right rounded-tr-lg">‡πÄ‡∏ß‡∏•‡∏≤‡∏£‡∏ß‡∏° (‡∏ô‡∏≤‡∏ó‡∏µ)</th></tr>`;
                const counter = {}; currentData.forEach(d => d.lists.late.forEach(l => { if(!counter[l.id]) counter[l.id] = {...l, cnt:0, totalMins:0}; counter[l.id].cnt++; counter[l.id].totalMins += (l.lateMins || 0); }));
                const list = Object.values(counter).filter(x => x.cnt > 3).sort((a,b) => b.cnt - a.cnt);
                tLate.innerHTML = list.length === 0 ? '<tr><td colspan="5" class="p-6 text-center text-emerald-500 font-medium">üëè ‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°‡∏°‡∏≤‡∏Å! ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏π‡πâ‡∏ó‡∏µ‡πà‡∏°‡∏≤‡∏™‡∏≤‡∏¢‡πÄ‡∏Å‡∏¥‡∏ô 3 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏ô‡∏µ‡πâ</td></tr>' : list.map((l,i) => `<tr class="border-b border-slate-50 hover:bg-amber-50/50"><td class="p-4 text-slate-400 font-mono">${i+1}</td><td class="p-4 font-bold text-slate-700">${l.name}</td><td class="p-4 text-xs text-slate-500">${l.dept}</td><td class="p-4 text-right"><span class="bg-amber-100 text-amber-800 px-2 py-1 rounded text-xs font-bold">${l.cnt} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</span></td><td class="p-4 text-right text-rose-600 font-bold">+${l.totalMins}</td></tr>`).join('');
            } else {
                hLate.innerHTML = `<tr><th class="p-4 rounded-tl-lg">‡∏•‡∏≥‡∏î‡∏±‡∏ö</th><th class="p-4">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th><th class="p-4">‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤</th><th class="p-4 text-right rounded-tr-lg">‡∏™‡∏≤‡∏¢ (‡∏ô‡∏≤‡∏ó‡∏µ)</th></tr>`;
                tLate.innerHTML = latest.lists.late.map((l,i) => `<tr class="border-b border-slate-50 hover:bg-amber-50/30"><td class="p-4 text-slate-400 font-mono text-xs">${String(i+1).padStart(2,'0')}</td><td class="p-4 font-medium text-slate-700">${l.name}</td><td class="p-4 font-mono text-amber-600">${l.time}</td><td class="p-4 text-right text-rose-600 font-bold">+${l.lateMins}</td></tr>`).join('');
            }
            
            const tArrive = document.getElementById('tblArriveEarly');
            if(isRange) tArrive.innerHTML = '<tr><td colspan="4" class="p-6 text-center text-slate-400">‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô</td></tr>';
            else { const list = latest.lists.earlyArrival || []; tArrive.innerHTML = list.length===0 ? '<tr><td colspan="4" class="p-6 text-center text-slate-400">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏π‡πâ‡∏°‡∏≤‡πÄ‡∏ä‡πâ‡∏≤‡∏Å‡∏ß‡πà‡∏≤ 08:00</td></tr>' : list.map(e => `<tr class="border-b border-slate-50 hover:bg-emerald-50/30"><td class="p-4 font-medium text-slate-700">${e.name}</td><td class="p-4 text-xs text-slate-500">${e.dept}</td><td class="p-4 font-mono text-emerald-600">${e.time}</td><td class="p-4 text-right text-emerald-600 font-bold">${e.arriveEarlyMins} ‡∏ô‡∏≤‡∏ó‡∏µ</td></tr>`).join(''); }
            
            const tEarlyL = document.getElementById('tblEarlyLeave');
            if(isRange) tEarlyL.innerHTML = '<tr><td colspan="3" class="p-6 text-center text-slate-400">‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô</td></tr>';
            else tEarlyL.innerHTML = latest.lists.earlyLeave.map(e => `<tr class="border-b border-slate-50 hover:bg-blue-50/30"><td class="p-4 font-medium text-slate-700">${e.name}</td><td class="p-4 font-mono text-blue-600">${e.time}</td><td class="p-4 text-right text-blue-600 font-bold">-${e.earlyLeaveMins}</td></tr>`).join('');
        }

        // --- Tab Logic ---
        function tab(t) { 
            ['missing','dept','late','arriveEarly','earlyLeave'].forEach(x => { 
                document.getElementById('content-'+x).classList.add('hidden'); 
                document.getElementById('tab-'+x).className = "tab-btn flex-1 py-3 px-4 text-sm font-bold inactive-tab rounded-lg whitespace-nowrap transition-all"; 
            }); 
            document.getElementById('content-'+t).classList.remove('hidden'); 
            const color = t === 'arriveEarly' ? 'emerald' : (t === 'missing' ? 'rose' : 'indigo'); 
            document.getElementById('tab-'+t).className = `tab-btn flex-1 py-3 px-4 text-sm font-bold active-tab rounded-lg whitespace-nowrap shadow-sm transition-all`; 
        }

        function openModal() { if(db.length) openLeaveModalLogic(); }
        
        function openLeaveModalLogic() { 
            const list = []; 
            currentData.forEach(d => { if(d.lists.leave) d.lists.leave.forEach(l => list.push({...l, date: d.date})); }); 
            document.getElementById('modalTitle').innerText = "‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏•‡∏≤‡∏á‡∏≤‡∏ô"; 
            document.getElementById('modalHeader').innerHTML = `<tr><th class="p-4 rounded-tl-lg">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th><th class="p-4">‡∏ä‡∏∑‡πà‡∏≠</th><th class="p-4 rounded-tr-lg">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th></tr>`; 
            document.getElementById('tblModalContent').innerHTML = list.map(l => { 
                let isHalf = (l.type||'').includes('‡∏Ñ‡∏£‡∏∂‡πà‡∏á') || l.isHalf; 
                let badge = isHalf ? `<span class="ml-2 bg-amber-100 text-amber-800 text-[10px] px-2 py-0.5 rounded-full border border-amber-200">‡∏Ñ‡∏£‡∏∂‡πà‡∏á‡∏ß‡∏±‡∏ô</span>` : ""; 
                let rowClass = isHalf ? "bg-amber-50/50" : "hover:bg-slate-50"; 
                return `<tr class="border-b border-slate-50 ${rowClass}"><td class="p-4 text-xs text-slate-500 font-mono">${l.date}</td><td class="p-4 font-bold text-slate-700">${l.name} ${badge}</td><td class="p-4 text-blue-600 text-xs font-semibold bg-blue-50/50 rounded-lg inline-block my-2 mx-4">${l.type}</td></tr>`; 
            }).join(''); 
            toggleModalDisplay(true); 
        }
        
        function openMissingDeptModal(deptName) { 
            const latest = currentData[currentData.length-1]; 
            if(latest.isWeekend && !isRange) return alert('‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡πÄ‡∏™‡∏≤‡∏£‡πå-‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏ô‡∏Ç‡∏≤‡∏î‡∏á‡∏≤‡∏ô'); 
            
            const list = latest.lists.missing.filter(m => {
                let safeName = (m.dept || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏').replace(/[.#$/[\]]/g, ' - ');
                return safeName === deptName;
            });

            document.getElementById('modalTitle').innerText = `‡∏Ñ‡∏ô‡∏Ç‡∏≤‡∏î‡∏á‡∏≤‡∏ô: ${deptName}`; 
            document.getElementById('modalHeader').innerHTML = `<tr><th class="p-4 rounded-tl-lg">ID</th><th class="p-4 rounded-tr-lg">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th></tr>`; 
            document.getElementById('tblModalContent').innerHTML = list.length === 0 ? '<tr><td colspan="2" class="p-6 text-center text-slate-400">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠</td></tr>' : list.map(m => `<tr class="border-b border-slate-50 hover:bg-rose-50/30"><td class="p-4 text-slate-400 font-mono text-xs">${m.id}</td><td class="p-4 font-bold text-rose-600">${m.name}</td></tr>`).join(''); 
            toggleModalDisplay(true); 
        }

        function closeModal() { toggleModalDisplay(false); }
        function toggleModalDisplay(show) { 
            const m = document.getElementById('modalList'); 
            if(show) { 
                m.classList.remove('opacity-0', 'pointer-events-none'); 
                document.body.classList.add('modal-active'); 
            } else { 
                m.classList.add('opacity-0', 'pointer-events-none'); 
                document.body.classList.remove('modal-active'); 
            } 
        }
    </script>
</body>
</html>
