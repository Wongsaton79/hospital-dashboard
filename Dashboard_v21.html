<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Executive Health Dashboard: Ban Dan Lan Hoi (V.23.5.9 Sheet 8 Updated)</title>
    
    <!-- Libraries -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css" />
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    
    <!-- DataTables (Advanced Table) -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>

    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #0f172a 0%, #334155 100%);
            --accent-color: #2563eb;
            --bg-color: #f8fafc;
            --card-bg: #ffffff;
            --text-main: #334155;
            --footer-bg: #f1f5f9;
        }

        body { 
            font-family: 'Prompt', sans-serif; 
            background-color: var(--bg-color); 
            height: 100vh; 
            overflow: hidden; 
            color: var(--text-main);
        }

        /* Navbar */
        .navbar-custom {
            background: #fff;
            border-bottom: 1px solid #e2e8f0;
            height: 60px;
            z-index: 2000;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
        }

        .full-height { height: calc(100vh - 60px); }

        /* Map Panel */
        #map-container { position: relative; border-right: 1px solid #e2e8f0; box-shadow: 4px 0 24px rgba(0,0,0,0.05); z-index: 10; }
        #map { height: 100%; width: 100%; z-index: 1; }

        /* Control Panel */
        .control-panel-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            border: 1px solid #e2e8f0;
            padding: 16px;
            margin-bottom: 20px;
        }

        /* Dashboard Panel */
        #dashboard-panel {
            background-color: #f8fafc;
            padding: 24px;
            overflow-y: auto; 
        }

        /* Cards */
        .dashboard-card {
            background: var(--card-bg);
            border-radius: 16px;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            border: 1px solid #e2e8f0;
            transition: transform 0.2s, box-shadow 0.2s;
            height: 100%;
        }
        
        /* KPI Header */
        .kpi-header {
            background: var(--primary-gradient);
            color: white;
            border-radius: 16px;
            padding: 24px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 10px 15px -3px rgba(15, 23, 42, 0.3);
            margin-bottom: 24px;
        }

        /* Executive Stat Cards */
        .exec-stat-card {
            background: white; border-radius: 12px; padding: 16px;
            border: 1px solid #e2e8f0; box-shadow: 0 1px 2px rgba(0,0,0,0.05);
            display: flex; flex-direction: column; justify-content: center;
            height: 100%;
            transition: all 0.2s ease-in-out;
            cursor: pointer;
        }
        .exec-stat-card:hover { 
            transform: translateY(-3px); 
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); 
            border-color: var(--accent-color); 
            background-color: #f8fafc;
        }
        .exec-label { font-size: 0.75rem; color: #64748b; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 5px; }
        .exec-value { font-size: 1.5rem; font-weight: 800; color: #0f172a; line-height: 1.1; }
        .exec-sub { font-size: 0.8rem; margin-top: 4px; font-weight: 500; }

        .gap-positive { color: #166534; }
        .gap-negative { color: #dc2626; }

        /* Gauge */
        .gauge-container {
            position: relative; height: 160px;
            display: flex; justify-content: center; align-items: flex-end;
        }
        .gauge-value-text {
            position: absolute; bottom: 0; left: 50%; transform: translateX(-50%);
            text-align: center;
        }

        /* DataTables Customization */
        .table-custom th { 
            background-color: #f1f5f9 !important; 
            font-size: 0.8rem; text-transform: uppercase; color: #475569; font-weight: 700; border-bottom: 2px solid #e2e8f0; 
        }
        .table-custom td { vertical-align: middle; font-size: 0.9rem; border-color: #f1f5f9; }
        
        .table-custom tfoot td {
            background-color: #e2e8f0 !important;
            font-weight: bold;
            color: #0f172a;
            border-top: 2px solid #94a3b8;
        }
        
        .progress-slim { height: 8px; border-radius: 4px; background-color: #e2e8f0; }
        
        div.dataTables_wrapper div.dataTables_filter input {
            border-radius: 20px; padding: 5px 15px; border: 1px solid #cbd5e1;
        }

        /* Map Label */
        .map-label {
            background: rgba(255, 255, 255, 0.95); border: 1px solid #cbd5e1;
            border-radius: 4px; padding: 2px 6px; font-size: 10px; font-weight: 600; color: #334155;
        }
        
        /* Loading */
        #loading-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.95); z-index: 9999; 
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        .spinner-pulse {
            width: 60px; height: 60px; background-color: #0f172a;
            border-radius: 50%; animation: pulse 1.2s infinite ease-in-out;
        }
        @keyframes pulse { 0% { transform: scale(0); } 100% { transform: scale(1); opacity: 0; } }

        /* --- Modern Navbar Styles --- */
            .navbar-modern {
                background: rgba(255, 255, 255, 0.90);
                backdrop-filter: blur(12px);
                border-bottom: 1px solid rgba(226, 232, 240, 0.6);
                height: 70px;
                box-shadow: 0 4px 20px -5px rgba(0, 0, 0, 0.05);
                z-index: 1050;
                transition: all 0.3s ease;
            }

            .brand-icon-box {
                background: linear-gradient(135deg, #0f172a 0%, #334155 100%);
                width: 42px; 
                height: 42px;
                border-radius: 10px;
                box-shadow: 0 4px 10px rgba(15, 23, 42, 0.2);
                display: flex;
                justify-content: center;
                align-items: center;
                color: white;
                font-size: 1.2rem;
            }

            @keyframes pulse-green {
                0% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7); }
                70% { box-shadow: 0 0 0 8px rgba(16, 185, 129, 0); }
                100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); }
            }

            .live-dot {
                width: 8px;
                height: 8px;
                background-color: #10b981;
                border-radius: 50%;
                display: inline-block;
                margin-right: 8px;
                animation: pulse-green 2s infinite;
            }

            .status-badge-modern {
                background: white;
                border: 1px solid #e2e8f0;
                padding: 6px 16px;
                border-radius: 30px;
                display: flex;
                align-items: center;
                box-shadow: 0 2px 5px rgba(0,0,0,0.03);
                font-weight: 600;
                color: #475569;
                font-size: 0.85rem;
            }

        /* --- Special Containers Styles --- */
        .special-container {
            display: none;
            height: 100%;
            width: 100%;
            position: absolute;
            top: 0; left: 0;
            background: white;
            z-index: 20;
            border-radius: 8px;
        }

        .kpi-box {
            background-color: #ecfdf5;
            border: 2px solid #10b981;
            border-radius: 16px;
            padding: 2rem;
            text-align: center;
            color: #064e3b;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .kpi-big-number {
            font-size: 5rem;
            font-weight: 800;
            color: #059669;
            line-height: 1;
            margin-bottom: 1rem;
        }
        
        .kpi-text-label {
            font-size: 1.5rem;
            font-weight: 600;
            color: #047857;
        }

        .text-box {
            background-color: #eff6ff;
            border: 2px solid #3b82f6;
            border-radius: 16px;
            padding: 2rem;
            text-align: center;
            color: #1e3a8a;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .text-content-large {
            font-size: 2.2rem;
            font-weight: 700;
            color: #1d4ed8;
            line-height: 1.4;
        }

    </style>
</head>
<body>

<!-- Loading -->
<div id="loading-screen">
    <div class="spinner-pulse mb-3"></div>
    <h6 class="fw-bold text-dark">กำลังเชื่อมต่อฐานข้อมูล...</h6>
</div>

<!-- Navbar -->
<nav class="navbar navbar-modern px-4 d-flex justify-content-between align-items-center">
    <div class="d-flex align-items-center gap-3">
        <div class="brand-icon-box">
            <i class="bi bi-bar-chart-fill"></i>
        </div>
        <div class="d-flex flex-column">
            <h6 class="m-0 fw-bold text-dark" style="letter-spacing: -0.3px; font-size: 1rem;">
                Executive Health Dashboard
            </h6>
            <div class="d-flex align-items-center gap-2">
                <small class="text-muted" style="font-size: 0.75rem; font-weight: 500;">
                    ระบบสนับสนุนการตัดสินใจผู้บริหาร
                </small>
                <span class="badge bg-secondary-subtle text-secondary border border-secondary-subtle rounded-pill" 
                      style="font-size: 0.6rem; padding: 2px 6px;">
                    V.23.5.9
                </span>
            </div>
        </div>
    </div>

    <div class="d-flex align-items-center">
        <div class="status-badge-modern">
            <span class="live-dot"></span>
            <span>Live Data Connection</span>
        </div>
    </div>
</nav>

<div class="container-fluid p-0">
    <div class="row g-0 full-height">
        
        <!-- Map Panel -->
        <div class="col-md-4 col-lg-3" id="map-container">
            <div id="map"></div>
        </div>

        <!-- Dashboard Panel -->
        <div class="col-md-8 col-lg-9" id="dashboard-panel">
            
            <!-- 0. Control Panel -->
            <div class="control-panel-card d-flex flex-wrap align-items-center gap-3">
                <div class="d-flex align-items-center text-primary">
                    <i class="bi bi-funnel-fill me-2 fs-5"></i>
                    <span class="fw-bold text-uppercase small">ตัวกรองข้อมูล</span>
                </div>
                <div class="flex-grow-1">
                    <select id="mainSelect" class="form-select border-secondary-subtle shadow-sm">
                        <option value="PPP1" selected>PP&P1 (5 ตัวชี้วัด)</option>
                        <option value="PPP2">PP&P2 (1 ตัวชี้วัด)</option>
                        <option value="PPP3">PP&P3 (3 ตัวชี้วัด)</option>
                        <option value="PPP4">PP&P4 (1 ตัวชี้วัด)</option>
                        <option value="Service1">Service 1 (3 ตัวชี้วัด)</option>
                        <option value="Service2">Service 2 (5 ตัวชี้วัด)</option>
                        <option value="Service3">Service 3 (2 ตัวชี้วัด)</option>
                        <option value="Service4">Service 4 (1 ตัวชี้วัด)</option>
                        <option value="Service5">Service 5 (2 ตัวชี้วัด)</option>
                        <option value="PeopleExcellence">People Excellence (1 ตัวชี้วัด)</option>
                        <option value="GovernanceExcellence">Governance Excellence (3 ตัวชี้วัด)</option>
                        <option value="HealthEconomy">Health-Related Economy Excellence (3 ตัวชี้วัด)</option>
                    </select>
                </div>
                <div class="flex-grow-1" style="min-width: 250px;">
                    <select id="subSelect" class="form-select border-secondary-subtle shadow-sm">
                        <option value="">กำลังโหลด...</option>
                    </select>
                </div>
            </div>

            <!-- 1. Header & Controls -->
            <div class="d-flex flex-wrap justify-content-between align-items-end mb-4">
                <div>
                    <h4 class="fw-bold text-dark m-0 d-flex align-items-center gap-2">
                        <span id="unit-name">ภาพรวมอำเภอ</span>
                        <span class="badge bg-dark rounded-pill fs-6 fw-normal" id="unit-id" style="font-size: 0.7rem !important;">TOTAL</span>
                    </h4>
                    <div id="route-info" class="text-primary small mt-1 d-none fw-bold">
                        <i class="bi bi-geo-alt-fill"></i> ระยะทาง <span id="route-dist">-</span> กม.
                    </div>
                </div>
                
                <div class="bg-white p-1 rounded-pill border shadow-sm d-flex mt-2 mt-md-0">
                    <input type="radio" class="btn-check" name="goalPeriod" id="goal6m" value="6m" checked>
                    <label class="btn btn-sm btn-light rounded-pill px-3 border-0 text-secondary fw-bold" for="goal6m" id="lbl-6m">6 เดือน</label>

                    <input type="radio" class="btn-check" name="goalPeriod" id="goal10m" value="10m">
                    <label class="btn btn-sm btn-light rounded-pill px-3 border-0 text-secondary fw-bold" for="goal10m" id="lbl-10m">10 เดือน</label>
                </div>
            </div>

            <!-- 2. Executive Stat Cards -->
            <div class="row g-3 mb-4">
                <div class="col-6 col-md-3">
                    <div class="exec-stat-card border-start border-4 border-primary" onclick="resetTableFilter()" title="คลิกเพื่อแสดงทั้งหมด">
                        <div class="exec-label">ผลต่างจากเป้าหมาย</div>
                        <div class="d-flex align-items-baseline gap-2">
                            <div class="exec-value" id="stat-gap">- %</div>
                            <i id="gap-arrow" class="bi"></i>
                        </div>
                        <div class="exec-sub text-muted" id="stat-gap-desc">รอการประมวลผล</div>
                    </div>
                </div>
                
                <div class="col-6 col-md-3">
                    <div class="exec-stat-card border-start border-4 border-success" onclick="filterTable('pass')" title="คลิกเพื่อดูเฉพาะที่ผ่านเกณฑ์">
                        <div class="exec-label">ผ่านเกณฑ์แล้ว <i class="bi bi-funnel float-end text-success small"></i></div>
                        <div class="exec-value text-success" id="stat-pass">- แห่ง</div>
                        <div class="exec-sub text-muted" id="stat-pass-sub">จากทั้งหมด - แห่ง</div>
                    </div>
                </div>
                
                <div class="col-6 col-md-3">
                    <div class="exec-stat-card" onclick="resetTableFilter()">
                        <div class="exec-label text-warning">ผลงานสูงสุด</div>
                        <div class="exec-value" id="stat-max">- %</div>
                        <div class="exec-sub text-truncate text-muted" id="stat-max-name">-</div>
                    </div>
                </div>
                
                <div class="col-6 col-md-3">
                    <div class="exec-stat-card" onclick="filterTable('fail')" title="คลิกเพื่อดูเฉพาะที่ไม่ผ่าน">
                        <div class="exec-label text-danger">ผลงานต่ำสุด <i class="bi bi-funnel float-end text-danger small"></i></div>
                        <div class="exec-value" id="stat-min">- %</div>
                        <div class="exec-sub text-truncate text-muted" id="stat-min-name">-</div>
                    </div>
                </div>
            </div>

            <!-- 3. KPI Banner -->
            <div class="kpi-header">
                <div class="row align-items-center position-relative" style="z-index: 2;">
                    <div class="col-md-9">
                        <div class="text-white-50 text-uppercase fw-bold small mb-1">ตัวชี้วัด (KPI)</div>
                        <h4 class="fw-bold m-0 text-white lh-base" id="current-kpi-text">-</h4>
                    </div>
                    <div class="col-md-3 text-end border-start border-white border-opacity-10 ps-4">
                        <small class="text-white-50 d-block">เกณฑ์เป้าหมาย</small>
                        <div class="display-6 fw-bold text-white" id="target-value">- %</div>
                    </div>
                </div>
            </div>

            <!-- 4. Charts Section -->
            <div class="row g-4 mb-4">
                <!-- Gauge -->
                <div class="col-lg-4" id="gauge-card-col">
                    <div class="dashboard-card p-4 text-center d-flex flex-column h-100">
                        <h6 class="fw-bold text-secondary mb-3 text-start"><i class="bi bi-speedometer2 me-2"></i>เกจวัดผลงาน</h6>
                        <div class="gauge-container flex-grow-1">
                            <canvas id="gaugeChart"></canvas>
                            <div class="gauge-value-text">
                                <div class="display-4 fw-bold text-dark lh-1" id="unit-value">0</div>
                                <small class="text-muted">%</small>
                            </div>
                        </div>
                        <div id="pass-status" class="mt-3 badge bg-light text-muted border rounded-pill px-3 py-2 fw-normal fs-6">
                            -
                        </div>
                    </div>
                </div>

                <!-- Bar Chart / Special Card -->
                <div class="col-lg-8" id="chart-card-col">
                    <div class="dashboard-card p-4 h-100">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6 class="fw-bold text-secondary m-0" id="chart-title">
                                <i class="bi bi-bar-chart-line-fill me-2"></i>กราฟเปรียบเทียบ
                            </h6>
                            <small class="text-muted" id="chart-subtitle"><i class="bi bi-sort-down me-1"></i> เรียงจากมากไปน้อย</small>
                        </div>
                        <div style="height: 300px; position: relative;">
                            <!-- Canvas Graph -->
                            <canvas id="comparisonChart"></canvas>
                            
                            <!-- No Data Overlay -->
                            <div id="no-data-overlay" class="position-absolute top-50 start-50 translate-middle text-center d-none" style="width: 100%;">
                                <i class="bi bi-inbox text-muted fs-1 opacity-25"></i>
                                <div class="text-muted small mt-2">ไม่มีข้อมูล</div>
                            </div>

                            <!-- KPI Card Container -->
                            <div id="special-kpi-container" class="special-container">
                                <div class="kpi-box">
                                    <div class="kpi-big-number" id="special-kpi-val">0</div>
                                    <div class="kpi-text-label" id="special-kpi-desc">อัตราการตาย</div>
                                    <div class="mt-3">
                                        <span class="badge bg-success rounded-pill px-3 py-2 fs-6">
                                            <i class="bi bi-check-circle-fill me-1"></i> Success
                                        </span>
                                    </div>
                                </div>
                            </div>

                            <!-- Text Card Container -->
                            <div id="special-text-container" class="special-container">
                                <div class="text-box">
                                    <div class="text-content-large" id="special-text-val">
                                        เขตสุขภาพที่ 2
                                    </div>
                                    <div class="mt-3 text-muted small">ข้อมูลพื้นที่สุขภาพ</div>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>
            </div>

            <!-- 5. Smart Data Table -->
            <div class="dashboard-card p-4" id="table-container-card">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h6 class="fw-bold text-secondary m-0"><i class="bi bi-table me-2"></i>ตารางรายละเอียด (Smart Table)</h6>
                    <button class="btn btn-sm btn-outline-danger" onclick="resetTableFilter()" id="btn-reset-filter" style="display:none;">
                        <i class="bi bi-x-circle-fill"></i> ยกเลิกการกรอง (แสดงทั้งหมด)
                    </button>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover table-custom w-100" id="detail-table">
                        <thead id="table-header">
                            <tr>
                                <th style="width: 5%">#</th>
                                <th style="width: 25%">หน่วยบริการ / รายการ</th>
                                <th style="width: 15%" class="text-center bg-light text-primary border-start">เป้าหมาย</th>
                                <th style="width: 15%" class="text-center bg-light text-success border-end">ผลงาน</th>
                                <th style="width: 10%" class="text-center">ร้อยละ (%)</th>
                                <th style="width: 20%">Progress Bar</th>
                                <th style="width: 10%" class="text-center">สถานะ</th>
                            </tr>
                        </thead>
                        <tbody id="table-body"></tbody>
                        <tfoot id="table-foot"></tfoot>
                    </table>
                </div>
            </div>

        </div>
    </div>
</div>

<!-- Scripts -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-annotation/2.1.0/chartjs-plugin-annotation.min.js"></script>

<script>
    // ** ใส่ URL ของ Web App ใหม่ที่คุณ Deploy ได้ที่นี่ **
    const API_URL = "https://script.google.com/macros/s/AKfycbw8zV2FZYRYTq1eUrXOi1shSdO0u3P_klt4cUQoBRrpGiplOPdtQ_04xWfLJFi0YwO-/exec"; 
    
    const MAIN_HOSPITAL_ID = "11244";

    let mapData = [], goalsConfig = {}, indicatorsList = {}, allChartData = {};
    let selectedUnitId = 'total', selectedKpiKey = null, currentPeriod = '6m'; 
    let barChart = null, gaugeChart = null, dataTable = null;
    let routingControl = null, map = null, mainLatLng = null;

    document.addEventListener('DOMContentLoaded', async () => {
        initMap();
        await fetchData();
    });

    function initMap() {
        map = L.map('map', { zoomControl: false }).setView([17.05, 99.55], 11);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '', maxZoom: 19 }).addTo(map);
        L.control.zoom({ position: 'bottomright' }).addTo(map);
    }

    async function fetchData() {
        try {
            const response = await fetch(API_URL);
            const data = await response.json();
            
            mapData = data.mapData;
            goalsConfig = data.goalsConfig;
            indicatorsList = data.indicatorsList;
            allChartData = data.chartData;

            setupMapMarkers();
            setupDropdowns();
            
            selectedUnitId = 'total';
            updateDashboard();

            const loader = document.getElementById('loading-screen');
            loader.style.opacity = '0';
            setTimeout(() => loader.remove(), 500);
        } catch (error) {
            console.error(error);
            document.querySelector('#loading-screen h6').innerHTML = "<span class='text-danger'>เชื่อมต่อไม่สำเร็จ กรุณาตรวจสอบ URL API</span>";
        }
    }

    function setupMapMarkers() {
        const createIcon = (color) => new L.Icon({
            iconUrl: `https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-${color}.png`,
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
            iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41]
        });

        const mainHospital = mapData.find(d => d.id === MAIN_HOSPITAL_ID);
        if (mainHospital) mainLatLng = L.latLng(mainHospital.lat, mainHospital.lng);

        mapData.forEach(unit => {
            const isMain = (unit.id === MAIN_HOSPITAL_ID);
            L.marker([unit.lat, unit.lng], { icon: createIcon(isMain ? 'red' : 'blue'), zIndexOffset: isMain?1000:0 })
             .addTo(map)
             .bindTooltip(unit.name, { permanent: true, direction: 'bottom', className: 'map-label', offset: [0, 5] })
             .on('click', () => selectUnit(unit));
        });
    }

    function setupDropdowns() {
        const mainSelect = document.getElementById('mainSelect');
        const subSelect = document.getElementById('subSelect');

        mainSelect.addEventListener('change', () => {
            const cat = mainSelect.value;
            subSelect.innerHTML = '';
            if (indicatorsList[cat]) {
                indicatorsList[cat].forEach(ind => {
                    const opt = document.createElement('option');
                    opt.value = ind;
                    opt.textContent = ind;
                    subSelect.appendChild(opt);
                });
            }
            subSelect.dispatchEvent(new Event('change'));
        });

        subSelect.addEventListener('change', (e) => {
            const val = e.target.value;
            const match = val.match(/^(\d+(\.\d+)?)/);
            selectedKpiKey = match ? match[1] : null;
            if (selectedKpiKey && goalsConfig[selectedKpiKey]) {
                const config = goalsConfig[selectedKpiKey];
                currentPeriod = (config.goal_6m === null) ? '10m' : '6m';
            }
            updateDashboard();
        });

        mainSelect.dispatchEvent(new Event('change'));

        document.querySelectorAll('input[name="goalPeriod"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                currentPeriod = e.target.value;
                updateDashboard();
            });
        });
    }

    function selectUnit(unit) {
        selectedUnitId = unit.id;
        document.getElementById('unit-name').textContent = unit.name; // Full Name
        document.getElementById('unit-id').textContent = unit.id;

        if (routingControl) { map.removeControl(routingControl); routingControl = null; }
        const routeInfo = document.getElementById('route-info');
        routeInfo.classList.add('d-none');

        if (unit.id !== MAIN_HOSPITAL_ID && mainLatLng && unit.id !== 'total') {
            routingControl = L.Routing.control({
                waypoints: [mainLatLng, L.latLng(unit.lat, unit.lng)],
                lineOptions: { styles: [{color: '#2563eb', opacity: 0.6, weight: 5}] },
                createMarker: () => null, show: false, addWaypoints: false, draggableWaypoints: false,
                fitSelectedRoutes: true
            }).addTo(map);

            routingControl.on('routesfound', function(e) {
                const distKm = (e.routes[0].summary.totalDistance / 1000).toFixed(1);
                document.getElementById('route-dist').textContent = distKm;
                routeInfo.classList.remove('d-none');
            });
        } else if (unit.id !== 'total') {
            map.flyTo([unit.lat, unit.lng], 13);
        }

        updateDashboard();
    }

    function updateDashboard() {
        try {
            resetTableFilter();

            const kpiName = document.getElementById('subSelect').value;
            document.getElementById('current-kpi-text').textContent = kpiName || "-";

            if (!selectedKpiKey || !goalsConfig[selectedKpiKey] || !allChartData[selectedKpiKey]) {
                resetCharts();
                updateExecutiveStats([], null);
                updateSmartTable([], null);
                return;
            }

            const goalInfo = goalsConfig[selectedKpiKey];
            const dataSet = allChartData[selectedKpiKey];
            const firstItem = dataSet[0];

            // ตรวจสอบ Type
            const isSpecialKPI = (firstItem && firstItem.type === 'kpi');
            const isSpecialText = (firstItem && firstItem.type === 'text');
            const isComparison = (firstItem && firstItem.type === 'year_comparison');
            const isAttributeList = (firstItem && firstItem.type === 'attribute_list'); 
            const isAccidentStats = (firstItem && firstItem.type === 'accident_stats'); // NEW Sheet 8

            // Reset Visibility
            const canvasChart = document.getElementById('comparisonChart');
            const kpiContainer = document.getElementById('special-kpi-container');
            const textContainer = document.getElementById('special-text-container');
            const gaugeCard = document.getElementById('gauge-card-col');
            const tableCard = document.getElementById('table-container-card');
            const chartSubtitle = document.getElementById('chart-subtitle');

            kpiContainer.style.display = 'none';
            textContainer.style.display = 'none';
            canvasChart.style.display = 'block';
            gaugeCard.style.display = 'block';
            tableCard.style.display = 'block';
            chartSubtitle.style.display = 'block';

            // *** Handling Goals Display ***
            let goalVal = (currentPeriod === '6m') ? goalInfo.goal_6m : goalInfo.goal_10m;
            let goalText = (currentPeriod === '6m') ? goalInfo.goal_6m_text : goalInfo.goal_10m_text;
            
            if ((!goalText || goalText === "-") && goalVal !== null) {
                goalText = goalVal + "%";
            }
            document.getElementById('target-value').textContent = goalText;


            if (isSpecialKPI) {
                // --- MODE 1: KPI CARD ---
                canvasChart.style.display = 'none'; gaugeCard.style.display = 'none';
                tableCard.style.display = 'none'; chartSubtitle.style.display = 'none';
                kpiContainer.style.display = 'block';

                document.getElementById('special-kpi-val').textContent = firstItem.value;
                const parts = firstItem.text.split('=');
                document.getElementById('special-kpi-desc').textContent = parts[0] || "KPI";
                document.getElementById('chart-title').innerHTML = '<i class="bi bi-star-fill me-2"></i>ตัวชี้วัดความสำเร็จ';
                updateExecutiveStats([], null);

            } else if (isSpecialText) {
                // --- MODE 2: TEXT CARD (รวมถึง Sheet 25, 26) ---
                canvasChart.style.display = 'none'; gaugeCard.style.display = 'none';
                tableCard.style.display = 'none'; chartSubtitle.style.display = 'none';
                textContainer.style.display = 'block';
                
                document.getElementById('special-text-val').textContent = firstItem.text;
                document.getElementById('chart-title').innerHTML = '<i class="bi bi-info-circle-fill me-2"></i>ข้อมูลทั่วไป';
                updateExecutiveStats([], null);

            } else if (isComparison) {
                // --- MODE 3: YEAR COMPARISON (Sheet 3) ---
                gaugeCard.style.display = 'none';
                chartSubtitle.style.display = 'none';
                
                document.getElementById('chart-title').innerHTML = '<i class="bi bi-graph-up me-2"></i>กราฟเปรียบเทียบ HDC vs Hosxp (รายปี)';
                document.getElementById('target-value').textContent = "รายปี";

                renderYearComparisonChart(dataSet);
                updateComparisonTable(dataSet);
                updateExecutiveStats([], null); 

            } else if (isAttributeList) {
                // --- MODE 4: ATTRIBUTE LIST (Sheet 10) ---
                canvasChart.style.display = 'none'; gaugeCard.style.display = 'none';
                chartSubtitle.style.display = 'none';
                textContainer.style.display = 'block'; 

                // บังคับดึงข้อมูลของ 11244 Column C มาแสดง
                let mainUnitData = dataSet.find(d => d.id === '11244');
                let displayText = mainUnitData ? mainUnitData.attr1 : "ไม่พบข้อมูล รพ.บ้านด่านฯ";
                
                document.getElementById('special-text-val').textContent = displayText;
                document.getElementById('chart-title').innerHTML = '<i class="bi bi-card-checklist me-2"></i>ผลการประเมิน (รพ.บ้านด่านลานหอย)';
                
                updateAttributeTable(dataSet);
                updateExecutiveStats([], null); 

            } else if (isAccidentStats) {
                // --- NEW MODE 6: ACCIDENT STATS (Sheet 8) ---
                gaugeCard.style.display = 'none'; // ซ่อน Gauge
                chartSubtitle.style.display = 'none';
                
                document.getElementById('chart-title').innerHTML = '<i class="bi bi-cone-striped me-2"></i>สถิติอุบัติเหตุในเด็กและเยาวชน (1-18 ปี)';
                document.getElementById('target-value').textContent = "รายปี";

                // Render Chart: Injured vs Died
                renderAccidentChart(dataSet);
                
                // Update Table
                updateAccidentTable(dataSet);
                
                // Update Stats (Max Died/Injured)
                updateExecutiveStats(dataSet, null); 

            } else {
                // --- MODE 5: NORMAL ---
                let unitData = dataSet.find(d => d.id === selectedUnitId);
                if (!unitData && selectedUnitId === 'total') {
                     unitData = { id: 'total', name: 'ภาพรวมอำเภอ', value: 0 }; 
                     const validItems = dataSet.filter(d => d.id !== 'total');
                     if(validItems.length > 0) {
                         const avg = validItems.reduce((a,b)=>a+b.value,0) / validItems.length;
                         unitData.value = parseFloat(avg.toFixed(2));
                     }
                } else if (!unitData) unitData = { value: 0 };

                let title = goalInfo.custom_title || "กราฟเปรียบเทียบผลงาน";
                if (selectedKpiKey === "3") title += " (ปีงบ 68)";
                document.getElementById('chart-title').innerHTML = `<i class="bi bi-bar-chart-line-fill me-2"></i>${title}`;

                // Toggle Buttons Logic
                const lbl6m = document.getElementById('lbl-6m');
                const btn10m = document.getElementById('goal10m');
                
                if (goalInfo.goal_6m === null) {
                    lbl6m.classList.add('d-none');
                    if (currentPeriod === '6m') currentPeriod = '10m';
                    btn10m.checked = true;
                } else lbl6m.classList.remove('d-none');

                let showData = (dataSet.length > 0);
                if (currentPeriod === '6m' && goalInfo.goal_6m === null) showData = false;
                
                const val = showData ? unitData.value : 0;
                animateValue("unit-value", 0, val, 600);
                
                // Status Badge logic
                const passStatus = document.getElementById('pass-status');
                if(goalVal) {
                     if(val >= goalVal) {
                         passStatus.className = "mt-3 badge bg-success-subtle text-success border border-success-subtle rounded-pill px-3 py-2 fw-normal fs-6";
                         passStatus.innerHTML = '<i class="bi bi-check-circle-fill me-1"></i> ผ่านเกณฑ์เป้าหมาย';
                     } else {
                         passStatus.className = "mt-3 badge bg-danger-subtle text-danger border border-danger-subtle rounded-pill px-3 py-2 fw-normal fs-6";
                         passStatus.innerHTML = '<i class="bi bi-exclamation-circle-fill me-1"></i> ต่ำกว่าเกณฑ์';
                     }
                } else {
                     passStatus.className = "mt-3 badge bg-light text-muted border rounded-pill px-3 py-2 fw-normal fs-6";
                     passStatus.innerHTML = "ไม่มีเกณฑ์เป้าหมาย";
                }

                updateExecutiveStats(dataSet, goalVal);
                updateSmartTable(dataSet, goalVal);
                renderGauge(val, goalVal);
                renderBarChart(dataSet, goalVal, showData);
            }

        } catch (e) {
            console.error("Dashboard Error:", e);
        }
    }

    // --- New Chart Function for Sheet 8 (Accidents) ---
    function renderAccidentChart(data) {
        const ctx = document.getElementById('comparisonChart').getContext('2d');
        const overlay = document.getElementById('no-data-overlay');
        
        if (barChart) { barChart.destroy(); barChart = null; }
        overlay.classList.add('d-none');
        
        // Filter out Total if needed, or sort
        const chartData = data.filter(d => d.id !== 'total').sort((a,b) => b.injured - a.injured);
        
        const labels = chartData.map(d => d.initial || d.name);
        const injuredVals = chartData.map(d => d.injured);
        const diedVals = chartData.map(d => d.died);

        barChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [
                    { 
                        label: 'บาดเจ็บ (คน)', 
                        data: injuredVals, 
                        backgroundColor: '#f59e0b', // Orange
                        borderRadius: 4,
                        stack: 'Stack 0'
                    },
                    { 
                        label: 'เสียชีวิต (คน)', 
                        data: diedVals, 
                        backgroundColor: '#dc2626', // Red
                        borderRadius: 4,
                        stack: 'Stack 1' // Separate stack to compare side-by-side or 'Stack 0' for stacked
                    }
                ]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                scales: { 
                    y: { beginAtZero: true, title: {display: true, text: 'จำนวน (คน)'} }, 
                    x: { grid: { display: false }, ticks: { font: {family: 'Prompt', size: 10} } } 
                },
                plugins: {
                    legend: { display: true, position: 'top' },
                    tooltip: { mode: 'index', intersect: false },
                    datalabels: { 
                        anchor: 'end', align: 'top', 
                        formatter: (val) => val > 0 ? val : '', 
                        font: { family: 'Prompt', weight: 'bold' }, color: '#4b5563' 
                    }
                }
            },
            plugins: [ChartDataLabels]
        });
    }

    // --- New Table Function for Sheet 8 (Accidents) ---
    function updateAccidentTable(data) {
        if (dataTable) { dataTable.destroy(); dataTable = null; }
        const tbody = document.getElementById('table-body');
        const tfoot = document.getElementById('table-foot');
        
        // Custom Headers
        const thead = document.getElementById('table-header').rows[0];
        thead.innerHTML = '<th style="width: 5%">#</th><th style="width: 30%">หน่วยบริการ</th><th style="width: 15%" class="text-center">ประชากรกลุ่มเป้าหมาย</th><th style="width: 15%" class="text-center text-warning">บาดเจ็บ (คน)</th><th style="width: 15%" class="text-center text-danger">เสียชีวิต (คน)</th><th style="width: 20%" class="text-center">อัตราตาย (%)</th>';

        tbody.innerHTML = ''; tfoot.innerHTML = '';

        const unitRows = data.filter(d => d.id !== 'total');
        const totalRow = data.find(d => d.id === 'total');

        unitRows.forEach((item, index) => {
             const tr = document.createElement('tr');
             if(item.id === selectedUnitId) tr.classList.add('table-primary');
             
             // Badge for High Death Rate
             let rateBadge = item.value > 0 ? `<span class="badge bg-danger">${item.value}%</span>` : `<span class="text-muted">-</span>`;

             tr.innerHTML = `
                <td class="text-center">${index + 1}</td>
                <td>${item.name}</td>
                <td class="text-center">${item.target.toLocaleString()}</td>
                <td class="text-center fw-bold text-warning">${item.injured}</td>
                <td class="text-center fw-bold text-danger">${item.died}</td>
                <td class="text-center">${rateBadge}</td>
             `;
             tr.style.cursor = 'pointer';
             tr.onclick = () => { 
                const unitObj = mapData.find(u => u.id === item.id);
                if(unitObj) selectUnit(unitObj);
             };
             tbody.appendChild(tr);
        });
        
        if(totalRow) {
             const tr = document.createElement('tr');
             tr.innerHTML = `
                <td class="text-center">-</td>
                <td><strong>ภาพรวมอำเภอ</strong></td>
                <td class="text-center"><strong>${totalRow.target.toLocaleString()}</strong></td>
                <td class="text-center text-warning"><strong>${totalRow.injured}</strong></td>
                <td class="text-center text-danger"><strong>${totalRow.died}</strong></td>
                <td class="text-center"><strong>${totalRow.value}%</strong></td>
             `;
             tfoot.appendChild(tr);
        }
    }

    // --- New Chart Function for Sheet 3 ---
    function renderYearComparisonChart(data) {
        const ctx = document.getElementById('comparisonChart').getContext('2d');
        const overlay = document.getElementById('no-data-overlay');
        
        if (barChart) { barChart.destroy(); barChart = null; }
        overlay.classList.add('d-none');

        const labels = data.map(d => "ปี " + d.year);
        const hdcValues = data.map(d => d.hdc);
        const hosxpValues = data.map(d => d.hosxp);

        barChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [
                    { label: 'HDC/จังหวัด(%)', data: hdcValues, backgroundColor: '#3b82f6', borderRadius: 4 },
                    { label: 'Hosxp/อำเภอ(%)', data: hosxpValues, backgroundColor: '#ef4444', borderRadius: 4 }
                ]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                scales: { y: { beginAtZero: true, max: 100 }, x: { grid: { display: false } } },
                plugins: {
                    legend: { display: true, position: 'top' },
                    datalabels: { anchor: 'end', align: 'top', formatter: (val) => val + '%', font: { family: 'Prompt', weight: 'bold' }, color: '#4b5563' }
                }
            },
            plugins: [ChartDataLabels]
        });
    }
    
    // --- New Table Function for Sheet 3 ---
    function updateComparisonTable(data) {
        if (dataTable) { dataTable.destroy(); dataTable = null; }
        const tbody = document.getElementById('table-body');
        const tfoot = document.getElementById('table-foot');
        
        // Reset Headers
        const thead = document.getElementById('table-header').rows[0];
        thead.innerHTML = '<th style="width: 5%">#</th><th style="width: 25%">ปีงบประมาณ</th><th style="width: 25%">HDC/จังหวัด</th><th style="width: 25%">Hosxp/อำเภอ</th><th style="width: 20%">Progress Bar</th>';
        
        tbody.innerHTML = ''; tfoot.innerHTML = '';

        data.forEach((item, index) => {
             const tr = document.createElement('tr');
             tr.innerHTML = `
                <td class="text-center">${index + 1}</td>
                <td>ปีงบประมาณ ${item.year}</td>
                <td class="text-center text-primary fw-bold">${item.hdc}%</td>
                <td class="text-center text-danger fw-bold">${item.hosxp}%</td>
                <td>
                    <div class="progress progress-slim mb-1" title="HDC"><div class="progress-bar bg-primary" style="width: ${item.hdc}%"></div></div>
                    <div class="progress progress-slim" title="Hosxp"><div class="progress-bar bg-danger" style="width: ${item.hosxp}%"></div></div>
                </td>
             `;
             tbody.appendChild(tr);
        });
    }
    
    // --- New Table Function for Sheet 10 (Attributes) ---
    function updateAttributeTable(data) {
        if (dataTable) { dataTable.destroy(); dataTable = null; }
        const tbody = document.getElementById('table-body');
        const tfoot = document.getElementById('table-foot');
        
        // Custom Headers
        const thead = document.getElementById('table-header').rows[0];
        thead.innerHTML = '<th style="width: 5%">#</th><th style="width: 25%">หน่วยบริการ</th><th style="width: 20%">สรุปผลการประเมิน</th><th style="width: 20%">ระยะเวลาการรับรอง</th><th style="width: 30%">การประเมินรับรอง</th>';

        tbody.innerHTML = ''; tfoot.innerHTML = '';

        const unitRows = data.filter(d => d.id !== 'total');
        const totalRow = data.find(d => d.id === 'total');

        unitRows.forEach((item, index) => {
             const tr = document.createElement('tr');
             if(item.id === selectedUnitId) tr.classList.add('table-primary');
             
             let badgeColor = "bg-secondary";
             if(item.attr1.includes("ดี")) badgeColor = "bg-success";
             else if(item.attr1.includes("มาตรฐาน")) badgeColor = "bg-primary";
             else if(item.attr1.includes("ท้าทาย")) badgeColor = "bg-warning text-dark";

             tr.innerHTML = `
                <td class="text-center">${index + 1}</td>
                <td>${item.name}</td>
                <td><span class="badge ${badgeColor}">${item.attr1}</span></td>
                <td>${item.attr2}</td>
                <td><small>${item.attr3}</small></td>
             `;
             tr.style.cursor = 'pointer';
             tr.onclick = () => { selectUnit(mapData.find(u => u.id === item.id)); };
             tbody.appendChild(tr);
        });
        
        if(totalRow) {
             const tr = document.createElement('tr');
             tr.innerHTML = `<td class="text-center">-</td><td><strong>ภาพรวม</strong></td><td><strong>${totalRow.attr1}</strong></td><td colspan="2"></td>`;
             tfoot.appendChild(tr);
        }
    }

    function updateExecutiveStats(data, target) {
        if (!data || data.length === 0) {
            ['stat-gap', 'stat-pass', 'stat-max', 'stat-min'].forEach(id => document.getElementById(id).textContent = "-");
            return;
        }
        
        const cleanData = data.filter(d => d.id !== 'total');
        if (cleanData.length === 0) return;

        let districtVal = 0;
        const totalRow = data.find(d => d.id === 'total');
        if(totalRow) districtVal = totalRow.value;
        else districtVal = (cleanData.reduce((acc, curr) => acc + curr.value, 0) / cleanData.length);

        const gapDiv = document.getElementById('stat-gap');
        const gapArrow = document.getElementById('gap-arrow');
        const gapDesc = document.getElementById('stat-gap-desc');

        if(target) {
            const gap = districtVal - target;
            const sign = gap > 0 ? "+" : "";
            gapDiv.textContent = `${sign}${gap.toFixed(2)}%`;
            
            if(gap >= 0) {
                gapDiv.className = "exec-value gap-positive";
                gapArrow.className = "bi bi-arrow-up-circle-fill text-success fs-3";
                gapDesc.textContent = "สูงกว่าเป้าหมาย";
            } else {
                gapDiv.className = "exec-value gap-negative";
                gapArrow.className = "bi bi-arrow-down-circle-fill text-danger fs-3";
                gapDesc.textContent = "ต่ำกว่าเป้าหมาย";
            }
        } else {
            gapDiv.textContent = "N/A";
            gapDiv.className = "exec-value text-muted";
            gapArrow.className = "bi bi-dash-circle";
            gapDesc.textContent = "ไม่มีค่าเป้าหมาย";
        }

        const sortedVals = [...cleanData].sort((a,b) => b.value - a.value);
        if(sortedVals[0] && sortedVals[0].value !== undefined) {
            document.getElementById('stat-max').textContent = sortedVals[0].value + "%";
            document.getElementById('stat-max-name').textContent = sortedVals[0].name;
            document.getElementById('stat-min').textContent = sortedVals[sortedVals.length-1].value + "%";
            document.getElementById('stat-min-name').textContent = sortedVals[sortedVals.length-1].name;
        }

        let passCount = target ? cleanData.filter(d => d.value >= target).length : "-";
        document.getElementById('stat-pass').textContent = passCount + " แห่ง";
        document.getElementById('stat-pass-sub').textContent = "จากทั้งหมด " + cleanData.length + " แห่ง";
    }

    function filterTable(type) {
        if (!dataTable) return;
        document.getElementById('btn-reset-filter').style.display = 'inline-block';
        while($.fn.dataTable.ext.search.length > 0) { $.fn.dataTable.ext.search.pop(); }
        $.fn.dataTable.ext.search.push(
            function(settings, data, dataIndex) {
                const statusText = (data[6] || "").toString(); 
                if (type === 'pass') return statusText.includes('ผ่าน') && !statusText.includes('ไม่ผ่าน');
                else if (type === 'fail') return statusText.includes('ไม่ผ่าน');
                return true;
            }
        );
        dataTable.draw();
    }

    function resetTableFilter() {
        if (!dataTable) return;
        document.getElementById('btn-reset-filter').style.display = 'none';
        while($.fn.dataTable.ext.search.length > 0) { $.fn.dataTable.ext.search.pop(); }
        dataTable.search('').columns().search('').draw();
    }

    function updateSmartTable(data, target) {
        if (dataTable) { dataTable.destroy(); dataTable = null; }
        const tbody = document.getElementById('table-body');
        const tfoot = document.getElementById('table-foot');
        
        // Restore standard header
        const thead = document.getElementById('table-header').rows[0];
        thead.innerHTML = '<th style="width: 5%">#</th><th style="width: 25%">หน่วยบริการ / รายการ</th><th style="width: 15%" class="text-center bg-light text-primary border-start">เป้าหมาย</th><th style="width: 15%" class="text-center bg-light text-success border-end">ผลงาน</th><th style="width: 10%" class="text-center">ร้อยละ (%)</th><th style="width: 20%">Progress Bar</th><th style="width: 10%" class="text-center">สถานะ</th>';

        tbody.innerHTML = ''; tfoot.innerHTML = '';

        if (!data || data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted p-4">ไม่พบข้อมูลสำหรับตัวชี้วัดนี้</td></tr>';
            return;
        }

        const totalRow = data.find(d => d.id === 'total');
        const unitRows = data.filter(d => d.id !== 'total').sort((a, b) => b.value - a.value);

        unitRows.forEach((item, index) => {
            const tr = document.createElement('tr');
            if(item.id === selectedUnitId) tr.classList.add('table-primary');
            let name = item.name;
            let targetNum = (item.target !== undefined && item.target !== null) ? item.target.toLocaleString() : "-";
            let resultNum = (item.result !== undefined && item.result !== null) ? item.result.toLocaleString() : "-";
            
            let statusBadge = '<span class="badge bg-light text-muted fw-normal border">N/A</span>';
            let progressColor = 'bg-secondary';
            if (target) {
                if (item.value >= target) {
                    statusBadge = '<span class="badge bg-success-subtle text-success fw-normal border border-success-subtle"><i class="bi bi-check-circle-fill"></i> ผ่าน</span>';
                    progressColor = 'bg-success';
                } else {
                    statusBadge = '<span class="badge bg-danger-subtle text-danger fw-normal border border-danger-subtle"><i class="bi bi-x-circle-fill"></i> ไม่ผ่าน</span>';
                    progressColor = 'bg-danger';
                }
            }

            tr.innerHTML = `
                <td class="text-center text-muted fw-bold">${index + 1}</td>
                <td>${name}</td>
                <td class="text-center text-primary fw-bold bg-light border-start">${targetNum}</td>
                <td class="text-center text-success fw-bold bg-light border-end">${resultNum}</td>
                <td class="text-center fw-bold text-dark">${item.value}%</td>
                <td><div class="progress progress-slim"><div class="progress-bar ${progressColor}" style="width: ${Math.min(item.value, 100)}%"></div></div></td>
                <td class="text-center">${statusBadge}</td>
            `;
            tr.style.cursor = 'pointer';
            tr.onclick = () => {
                const unitObj = mapData.find(u => u.id === item.id);
                if(unitObj) selectUnit(unitObj);
            };
            tbody.appendChild(tr);
        });

        if (totalRow) {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td class="text-center">-</td>
                <td><strong>ภาพรวมอำเภอ</strong></td>
                <td class="text-center text-primary fs-6 border-start">${totalRow.target || "-"}</td>
                <td class="text-center text-success fs-6 border-end">${totalRow.result || "-"}</td>
                <td class="text-center text-dark fs-6 fw-bold">${totalRow.value}%</td>
                <td><div class="progress progress-slim"><div class="progress-bar bg-primary" style="width: ${Math.min(totalRow.value, 100)}%"></div></div></td>
                <td class="text-center"><small class="text-muted">ค่าเฉลี่ย</small></td>
            `;
            tfoot.appendChild(tr);
        }

        dataTable = $('#detail-table').DataTable({ paging: false, searching: true, info: false, language: { search: "ค้นหา:", zeroRecords: "ไม่พบข้อมูล" } });
    }

    function animateValue(id, start, end, duration) {
        if (start === end) return;
        const obj = document.getElementById(id);
        let startTimestamp = null;
        const step = (timestamp) => {
            if (!startTimestamp) startTimestamp = timestamp;
            const progress = Math.min((timestamp - startTimestamp) / duration, 1);
            let current = progress * (end - start) + start;
            obj.innerHTML = (end % 1 === 0) ? Math.floor(current) : current.toFixed(2);
            if (progress < 1) window.requestAnimationFrame(step); else obj.innerHTML = end;
        };
        window.requestAnimationFrame(step);
    }

    function renderGauge(value, target) {
        const ctx = document.getElementById('gaugeChart').getContext('2d');
        if (gaugeChart) gaugeChart.destroy();
        const remaining = Math.max(0, 100 - value);
        const isPass = target && value >= target;
        let color = '#3b82f6';
        if (target) color = isPass ? '#10b981' : '#ef4444';

        gaugeChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['ผลงาน', 'ส่วนที่เหลือ'],
                datasets: [{
                    data: [value, remaining],
                    backgroundColor: [color, '#f1f5f9'],
                    borderWidth: 0, circumference: 180, rotation: -90, cutout: '75%'
                }]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, tooltip: { enabled: false } } }
        });
    }

    function renderBarChart(data, targetValue, showData) {
        const ctx = document.getElementById('comparisonChart').getContext('2d');
        const overlay = document.getElementById('no-data-overlay');
        
        if (barChart) { barChart.destroy(); barChart = null; }

        if (!showData || data.length === 0) {
            overlay.classList.remove('d-none');
            barChart = new Chart(ctx, { type: 'bar', data: {}, options: {plugins:{legend:false}, scales:{x:{display:false}, y:{display:false}}}});
            return;
        }
        overlay.classList.add('d-none');

        const sortedData = [...data].sort((a, b) => {
            if (a.id === 'total') return -1; 
            if (b.id === 'total') return 1;
            return b.value - a.value;   
        });
        
        const labels = sortedData.map(d => {
            if (d.id === 'total') return 'ภาพรวม';
            const unitObj = mapData.find(u => u.id === d.id);
            return (unitObj && unitObj.initial) ? unitObj.initial : (d.initial || d.name);
        });

        const values = sortedData.map(d => d.value);
        
        const bgColors = sortedData.map(d => {
            if (d.id === 'total') {
                if (targetValue !== null) return (Number(d.value) >= Number(targetValue)) ? '#7CFC00' : '#FF4500';
                return '#32CD32';
            }
            if (d.id === selectedUnitId) return '#f59e0b';
            return '#B0C4DE'; 
        });

        const annotations = {};
        if (targetValue !== null) {
            annotations.line1 = {
                type: 'line', yMin: targetValue, yMax: targetValue,
                borderColor: '#dc2626', borderWidth: 2, borderDash: [5, 5],
                label: { content: `เป้า ${targetValue}%`, display: true, position: 'end', backgroundColor: '#dc2626', color: 'white', font: {size: 10} }
            };
        }

        barChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    data: values,
                    backgroundColor: bgColors,
                    borderRadius: 4, barPercentage: 0.6,
                }]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                onClick: (e, elements) => {
                    if (elements.length > 0) {
                        const idx = elements[0].index;
                        const clickedId = sortedData[idx].id;
                        if(clickedId === 'total') selectUnit({id:'total', name:'ภาพรวมอำเภอ', lat:0, lng:0});
                        else {
                            const unitObj = mapData.find(u => u.id === clickedId);
                            if (unitObj) selectUnit(unitObj);
                        }
                    }
                },
                scales: {
                    y: { beginAtZero: true, max: 100, grid: { borderDash: [2, 2] } },
                    x: { grid: { display: false }, ticks: { font: {family: 'Prompt', size: 10, weight: 'bold'}, autoSkip: false, maxRotation: 45, minRotation: 0 } }
                },
                plugins: {
                    legend: { display: false },
                    tooltip: { callbacks: { title: (ctx) => sortedData[ctx[0].dataIndex].name } },
                    datalabels: { anchor: 'end', align: 'top', formatter: (val) => val + '%', font: { family: 'Prompt', weight: 'bold' }, color: '#4b5563' },
                    annotation: { annotations: annotations }
                }
            },
            plugins: [ChartDataLabels]
        });
    }

    function resetCharts() {
        if(barChart) { barChart.destroy(); barChart = null; }
        if(gaugeChart) { gaugeChart.destroy(); gaugeChart = null; }
    }
</script>
</body>
</html>
