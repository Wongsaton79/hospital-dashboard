<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (V.Ready to Use)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style> 
        body { font-family: 'Sarabun', sans-serif; } 
        .loader { border: 4px solid #f3f3f3; border-radius: 50%; border-top: 4px solid #10b981; width: 20px; height: 20px; animation: spin 2s linear infinite; } 
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } } 
    </style>
</head>
<body class="bg-gray-100 p-6">
    <div class="max-w-4xl mx-auto bg-white p-8 rounded-xl shadow-lg border-t-4 border-green-600">
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-3xl font-bold text-gray-800">üõ†Ô∏è Admin Panel (‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô)</h1>
            <div id="loadingIndicator" class="hidden flex items-center gap-2 text-green-600 font-bold"><div class="loader"></div> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô...</div>
        </div>
        
        <div class="bg-green-50 border-l-4 border-green-400 p-4 mb-6 text-sm text-green-900">
            <p><strong>Database URL:</strong> <span id="showUrl" class="font-mono bg-white px-1 rounded text-gray-500 text-xs">...</span></p>
            <div class="mt-2 flex items-center gap-2">
                <span>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Cloud:</span>
                <span id="connectionStatus" class="font-bold text-gray-500">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠...</span>
                <button onclick="checkConnection()" class="ml-2 bg-green-200 hover:bg-green-300 text-green-800 px-2 py-0.5 rounded text-xs">‡∏•‡∏≠‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÉ‡∏´‡∏°‡πà</button>
            </div>
        </div>

        <div class="grid gap-6">
            <div class="p-4 bg-blue-50 rounded-lg border border-blue-200">
                <h2 class="font-bold text-blue-800 mb-2">1. ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏Å‡∏£ (Staff)</h2>
                <input type="file" id="fileStaff" accept=".xlsx, .xls, .csv" class="block w-full text-sm mb-2"/>
                <p class="text-xs text-blue-600">
                    * ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏≠‡πà‡∏≤‡∏ô‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Column A-D (ID, ‡∏ä‡∏∑‡πà‡∏≠, ‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•, ‡πÅ‡∏ú‡∏ô‡∏Å)<br>
                    * ‡∏Å‡∏£‡∏≠‡∏á‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ "‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô" ‡∏≠‡∏≠‡∏Å‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
                </p>
            </div>

            <div class="p-4 bg-green-50 rounded-lg border border-green-200">
                <h2 class="font-bold text-green-800 mb-2">2. ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤-‡∏≠‡∏≠‡∏Å (Attendance)</h2>
                <input type="file" id="fileTime" accept=".xlsx, .xls, .csv" class="block w-full text-sm"/>
            </div>

            <div class="p-4 bg-orange-50 rounded-lg border border-orange-200">
                <h2 class="font-bold text-orange-800 mb-2">3. ‡∏Å‡∏≤‡∏£‡∏•‡∏≤ (Leave)</h2>
                <input type="file" id="fileLeave" accept=".xlsx, .xls, .csv" class="block w-full text-sm"/>
            </div>
        </div>

        <div class="mt-8 pt-4 border-t flex justify-between items-center text-sm">
            <div>
                <p>‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö: <span id="cntStaff" class="font-bold text-green-600 text-2xl">-</span> ‡∏Ñ‡∏ô</p>
                <p>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á: <span id="cntDays" class="font-bold text-green-600 text-2xl">-</span> ‡∏ß‡∏±‡∏ô</p>
            </div>
            <button onclick="resetDB()" class="text-white bg-red-600 hover:bg-red-700 border px-4 py-2 rounded shadow transition font-bold">
                üóëÔ∏è ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤‡∏ó‡∏¥‡πâ‡∏á (Reset DB)
            </button>
        </div>
    </div>

    <script>
        // ==========================================
        // ‚úÖ‚úÖ ‡πÉ‡∏™‡πà URL ‡πÉ‡∏´‡πâ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏£‡∏±‡∏ö ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏Å‡πâ ‚úÖ‚úÖ
        const RAW_URL = "https://bdlh-cs-default-rtdb.asia-southeast1.firebasedatabase.app/"; 
        // ==========================================
        
        // ‡∏ï‡∏±‡∏î / ‡∏ó‡πâ‡∏≤‡∏¢ URL ‡∏≠‡∏≠‡∏Å‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ URL ‡∏û‡∏±‡∏á
        const CLEAN_URL = RAW_URL.endsWith('/') ? RAW_URL.slice(0, -1) : RAW_URL;
        const API_URL = `${CLEAN_URL}/data.json`;
        
        let globalData = { staff: {}, records: [] };

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö
        (async function initSystem() {
            document.getElementById('showUrl').innerText = CLEAN_URL;
            await checkConnection();
        })();

        async function checkConnection() {
            setLoading(true);
            const statusEl = document.getElementById('connectionStatus');
            statusEl.innerText = "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...";
            
            try {
                // ‡πÄ‡∏û‡∏¥‡πà‡∏° Timeout ‡∏Å‡∏±‡∏ô‡∏Ñ‡πâ‡∏≤‡∏á
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 10000); // 10 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ

                const res = await fetch(API_URL, { signal: controller.signal });
                clearTimeout(timeoutId);

                if(res.ok) {
                    const json = await res.json();
                    if(json) {
                        globalData = json;
                        if(!globalData.staff) globalData.staff = {};
                        if(!globalData.records) globalData.records = [];
                    } else { globalData = { staff: {}, records: [] }; }
                    
                    updateUI();
                    
                    statusEl.innerText = "‚úÖ ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à";
                    statusEl.className = "text-green-600 font-bold";
                } else { 
                    throw new Error(`HTTP ${res.status}`); 
                }
            } catch (error) {
                console.error(error);
                statusEl.innerText = "‚ùå ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ (" + error.message + ")";
                statusEl.className = "text-red-600 font-bold";
                alert("‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Firebase ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ: " + error.message + "\n(‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï)");
            }
            setLoading(false);
        }

        async function saveToCloud() {
            setLoading(true);
            try {
                const res = await fetch(API_URL, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(globalData)
                });
                if(res.ok) { alert('‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!'); updateUI(); } 
                else { const err = await res.json(); alert(`‚ùå ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${JSON.stringify(err)}`); }
            } catch (error) { alert('‚ùå Network Error: ' + error.message); }
            setLoading(false);
        }

        async function resetDB() {
            if(confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô 0?\n(‡πÉ‡∏ä‡πâ‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏Å‡∏£‡∏ì‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î)")) {
                globalData = { staff: {}, records: [] };
                await saveToCloud();
                location.reload();
            }
        }

        // --- File Processing ---
        document.getElementById('fileStaff').addEventListener('change', (e) => processFile(e, 'staff'));
        document.getElementById('fileTime').addEventListener('change', (e) => processFile(e, 'time'));
        document.getElementById('fileLeave').addEventListener('change', (e) => processFile(e, 'leave'));

        function processFile(event, type) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    let workbook = XLSX.read(data, {type: 'array'});
                    
                    // Auto-detect CSV Encoding
                    let firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    let rows = XLSX.utils.sheet_to_json(firstSheet, {header: 1});
                    
                    if(file.name.endsWith('.csv') && rows.length > 5 && type === 'time') {
                        const sample = JSON.stringify(rows.slice(0,5));
                        if(!sample.includes('ID') && !sample.includes('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å')) {
                             const textReader = new FileReader();
                             textReader.onload = (evt) => {
                                 const text = new TextDecoder('windows-874').decode(evt.target.result);
                                 const wb = XLSX.read(text, {type: 'string'});
                                 runProcess(wb, type);
                             };
                             textReader.readAsArrayBuffer(file);
                             return;
                        }
                    }
                    runProcess(workbook, type);
                } catch(err) { alert("Error reading file: " + err.message); }
            };
            reader.readAsArrayBuffer(file);
        }

        function runProcess(workbook, type) {
            let firstSheet = workbook.Sheets[workbook.SheetNames[0]];
            let rows = XLSX.utils.sheet_to_json(firstSheet, {header: 1});
            if (type === 'staff') processStaff(rows);
            else if (type === 'time') processTime(rows);
            else if (type === 'leave') processLeave(rows);
        }

        async function processStaff(rows) {
            let headerIdx = -1;
            for(let i=0; i<Math.min(rows.length, 20); i++) {
                if(rows[i] && rows[i][0] && (String(rows[i][0]).toUpperCase().includes('ID') || String(rows[i][0]).includes('‡∏£‡∏´‡∏±‡∏™'))) {
                    headerIdx = i;
                    break;
                }
            }

            if (headerIdx === -1) return alert('‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á "ID" ‡πÉ‡∏ô Column A');
            
            const newStaff = {};
            let countTotal = 0;
            let countSkipped = 0;

            for(let i = headerIdx + 1; i < rows.length; i++) {
                const row = rows[i];
                if(!row || row.length === 0) continue;

                // ‡∏≠‡πà‡∏≤‡∏ô A-D (0-3)
                const id = String(row[0] || '').trim();
                const fname = String(row[1] || '').trim();
                const lname = String(row[2] || '').trim();
                let dept = String(row[3] || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏').trim();

                if (!id) continue;
                countTotal++;

                // ‡∏Å‡∏£‡∏≠‡∏á‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ "‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô" ‡∏à‡∏≤‡∏Å‡∏ó‡∏±‡πâ‡∏á‡πÅ‡∏ñ‡∏ß
                const fullRowString = JSON.stringify(row).toLowerCase();
                if (fullRowString.includes('‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô') || fullRowString.includes('disable') || fullRowString.includes('‡∏•‡∏≤‡∏≠‡∏≠‡∏Å')) {
                    countSkipped++;
                    continue; 
                }

                const safeDept = dept.replace(/[.#$/[\]]/g, ' - ');
                newStaff[id] = { id: id, name: `${fname} ${lname}`.trim(), dept: safeDept };
            }

            const activeCount = Object.keys(newStaff).length;
            
            let msg = `üîé ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•:\n‡∏û‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: ${countTotal}\n‡∏ï‡∏±‡∏î‡∏≠‡∏≠‡∏Å: ${countSkipped}\n‚úÖ ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏à‡∏£‡∏¥‡∏á: ${activeCount} ‡∏Ñ‡∏ô\n(‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢: 199 ‡∏Ñ‡∏ô)\n\n‡∏Å‡∏î OK ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å`;

            if(confirm(msg)) {
                globalData.staff = newStaff;
                await saveToCloud();
            }
        }

        async function processTime(rows) {
            if (!globalData.staff || Object.keys(globalData.staff).length === 0) return alert('‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏á‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠ (1) ‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö');
            const table = smartParse(rows, ['ID', '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å']);
            if (!table) return alert('‚ùå ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏ß‡∏•‡∏≤‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
            let fileDate = parseDate(table[0]['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà']);
            if (!fileDate) return alert(`‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà`);

            let dayName = table[0]['‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå'] || "";
            const scannedIds = new Set();
            let checkOutCount = 0;
            const lateList = [], earlyArrivalList = [], earlyLeaveList = [];
            const hourlyStats = new Array(24).fill(0).map(()=>({in:0, out:0, late:0}));
            const WORK_START = 8*60, LATE_LIMIT = 8*60 + 30, LATE_CUTOFF = 16*60, LEAVE_LIMIT = 16*60 + 30, EARLY_CHECK_START = 5*60; 

            table.forEach(r => {
                const id = String(r['ID']).trim();
                if (!id || !globalData.staff[id]) return; 
                
                scannedIds.add(id);
                const count = parseInt(r['‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡∏£‡∏π‡∏î‡∏ö‡∏±‡∏ï‡∏£'] || 0);
                const recordStr = String(r['‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å'] || "");
                const times = recordStr.split(';').map(t => t.trim()).filter(t => t !== "");
                let tIn = null, tOut = null;
                if (count >= 1 && times.length > 0) tIn = parseTime(times[0]); 
                if (count >= 2 && times.length > 1) tOut = parseTime(times[1]); 

                if (tIn) {
                    hourlyStats[tIn.h].in++;
                    if (tIn.mins > LATE_LIMIT && tIn.mins <= LATE_CUTOFF) {
                        hourlyStats[tIn.h].late++;
                        lateList.push({ id, name: globalData.staff[id].name, dept: globalData.staff[id].dept, time: tIn.str, lateMins: tIn.mins - LATE_LIMIT });
                    }
                    if (tIn.mins >= EARLY_CHECK_START && tIn.mins < WORK_START) {
                        earlyArrivalList.push({ id, name: globalData.staff[id].name, dept: globalData.staff[id].dept, time: tIn.str, arriveEarlyMins: WORK_START - tIn.mins });
                    }
                }
                if (tOut) {
                    checkOutCount++;
                    hourlyStats[tOut.h].out++;
                    if (tOut.mins < LEAVE_LIMIT) {
                        earlyLeaveList.push({ id, name: globalData.staff[id].name, dept: globalData.staff[id].dept, time: tOut.str, earlyLeaveMins: LEAVE_LIMIT - tOut.mins });
                    }
                }
            });

            const missingList = [], missingDept = {};
            Object.values(globalData.staff).forEach(emp => {
                if (!scannedIds.has(emp.id)) {
                    missingList.push(emp);
                    let safeDeptName = emp.dept || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
                    missingDept[safeDeptName] = (missingDept[safeDeptName] || 0) + 1;
                }
            });

            const sortByTime = (a, b) => a.time.localeCompare(b.time);
            lateList.sort(sortByTime); earlyArrivalList.sort(sortByTime); earlyLeaveList.sort(sortByTime);

            const dailyRecord = {
                date: fileDate, day: dayName, isWeekend: (dayName.includes('‡πÄ‡∏™‡∏≤‡∏£‡πå') || dayName.includes('‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå')),
                scannedIds: Array.from(scannedIds),
                summary: { total: Object.keys(globalData.staff).length, scanned: scannedIds.size, checkedOut: checkOutCount, lateCount: lateList.length, leave: 0, missing: missingList.length },
                lists: { late: lateList, earlyArrival: earlyArrivalList, earlyLeave: earlyLeaveList, missing: missingList, missingDept: missingDept, leave: [] },
                charts: { hourly: hourlyStats }
            };

            globalData.records = globalData.records.filter(d => d.date !== fileDate);
            globalData.records.push(dailyRecord);
            globalData.records.sort((a,b) => new Date(a.date) - new Date(b.date));
            if (globalData.records.length > 90) globalData.records = globalData.records.slice(globalData.records.length - 90);

            await saveToCloud();
        }

        async function processLeave(rows) {
            if (!globalData.records || globalData.records.length === 0) return alert('‚ö†Ô∏è ‡∏•‡∏á‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö');
            const table = smartParse(rows, ['ID', '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏•‡∏≤‡∏á‡∏≤‡∏ô']);
            if (!table) return alert('‚ùå ‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
            const leavesByDate = {};
            table.forEach(r => {
                let d = parseDate(r['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏•‡∏≤‡∏á‡∏≤‡∏ô']);
                let id = String(r['ID']).trim();
                if (d && id && globalData.staff[id]) {
                    if (!leavesByDate[d]) leavesByDate[d] = [];
                    leavesByDate[d].push({ id, name: globalData.staff[id].name, dept: globalData.staff[id].dept, type: r['‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó'], isHalf: (r['‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó']||'').includes('‡∏Ñ‡∏£‡∏∂‡πà‡∏á') });
                }
            });
            globalData.records = globalData.records.map(day => {
                if (leavesByDate[day.date]) {
                    const rawLeaves = leavesByDate[day.date];
                    const scannedIds = new Set(day.scannedIds);
                    const filteredLeaves = rawLeaves.filter(l => !scannedIds.has(l.id));
                    const rawLeaveIds = new Set(rawLeaves.map(l => l.id)); 
                    const newMissing = [], newMissingDept = {};
                    Object.values(globalData.staff).forEach(emp => {
                        if (!scannedIds.has(emp.id) && !rawLeaveIds.has(emp.id)) {
                            newMissing.push(emp);
                            let safeDeptName = emp.dept || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
                            newMissingDept[safeDeptName] = (newMissingDept[safeDeptName] || 0) + 1;
                        }
                    });
                    day.lists.leave = filteredLeaves;
                    day.lists.missing = newMissing;
                    day.lists.missingDept = newMissingDept;
                    day.summary.leave = filteredLeaves.length;
                    day.summary.missing = newMissing.length;
                }
                return day;
            });
            await saveToCloud();
        }

        // --- Utils ---
        function setLoading(b) { document.getElementById('loadingIndicator').classList.toggle('hidden', !b); }
        function updateUI() {
            if(document.getElementById('cntStaff')) document.getElementById('cntStaff').innerText = Object.keys(globalData.staff).length;
            if(document.getElementById('cntDays')) document.getElementById('cntDays').innerText = globalData.records.length;
        }
        function smartParse(rawRows, keywords) {
            let headerIdx = -1;
            for(let i=0; i < Math.min(rawRows.length, 30); i++) {
                const rowStr = JSON.stringify(rawRows[i] || []);
                if (keywords.every(k => rowStr.includes(k))) { headerIdx = i; break; }
            }
            if (headerIdx === -1) return null;
            const headers = rawRows[headerIdx].map(h => h ? String(h).trim() : "");
            const result = [];
            for(let i = headerIdx + 1; i < rawRows.length; i++) {
                const row = rawRows[i];
                if (!row || row.length === 0) continue;
                let obj = {};
                headers.forEach((h, idx) => { if(h) obj[h] = row[idx]; });
                if (obj['ID']) result.push(obj);
            }
            return result;
        }
        function parseTime(str) {
            if (!str) return null;
            const parts = str.split(':'); if (parts.length < 2) return null;
            const h = parseInt(parts[0]), m = parseInt(parts[1]);
            return { str: `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`, mins: h*60+m, h };
        }
        function parseDate(val) {
            if (!val) return null;
            if (val instanceof Date) return val.toISOString().split('T')[0];
            if (typeof val === 'string') {
                const parts = val.split(/[-/]/);
                if(parts.length === 3) { 
                    if (parseInt(parts[0]) > 2000) return `${parts[0]}-${parts[1].padStart(2,'0')}-${parts[2].padStart(2,'0')}`;
                    let y = parseInt(parts[2]); if (y > 2400) y -= 543; 
                    return `${y}-${parts[1].padStart(2,'0')}-${parts[0].padStart(2,'0')}`; 
                }
                return val.trim();
            }
            if(typeof val === 'number') return new Date(Math.round((val - 25569) * 86400 * 1000)).toISOString().split('T')[0];
            return null;
        }
    </script>
</body>
</html>