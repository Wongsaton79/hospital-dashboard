<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ö‡∏ö‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style> 
        body { font-family: 'Sarabun', sans-serif; } 
        .loader { border: 4px solid #f3f3f3; border-radius: 50%; border-top: 4px solid #4f46e5; width: 20px; height: 20px; animation: spin 2s linear infinite; } 
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } } 
    </style>
</head>
<body class="bg-gray-100 p-6">
    <div class="max-w-5xl mx-auto space-y-6">
        
        <div class="bg-white p-6 rounded-xl shadow-md border-t-4 border-indigo-600 flex justify-between items-center">
            <div>
                <h1 class="text-2xl font-bold text-gray-800">üõ†Ô∏è Admin Panel (‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏™‡πà‡∏ß‡∏ô)</h1>
                <div class="flex items-center gap-2 mt-2 text-sm">
                    <span class="font-bold text-gray-500">Status:</span>
                    <span id="connectionStatus" class="text-indigo-600 font-bold flex items-center gap-2">
                        <div class="loader w-4 h-4"></div> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠...
                    </span>
                    <span id="showUrl" class="hidden text-xs text-gray-300 ml-2">...</span>
                </div>
            </div>
            <button onclick="window.location.reload()" class="bg-gray-100 hover:bg-gray-200 text-gray-600 px-4 py-2 rounded shadow text-sm font-bold">
                üîÑ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö
            </button>
        </div>

        <div class="bg-white p-6 rounded-xl shadow-md border-l-4 border-blue-500">
            <div class="flex justify-between items-start mb-4">
                <div>
                    <h2 class="text-xl font-bold text-blue-800">1. ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠ (Staff)</h2>
                    <p class="text-sm text-gray-500 mt-1">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: <span id="cntStaff" class="font-bold text-blue-600 text-lg">-</span> ‡∏Ñ‡∏ô</p>
                </div>
                <button onclick="deleteStaffOnly()" class="text-red-500 hover:text-red-700 text-sm font-bold border border-red-200 bg-red-50 hover:bg-red-100 px-3 py-1 rounded transition">
                    üóëÔ∏è ‡∏•‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠
                </button>
            </div>
            
            <input type="file" id="fileStaff" accept=".xlsx, .xls, .csv" class="block w-full text-sm text-slate-500
              file:mr-4 file:py-2 file:px-4
              file:rounded-full file:border-0
              file:text-sm file:font-semibold
              file:bg-blue-50 file:text-blue-700
              hover:file:bg-blue-100 mb-2"/>
            <p class="text-xs text-blue-400">* ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏°‡πà (‡∏≠‡πà‡∏≤‡∏ô‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Col A-D)</p>
        </div>

        <div class="bg-white p-6 rounded-xl shadow-md border-l-4 border-green-500">
            <h2 class="text-xl font-bold text-green-800 mb-4">2. ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô (Attendance & Leave)</h2>
            
            <div class="grid md:grid-cols-2 gap-6">
                <div class="space-y-4">
                    <div class="p-4 bg-green-50 rounded border border-green-200">
                        <label class="block font-bold text-green-700 text-sm mb-2">üì• ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤-‡∏≠‡∏≠‡∏Å (Attendance)</label>
                        <input type="file" id="fileTime" accept=".xlsx, .xls, .csv" class="block w-full text-sm"/>
                    </div>
                    <div class="p-4 bg-orange-50 rounded border border-orange-200">
                        <label class="block font-bold text-orange-700 text-sm mb-2">üì• ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏Å‡∏≤‡∏£‡∏•‡∏≤ (Leave)</label>
                        <input type="file" id="fileLeave" accept=".xlsx, .xls, .csv" class="block w-full text-sm"/>
                    </div>
                </div>

                <div class="border rounded-lg overflow-hidden">
                    <div class="bg-gray-100 px-4 py-2 border-b font-bold text-gray-600 text-sm flex justify-between items-center">
                        <span>üìÖ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</span>
                        <span id="cntDays" class="bg-gray-200 text-gray-600 px-2 py-0.5 rounded text-xs">0 ‡∏ß‡∏±‡∏ô</span>
                    </div>
                    <div id="dateListContainer" class="max-h-60 overflow-y-auto bg-white p-2 space-y-1">
                        <p class="text-center text-gray-400 text-sm py-4">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="mt-8 pt-6 border-t-2 border-red-100 text-center">
            <p class="text-gray-400 text-xs mb-2">‡∏´‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤ ‡∏´‡∏£‡∏∑‡∏≠‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p>
            <button onclick="wipeDatabase()" class="bg-red-600 hover:bg-red-700 text-white px-6 py-2 rounded shadow font-bold text-sm transition transform hover:scale-105">
                üí£ ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö (Hard Reset)
            </button>
        </div>
    </div>

    <script>
        // ==========================================
        const RAW_URL = "https://bdlh-cs-default-rtdb.asia-southeast1.firebasedatabase.app/"; 
        // ==========================================
        
        const CLEAN_URL = RAW_URL.endsWith('/') ? RAW_URL.slice(0, -1) : RAW_URL;
        const API_URL = `${CLEAN_URL}/data.json`;
        
        let globalData = { staff: {}, records: [] };

        (async function initSystem() {
            document.getElementById('showUrl').innerText = CLEAN_URL;
            await checkConnection();
        })();

        // --- Core Functions ---
        async function checkConnection() {
            setLoading(true);
            const statusEl = document.getElementById('connectionStatus');
            try {
                const res = await fetch(API_URL);
                if(res.ok) {
                    const json = await res.json();
                    if(json) {
                        globalData = json;
                        if(!globalData.staff) globalData.staff = {};
                        if(!globalData.records) globalData.records = [];
                    } else { globalData = { staff: {}, records: [] }; }
                    
                    updateUI();
                    statusEl.innerHTML = "‚úÖ ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à";
                    statusEl.className = "text-green-600 font-bold text-sm";
                } else { throw new Error(`HTTP ${res.status}`); }
            } catch (error) {
                console.error(error);
                statusEl.innerHTML = "‚ùå ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ";
                statusEl.className = "text-red-600 font-bold text-sm";
            }
            setLoading(false);
        }

        async function saveToCloud() {
            setLoading(true);
            try {
                const res = await fetch(API_URL, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(globalData)
                });
                if(res.ok) { 
                    alert('‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!'); 
                    updateUI(); 
                } else { 
                    alert('‚ùå ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'); 
                }
            } catch (error) { alert('‚ùå Error: ' + error.message); }
            setLoading(false);
        }

        // --- UI Updates ---
        function updateUI() {
            // Update Staff Count
            const staffCount = globalData.staff ? Object.keys(globalData.staff).length : 0;
            document.getElementById('cntStaff').innerText = staffCount;

            // Update Date List
            const listContainer = document.getElementById('dateListContainer');
            const records = globalData.records || [];
            document.getElementById('cntDays').innerText = `${records.length} ‡∏ß‡∏±‡∏ô`;

            if (records.length === 0) {
                listContainer.innerHTML = '<p class="text-center text-gray-400 text-sm py-4">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Ç‡πâ‡∏≤-‡∏≠‡∏≠‡∏Å‡∏á‡∏≤‡∏ô</p>';
            } else {
                // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏Ç‡∏∂‡πâ‡∏ô‡∏Å‡πà‡∏≠‡∏ô
                const sortedRecords = [...records].sort((a,b) => new Date(b.date) - new Date(a.date));
                
                listContainer.innerHTML = sortedRecords.map(rec => `
                    <div class="flex justify-between items-center bg-gray-50 hover:bg-indigo-50 p-2 rounded border border-gray-200 transition">
                        <div>
                            <span class="font-bold text-gray-700 text-sm">${rec.date}</span>
                            <span class="text-xs text-gray-500 ml-2">(${rec.day})</span>
                            <span class="text-xs text-indigo-500 block">‡∏™‡πÅ‡∏Å‡∏ô: ${rec.summary.scanned} | ‡∏•‡∏≤: ${rec.summary.leave} | ‡∏Ç‡∏≤‡∏î: ${rec.summary.missing}</span>
                        </div>
                        <button onclick="deleteDate('${rec.date}')" class="text-red-500 hover:text-red-700 bg-white hover:bg-red-50 border border-red-200 p-1.5 rounded shadow-sm" title="‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ">
                            üóëÔ∏è
                        </button>
                    </div>
                `).join('');
            }
        }

        // --- Deletion Features (Granular) ---
        
        // 1. ‡∏•‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠
        async function deleteStaffOnly() {
            const currentCount = Object.keys(globalData.staff).length;
            if(currentCount === 0) return alert("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏•‡∏ö");

            if(confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (${currentCount} ‡∏Ñ‡∏ô)?\n\n(‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏´‡∏≤‡∏¢ ‡πÅ‡∏ï‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏≤‡∏à‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏à‡∏ô‡∏Å‡∏ß‡πà‡∏≤‡∏à‡∏∞‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏´‡∏°‡πà)`)) {
                globalData.staff = {};
                await saveToCloud();
            }
        }

        // 2. ‡∏•‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà (Attendance Day)
        async function deleteDate(dateStr) {
            if(confirm(`‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà "${dateStr}" ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?\n\n(‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡πÅ‡∏Å‡∏ô‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏•‡∏≤‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡∏ó‡∏¥‡πâ‡∏á)`)) {
                globalData.records = globalData.records.filter(r => r.date !== dateStr);
                await saveToCloud();
            }
        }

        // 3. ‡∏•‡πâ‡∏≤‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (Hard Reset)
        async function wipeDatabase() {
            if(confirm("‚ö†Ô∏è ‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢! ‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô 0 ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) {
                globalData = { staff: {}, records: [] };
                await saveToCloud();
            }
        }


        // --- File Processing Functions ---
        document.getElementById('fileStaff').addEventListener('change', (e) => processFile(e, 'staff'));
        document.getElementById('fileTime').addEventListener('change', (e) => processFile(e, 'time'));
        document.getElementById('fileLeave').addEventListener('change', (e) => processFile(e, 'leave'));

        function processFile(event, type) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    let workbook = XLSX.read(data, {type: 'array'});
                    
                    let firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    let rows = XLSX.utils.sheet_to_json(firstSheet, {header: 1});
                    
                    if(file.name.endsWith('.csv') && rows.length > 5 && type === 'time') {
                         const sample = JSON.stringify(rows.slice(0,5));
                         if(!sample.includes('ID') && !sample.includes('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å')) {
                             const textReader = new FileReader();
                             textReader.onload = (evt) => {
                                 const text = new TextDecoder('windows-874').decode(evt.target.result);
                                 const wb = XLSX.read(text, {type: 'string'});
                                 runProcess(wb, type);
                             };
                             textReader.readAsArrayBuffer(file);
                             return;
                         }
                    }
                    runProcess(workbook, type);
                } catch(err) { alert("Error: " + err.message); }
            };
            reader.readAsArrayBuffer(file);
        }

        function runProcess(workbook, type) {
            let firstSheet = workbook.Sheets[workbook.SheetNames[0]];
            let rows = XLSX.utils.sheet_to_json(firstSheet, {header: 1});
            if (type === 'staff') processStaff(rows);
            else if (type === 'time') processTime(rows);
            else if (type === 'leave') processLeave(rows);
        }

        // Logic ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏´‡∏°‡πà (A-D)
        async function processStaff(rows) {
            let headerIdx = -1;
            for(let i=0; i<Math.min(rows.length, 20); i++) {
                if(rows[i] && rows[i][0] && (String(rows[i][0]).toUpperCase().includes('ID') || String(rows[i][0]).includes('‡∏£‡∏´‡∏±‡∏™'))) {
                    headerIdx = i;
                    break;
                }
            }
            if (headerIdx === -1) return alert('‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á ID ‡πÉ‡∏ô Column A');
            
            const newStaff = {};
            let countTotal = 0;

            for(let i = headerIdx + 1; i < rows.length; i++) {
                const row = rows[i];
                if(!row || row.length === 0) continue;

                const id = String(row[0] || '').trim();
                const fname = String(row[1] || '').trim();
                const lname = String(row[2] || '').trim();
                let dept = String(row[3] || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏').trim();

                if (!id) continue;
                const safeDept = dept.replace(/[.#$/[\]]/g, ' - ');
                newStaff[id] = { id, name: `${fname} ${lname}`.trim(), dept: safeDept };
                countTotal++;
            }

            if(confirm(`‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏´‡∏°‡πà ${countTotal} ‡∏Ñ‡∏ô\n\n‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î\n‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) {
                globalData.staff = newStaff;
                await saveToCloud();
            }
        }

        // Logic ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏≠‡∏≠‡∏Å
        async function processTime(rows) {
            if (Object.keys(globalData.staff).length === 0) return alert('‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏á‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡πà‡∏≠‡∏ô');
            const table = smartParse(rows, ['ID', '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å']);
            if (!table) return alert('‚ùå ‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
            let fileDate = parseDate(table[0]['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà']);
            if (!fileDate) return alert(`‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà`);

            // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á
            const existingIdx = globalData.records.findIndex(r => r.date === fileDate);
            if(existingIdx !== -1) {
                if(!confirm(`‚ö†Ô∏è ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${fileDate} ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß!\n\n‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡∏±‡∏ö (Overwrite) ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) return;
            }

            let dayName = table[0]['‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå'] || "";
            const scannedIds = new Set();
            let checkOutCount = 0;
            const lateList = [], earlyArrivalList = [], earlyLeaveList = [];
            const hourlyStats = new Array(24).fill(0).map(()=>({in:0, out:0, late:0}));
            const WORK_START = 8*60, LATE_LIMIT = 8*60 + 30, LATE_CUTOFF = 16*60, LEAVE_LIMIT = 16*60 + 30, EARLY_CHECK_START = 5*60; 

            table.forEach(r => {
                const id = String(r['ID']).trim();
                if (!id || !globalData.staff[id]) return; 
                
                scannedIds.add(id);
                const count = parseInt(r['‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡∏£‡∏π‡∏î‡∏ö‡∏±‡∏ï‡∏£'] || 0);
                const recordStr = String(r['‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å'] || "");
                const times = recordStr.split(';').map(t => t.trim()).filter(t => t !== "");
                let tIn = null, tOut = null;
                if (count >= 1 && times.length > 0) tIn = parseTime(times[0]); 
                if (count >= 2 && times.length > 1) tOut = parseTime(times[1]); 

                if (tIn) {
                    hourlyStats[tIn.h].in++;
                    if (tIn.mins > LATE_LIMIT && tIn.mins <= LATE_CUTOFF) {
                        hourlyStats[tIn.h].late++;
                        lateList.push({ id, name: globalData.staff[id].name, dept: globalData.staff[id].dept, time: tIn.str, lateMins: tIn.mins - LATE_LIMIT });
                    }
                    if (tIn.mins >= EARLY_CHECK_START && tIn.mins < WORK_START) {
                        earlyArrivalList.push({ id, name: globalData.staff[id].name, dept: globalData.staff[id].dept, time: tIn.str, arriveEarlyMins: WORK_START - tIn.mins });
                    }
                }
                if (tOut) {
                    checkOutCount++;
                    hourlyStats[tOut.h].out++;
                    if (tOut.mins < LEAVE_LIMIT) {
                        earlyLeaveList.push({ id, name: globalData.staff[id].name, dept: globalData.staff[id].dept, time: tOut.str, earlyLeaveMins: LEAVE_LIMIT - tOut.mins });
                    }
                }
            });

            const missingList = [], missingDept = {};
            Object.values(globalData.staff).forEach(emp => {
                if (!scannedIds.has(emp.id)) {
                    missingList.push(emp);
                    let safeDeptName = emp.dept || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
                    missingDept[safeDeptName] = (missingDept[safeDeptName] || 0) + 1;
                }
            });

            const sortByTime = (a, b) => a.time.localeCompare(b.time);
            lateList.sort(sortByTime); earlyArrivalList.sort(sortByTime); earlyLeaveList.sort(sortByTime);

            const dailyRecord = {
                date: fileDate, day: dayName, isWeekend: (dayName.includes('‡πÄ‡∏™‡∏≤‡∏£‡πå') || dayName.includes('‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå')),
                scannedIds: Array.from(scannedIds),
                summary: { total: Object.keys(globalData.staff).length, scanned: scannedIds.size, checkedOut: checkOutCount, lateCount: lateList.length, leave: 0, missing: missingList.length },
                lists: { late: lateList, earlyArrival: earlyArrivalList, earlyLeave: earlyLeaveList, missing: missingList, missingDept: missingDept, leave: [] },
                charts: { hourly: hourlyStats }
            };

            // ‡∏•‡∏ö‡∏≠‡∏±‡∏ô‡πÄ‡∏Å‡πà‡∏≤‡∏≠‡∏≠‡∏Å‡∏Å‡πà‡∏≠‡∏ô (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ) ‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏™‡πà‡πÉ‡∏´‡∏°‡πà
            globalData.records = globalData.records.filter(d => d.date !== fileDate);
            globalData.records.push(dailyRecord);
            globalData.records.sort((a,b) => new Date(a.date) - new Date(b.date));
            if (globalData.records.length > 90) globalData.records = globalData.records.slice(globalData.records.length - 90);

            await saveToCloud();
        }

        // Logic ‡∏Å‡∏≤‡∏£‡∏•‡∏≤
        async function processLeave(rows) {
            if (globalData.records.length === 0) return alert('‚ö†Ô∏è ‡∏•‡∏á‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö');
            const table = smartParse(rows, ['ID', '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏•‡∏≤‡∏á‡∏≤‡∏ô']);
            if (!table) return alert('‚ùå ‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
            const leavesByDate = {};
            table.forEach(r => {
                let d = parseDate(r['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏•‡∏≤‡∏á‡∏≤‡∏ô']);
                let id = String(r['ID']).trim();
                if (d && id && globalData.staff[id]) {
                    if (!leavesByDate[d]) leavesByDate[d] = [];
                    leavesByDate[d].push({ id, name: globalData.staff[id].name, dept: globalData.staff[id].dept, type: r['‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó'], isHalf: (r['‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó']||'').includes('‡∏Ñ‡∏£‡∏∂‡πà‡∏á') });
                }
            });
            
            // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏µ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö
            let updatedCount = 0;
            globalData.records = globalData.records.map(day => {
                if (leavesByDate[day.date]) {
                    updatedCount++;
                    const rawLeaves = leavesByDate[day.date];
                    const scannedIds = new Set(day.scannedIds);
                    const filteredLeaves = rawLeaves.filter(l => !scannedIds.has(l.id));
                    const rawLeaveIds = new Set(rawLeaves.map(l => l.id)); 
                    const newMissing = [], newMissingDept = {};
                    Object.values(globalData.staff).forEach(emp => {
                        if (!scannedIds.has(emp.id) && !rawLeaveIds.has(emp.id)) {
                            newMissing.push(emp);
                            let safeDeptName = emp.dept || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
                            newMissingDept[safeDeptName] = (newMissingDept[safeDeptName] || 0) + 1;
                        }
                    });
                    day.lists.leave = filteredLeaves;
                    day.lists.missing = newMissing;
                    day.lists.missingDept = newMissingDept;
                    day.summary.leave = filteredLeaves.length;
                    day.summary.missing = newMissing.length;
                }
                return day;
            });
            
            if(updatedCount > 0) {
                await saveToCloud();
            } else {
                alert("‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö (‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏ß‡∏•‡∏≤‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏±‡πâ‡∏ô‡πÜ ‡∏Å‡πà‡∏≠‡∏ô)");
            }
        }

        // --- Utils ---
        function setLoading(b) { 
            const loader = document.getElementById('connectionStatus');
            if(b) loader.innerHTML = '<div class="loader w-4 h-4"></div> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô...';
            else loader.innerHTML = '‚úÖ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô';
        }
        function smartParse(rawRows, keywords) {
            let headerIdx = -1;
            for(let i=0; i < Math.min(rawRows.length, 30); i++) {
                const rowStr = JSON.stringify(rawRows[i] || []);
                if (keywords.every(k => rowStr.includes(k))) { headerIdx = i; break; }
            }
            if (headerIdx === -1) return null;
            const headers = rawRows[headerIdx].map(h => h ? String(h).trim() : "");
            const result = [];
            for(let i = headerIdx + 1; i < rawRows.length; i++) {
                const row = rawRows[i];
                if (!row || row.length === 0) continue;
                let obj = {};
                headers.forEach((h, idx) => { if(h) obj[h] = row[idx]; });
                if (obj['ID']) result.push(obj);
            }
            return result;
        }
        function parseTime(str) {
            if (!str) return null;
            const parts = str.split(':'); if (parts.length < 2) return null;
            const h = parseInt(parts[0]), m = parseInt(parts[1]);
            return { str: `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`, mins: h*60+m, h };
        }
        function parseDate(val) {
            if (!val) return null;
            if (val instanceof Date) return val.toISOString().split('T')[0];
            if (typeof val === 'string') {
                const parts = val.split(/[-/]/);
                if(parts.length === 3) { 
                    if (parseInt(parts[0]) > 2000) return `${parts[0]}-${parts[1].padStart(2,'0')}-${parts[2].padStart(2,'0')}`;
                    let y = parseInt(parts[2]); if (y > 2400) y -= 543; 
                    return `${y}-${parts[1].padStart(2,'0')}-${parts[0].padStart(2,'0')}`; 
                }
                return val.trim();
            }
            if(typeof val === 'number') return new Date(Math.round((val - 25569) * 86400 * 1000)).toISOString().split('T')[0];
            return null;
        }
    </script>
</body>
</html>
