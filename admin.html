<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Force Update</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style> body { font-family: 'Sarabun', sans-serif; } </style>
</head>
<body class="bg-gray-100 p-6">
    <div class="max-w-4xl mx-auto bg-white p-8 rounded-xl shadow-lg border-t-4 border-purple-600">
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-3xl font-bold text-gray-800">‚ö° Admin (Force Update)</h1>
            <div id="loadingIndicator" class="hidden text-purple-600 font-bold">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô...</div>
        </div>
        
        <div class="bg-purple-50 border-l-4 border-purple-400 p-4 mb-6 flex justify-between items-center">
            <div>
                <p class="text-sm font-bold text-purple-900">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Cloud:</p>
                <p id="connectionStatus" class="text-gray-500 font-bold">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠...</p>
            </div>
            <button onclick="window.location.reload()" class="bg-white border border-purple-200 text-purple-700 px-3 py-1 rounded shadow text-sm hover:bg-purple-100">
                üîÑ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö (‡πÄ‡∏ä‡πá‡∏Ñ‡∏¢‡∏≠‡∏î)
            </button>
        </div>

        <div class="p-6 bg-blue-50 rounded-lg border border-blue-200 mb-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="font-bold text-blue-800 text-lg">1. ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠ (Staff)</h2>
                <div class="text-right">
                    <span class="text-gray-600 text-sm">‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö:</span>
                    <span id="cntStaff" class="font-bold text-blue-600 text-2xl ml-2">-</span>
                </div>
            </div>
            <div class="flex gap-4 items-end">
                <div class="w-full">
                    <input type="file" id="fileStaff" accept=".xlsx, .xls, .csv" class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-white file:text-blue-700 hover:file:bg-blue-50"/>
                    <p class="text-xs text-blue-500 mt-1">* ‡∏≠‡πà‡∏≤‡∏ô Col A-D ‡πÅ‡∏•‡∏∞‡∏ó‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤‡∏ó‡∏±‡∏ô‡∏ó‡∏µ</p>
                </div>
                <button onclick="deleteStaffOnly()" class="bg-red-100 text-red-600 px-4 py-2 rounded text-sm font-bold hover:bg-red-200 border border-red-200 whitespace-nowrap">
                    üóëÔ∏è ‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏¥‡πâ‡∏á
                </button>
            </div>
        </div>

        <div class="grid md:grid-cols-2 gap-6 mb-6">
            <div class="p-4 bg-green-50 rounded-lg border border-green-200">
                <h2 class="font-bold text-green-800 mb-2">2. ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤-‡∏≠‡∏≠‡∏Å (Attendance)</h2>
                <input type="file" id="fileTime" accept=".xlsx, .xls, .csv" class="block w-full text-sm"/>
            </div>
            <div class="p-4 bg-orange-50 rounded-lg border border-orange-200">
                <h2 class="font-bold text-orange-800 mb-2">3. ‡∏Å‡∏≤‡∏£‡∏•‡∏≤ (Leave)</h2>
                <input type="file" id="fileLeave" accept=".xlsx, .xls, .csv" class="block w-full text-sm"/>
            </div>
        </div>

        <div class="border-t pt-4">
             <p class="text-sm text-gray-500 mb-2">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á: <span id="cntDays" class="font-bold text-gray-800">0</span> ‡∏ß‡∏±‡∏ô</p>
             <button onclick="wipeDatabase()" class="text-red-400 text-xs underline hover:text-red-600">‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏£‡∏∞‡∏ö‡∏ö (Hard Reset)</button>
        </div>
    </div>

    <script>
        // ‚úÖ URL (‡πÄ‡∏û‡∏¥‡πà‡∏° timestamp ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏à‡∏≥‡∏Ñ‡πà‡∏≤‡πÄ‡∏Å‡πà‡∏≤)
        const RAW_URL = "https://bdlh-cs-default-rtdb.asia-southeast1.firebasedatabase.app/"; 
        const CLEAN_URL = RAW_URL.endsWith('/') ? RAW_URL.slice(0, -1) : RAW_URL;
        const API_URL = `${CLEAN_URL}/data.json`;
        
        let globalData = { staff: {}, records: [] };

        (async function init() { await checkConnection(); })();

        async function checkConnection() {
            setLoading(true);
            const statusEl = document.getElementById('connectionStatus');
            try {
                // üî• Cache Busting: ‡πÉ‡∏™‡πà ?t=... ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏´‡∏°‡πà ‡πÑ‡∏°‡πà‡πÄ‡∏≠‡∏≤‡∏à‡∏≤‡∏Å cache
                const res = await fetch(`${API_URL}?t=${Date.now()}`);
                if(res.ok) {
                    const json = await res.json();
                    globalData = json || { staff: {}, records: [] };
                    if(!globalData.staff) globalData.staff = {};
                    if(!globalData.records) globalData.records = [];
                    updateUI();
                    statusEl.innerText = "‚úÖ ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÅ‡∏•‡πâ‡∏ß (‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î)";
                    statusEl.className = "text-green-600 font-bold";
                } else { throw new Error(res.status); }
            } catch (e) {
                statusEl.innerText = "‚ùå ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ";
                statusEl.className = "text-red-600 font-bold";
            }
            setLoading(false);
        }

        async function saveToCloud() {
            setLoading(true);
            try {
                const res = await fetch(API_URL, {
                    method: 'PUT', // PUT = ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏ó‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(globalData)
                });
                if(res.ok) { 
                    alert('‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! (‡∏¢‡∏≠‡∏î‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô: ' + Object.keys(globalData.staff).length + ')'); 
                    updateUI(); 
                } else { alert('‚ùå ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'); }
            } catch (error) { alert('‚ùå Error: ' + error.message); }
            setLoading(false);
        }

        function updateUI() {
            document.getElementById('cntStaff').innerText = Object.keys(globalData.staff).length;
            document.getElementById('cntDays').innerText = globalData.records.length;
        }

        function setLoading(b) {
            document.getElementById('loadingIndicator').style.display = b ? 'block' : 'none';
        }

        // --- Actions ---
        async function deleteStaffOnly() {
            if(confirm("‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?")) {
                globalData.staff = {};
                await saveToCloud();
            }
        }
        async function wipeDatabase() {
            if(confirm("‚ö†Ô∏è ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏õ‡πá‡∏ô 0?")) {
                globalData = { staff: {}, records: [] };
                await saveToCloud();
            }
        }

        // --- File Processing ---
        document.getElementById('fileStaff').addEventListener('change', (e) => processFile(e, 'staff'));
        document.getElementById('fileTime').addEventListener('change', (e) => processFile(e, 'time'));
        document.getElementById('fileLeave').addEventListener('change', (e) => processFile(e, 'leave'));

        function processFile(event, type) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                let workbook = XLSX.read(data, {type: 'array'});
                let rows = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], {header: 1});
                
                // CSV Fix for Time file
                if(file.name.endsWith('.csv') && type === 'time' && rows.length > 0 && !JSON.stringify(rows[0]).includes('ID')) {
                     const textReader = new FileReader();
                     textReader.onload = (evt) => {
                         const text = new TextDecoder('windows-874').decode(evt.target.result);
                         const wb = XLSX.read(text, {type: 'string'});
                         runProcess(XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], {header:1}), type);
                     };
                     textReader.readAsArrayBuffer(file);
                     return;
                }
                runProcess(rows, type);
            };
            reader.readAsArrayBuffer(file);
        }

        function runProcess(rows, type) {
            if (type === 'staff') processStaff(rows);
            else if (type === 'time') processTime(rows);
            else if (type === 'leave') processLeave(rows);
        }

        async function processStaff(rows) {
            // Logic A-D ‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£
            let headerIdx = -1;
            for(let i=0; i<Math.min(rows.length, 20); i++) {
                if(rows[i] && rows[i][0] && (String(rows[i][0]).toUpperCase().includes('ID') || String(rows[i][0]).includes('‡∏£‡∏´‡∏±‡∏™'))) { headerIdx = i; break; }
            }
            if (headerIdx === -1) return alert('‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö ID ‡πÉ‡∏ô Column A');
            
            const newStaff = {};
            let count = 0;
            for(let i = headerIdx + 1; i < rows.length; i++) {
                const r = rows[i];
                if(!r || !r[0]) continue;
                const id = String(r[0]).trim();
                const safeDept = String(r[3]||'‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏').trim().replace(/[.#$/[\]]/g, ' - ');
                // ‡∏≠‡πà‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡∏¥‡∏ö‡πÜ ‡πÄ‡∏•‡∏¢ ‡πÑ‡∏°‡πà‡∏Å‡∏£‡∏≠‡∏á‡∏≠‡∏∞‡πÑ‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏ô‡∏±‡πâ‡∏ô ‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£
                newStaff[id] = { id, name: `${String(r[1]||'').trim()} ${String(r[2]||'').trim()}`, dept: safeDept };
                count++;
            }

            if(confirm(`‡∏û‡∏ö ${count} ‡∏Ñ‡∏ô\n‡∏Å‡∏î OK ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏±‡∏ô‡∏ó‡∏µ`)) {
                globalData.staff = newStaff;
                await saveToCloud();
            }
        }

        async function processTime(rows) {
            if (Object.keys(globalData.staff).length === 0) return alert('‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö');
            let headerIdx = -1;
            for(let i=0; i<Math.min(rows.length, 30); i++) {
                if(JSON.stringify(rows[i]).includes('ID') && JSON.stringify(rows[i]).includes('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å')) { headerIdx = i; break; }
            }
            if (headerIdx === -1) return alert('‚ùå ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏ú‡∏¥‡∏î');

            let fileDate = rows[headerIdx]['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà'] || (rows[headerIdx+1] ? parseDate(rows[headerIdx+1][4]) : null);
            if(!fileDate && rows[headerIdx+1]) fileDate = parseDate(rows[headerIdx+1][4]); 
            if (!fileDate) return alert(`‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà`);

            globalData.records = globalData.records.filter(d => d.date !== fileDate); // ‡∏•‡∏ö‡∏ß‡∏±‡∏ô‡∏ã‡πâ‡∏≥

            const scannedIds = new Set();
            let checkOutCount = 0;
            const lateList = [], hourly = new Array(24).fill(0).map(()=>({in:0,out:0,late:0}));

            for(let i = headerIdx + 1; i < rows.length; i++) {
                const r = rows[i];
                if(!r || !r[3]) continue;
                const id = String(r[3]).trim();
                
                // üî• ‡∏Å‡∏£‡∏≠‡∏á: ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ô‡∏±‡∏ö (‡πÅ‡∏Å‡πâ 234)
                if (!globalData.staff[id]) continue;

                scannedIds.add(id);
                const times = String(r[7]||"").split(';').map(t=>t.trim()).filter(t=>t);
                
                if(times[0]) {
                    const t = parseTime(times[0]);
                    hourly[t.h].in++;
                    if(t.mins > 8*60+30 && t.mins <= 16*60) {
                        hourly[t.h].late++;
                        lateList.push({id, name: globalData.staff[id].name, dept: globalData.staff[id].dept, time: t.str, lateMins: t.mins - (8*60+30)});
                    }
                }
                if(times[1]) {
                    checkOutCount++;
                    const t = parseTime(times[1]);
                    hourly[t.h].out++;
                }
            }

            const missingList = [], missingDept = {};
            Object.values(globalData.staff).forEach(emp => {
                if(!scannedIds.has(emp.id)) {
                    missingList.push(emp);
                    missingDept[emp.dept] = (missingDept[emp.dept]||0)+1;
                }
            });

            globalData.records.push({
                date: fileDate, 
                day: rows[headerIdx+1] ? (rows[headerIdx+1][5] || "") : "",
                summary: { total: Object.keys(globalData.staff).length, scanned: scannedIds.size, checkedOut: checkOutCount, lateCount: lateList.length, leave: 0, missing: missingList.length },
                lists: { late: lateList, missing: missingList, missingDept: missingDept, leave: [] },
                charts: { hourly: hourly },
                scannedIds: Array.from(scannedIds)
            });
            globalData.records.sort((a,b) => new Date(a.date) - new Date(b.date));
            await saveToCloud();
        }

        async function processLeave(rows) {
            if (globalData.records.length === 0) return alert('‚ö†Ô∏è ‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô‡∏Å‡πà‡∏≠‡∏ô');
            const table = XLSX.utils.sheet_to_json(XLSX.read(rows, {type:'array'}).Sheets['Sheet1'] || rows); 
            // Logic ‡∏á‡πà‡∏≤‡∏¢‡πÜ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏£‡∏∞‡∏ä‡∏±‡∏ö (‡πÉ‡∏ä‡πâ‡πÇ‡∏Ñ‡∏£‡∏á‡πÄ‡∏î‡∏¥‡∏°‡πÑ‡∏î‡πâ)
            alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏ä‡πâ‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡∏Å‡πà‡∏≠‡∏ô‡∏•‡∏á‡πÑ‡∏ü‡∏•‡πå‡∏•‡∏≤‡∏Ñ‡∏£‡∏±‡∏ö (Logic ‡πÄ‡∏î‡∏¥‡∏°)');
        }

        function parseDate(val) {
            if (!val) return null;
            if (typeof val === 'number') return new Date(Math.round((val - 25569) * 86400 * 1000)).toISOString().split('T')[0];
            if (typeof val === 'string') {
                const p = val.trim().split(/[-/]/);
                if(p.length===3) return `${parseInt(p[2])>2400?parseInt(p[2])-543:p[0]}-${p[1].padStart(2,'0')}-${p[2].padStart(2,'0')}`;
                if(parseInt(p[0]) > 2000) return `${p[0]}-${p[1]}-${p[2]}`;
            }
            return null;
        }
        function parseTime(str) {
            const p = str.split(':');
            const h = parseInt(p[0]), m = parseInt(p[1]);
            return { str, mins: h*60+m, h };
        }
    </script>
</body>
</html>
