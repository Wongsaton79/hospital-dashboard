<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Time Logic Updated)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style> body { font-family: 'Sarabun', sans-serif; } </style>
</head>
<body class="bg-gray-100 p-6">
    <div class="max-w-4xl mx-auto bg-white p-8 rounded-xl shadow-lg border-t-4 border-sky-500">
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-2xl font-bold text-gray-800">‚öôÔ∏è Admin Panel (New Time Rules)</h1>
            <div class="flex items-center gap-3">
                <span id="status" class="text-gray-500 font-bold text-sm">‚è≥ ‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠...</span>
                <button onclick="location.reload()" class="bg-gray-100 px-3 py-1 rounded text-sm font-bold text-gray-600">‚Üª ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button>
            </div>
        </div>

        <div class="p-6 bg-blue-50 rounded-lg border border-blue-200 mb-6">
            <div class="flex justify-between mb-4">
                <h2 class="font-bold text-blue-900">1. ‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô (Staff)</h2>
                <div class="text-right">
                    <span id="cntStaff" class="font-bold text-blue-600 text-xl">-</span> ‡∏Ñ‡∏ô
                    <button onclick="deleteStaffOnly()" class="ml-4 text-xs text-red-500 underline">‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠</button>
                </div>
            </div>
            <input type="file" id="fileStaff" accept=".xlsx, .xls, .csv" class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-white file:text-blue-700 hover:file:bg-blue-100"/>
        </div>

        <div class="grid md:grid-cols-2 gap-6 mb-6">
            <div class="p-4 bg-green-50 rounded-lg border border-green-200">
                <h2 class="font-bold text-green-900 mb-2">2. ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤-‡∏≠‡∏≠‡∏Å (Attendance)</h2>
                <input type="file" id="fileTime" accept=".xlsx, .xls, .csv" class="block w-full text-sm"/>
                <div class="text-xs text-green-700 mt-2 bg-green-100 p-2 rounded">
                    <strong>Logic ‡πÉ‡∏´‡∏°‡πà:</strong><br>
                    ‚è∞ ‡∏™‡∏≤‡∏¢: 08:31 - 11:00<br>
                    üö™ ‡∏Å‡∏•‡∏±‡∏ö‡∏Å‡πà‡∏≠‡∏ô: 15:00 - 16:29<br>
                    ‚òÄÔ∏è ‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡πà‡∏≠‡∏ô: 06:00 - 07:59
                </div>
            </div>
            <div class="p-4 bg-orange-50 rounded-lg border border-orange-200">
                <h2 class="font-bold text-orange-900 mb-2">3. ‡∏Å‡∏≤‡∏£‡∏•‡∏≤ (Leave)</h2>
                <input type="file" id="fileLeave" accept=".xlsx, .xls, .csv" class="block w-full text-sm"/>
            </div>
        </div>

        <div class="border-t pt-4">
            <p class="text-sm text-gray-500 mb-2">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö: <span id="cntDays" class="font-bold">0</span> ‡∏ß‡∏±‡∏ô</p>
            <div id="dateListContainer" class="bg-gray-50 rounded-lg p-2 max-h-60 overflow-y-auto space-y-2 border border-gray-200"></div>
        </div>

        <div class="mt-6 pt-4 border-t text-center">
            <button onclick="wipeData()" class="text-red-400 text-xs underline">‚ö†Ô∏è ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (Factory Reset)</button>
        </div>
    </div>

    <script>
        const API_URL = "https://bdlh-cs-default-rtdb.asia-southeast1.firebasedatabase.app/data.json"; 
        let globalData = { staff: {}, records: [] };

        (async () => { await checkConnection(); })();

        async function checkConnection() {
            try {
                const res = await fetch(`${API_URL}?t=${Date.now()}`);
                if(res.ok) {
                    const json = await res.json();
                    globalData = json || { staff: {}, records: [] };
                    if(!globalData.staff) globalData.staff = {};
                    if(!globalData.records) globalData.records = [];
                    updateUI();
                    document.getElementById('status').innerText = "‚úÖ ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÅ‡∏•‡πâ‡∏ß";
                    document.getElementById('status').className = "text-green-600 font-bold text-sm";
                }
            } catch (e) { document.getElementById('status').innerText = "‚ùå ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ"; }
        }

        async function saveToCloud() {
            try {
                await fetch(API_URL, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(globalData) });
                updateUI(); alert('‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
            } catch (e) { alert('Error: ' + e.message); }
        }

        function updateUI() {
            document.getElementById('cntStaff').innerText = Object.keys(globalData.staff).length;
            document.getElementById('cntDays').innerText = globalData.records.length;
            const listDiv = document.getElementById('dateListContainer');
            if(globalData.records.length === 0) listDiv.innerHTML = '<p class="text-center text-xs text-gray-400 py-4">‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤</p>';
            else {
                const sorted = [...globalData.records].sort((a,b) => new Date(b.date) - new Date(a.date));
                listDiv.innerHTML = sorted.map(rec => `
                    <div class="flex justify-between items-center bg-white p-2 rounded border border-gray-200 shadow-sm">
                        <div class="text-sm"><span class="font-bold text-gray-700">${rec.date}</span> <span class="text-xs text-gray-500">(${rec.day})</span></div>
                        <button onclick="deleteDate('${rec.date}')" class="text-xs text-red-500 border border-red-200 px-2 py-1 rounded">‡∏•‡∏ö</button>
                    </div>`).join('');
            }
        }

        document.getElementById('fileStaff').addEventListener('change', (e) => processFile(e, 'staff'));
        document.getElementById('fileTime').addEventListener('change', (e) => processFile(e, 'time'));
        document.getElementById('fileLeave').addEventListener('change', (e) => processFile(e, 'leave'));

        function processFile(event, type) {
            const file = event.target.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = (evt) => {
                const data = new Uint8Array(evt.target.result);
                let wb = XLSX.read(data, {type:'array'});
                if(file.name.endsWith('.csv')) {
                    const dec = new TextDecoder('windows-874');
                    const text = dec.decode(data);
                    if(text.includes('ID') || text.includes('id')) wb = XLSX.read(text, {type:'string'});
                }
                const rows = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], {header:1});
                if(type === 'staff') processStaff(rows);
                else if(type === 'time') processTime(rows);
                else if(type === 'leave') processLeave(rows);
            };
            reader.readAsArrayBuffer(file);
        }

        async function processStaff(rows) {
            let hIdx = -1;
            for(let i=0; i<Math.min(rows.length,20); i++) { if(JSON.stringify(rows[i]).toUpperCase().includes("ID")) { hIdx=i; break; } }
            const start = hIdx===-1?0:hIdx+1;
            const newStaff = {};
            for(let i=start; i<rows.length; i++) {
                const r = rows[i];
                if(r && r[0]) {
                    const id = String(r[0]).trim();
                    newStaff[id] = { id, name: `${r[1]||''} ${r[2]||''}`.trim(), dept: String(r[3]||'‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏').trim().replace(/[.#$/[\]]/g, ' - ') };
                }
            }
            if(confirm(`‡∏û‡∏ö ${Object.keys(newStaff).length} ‡∏Ñ‡∏ô ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô?`)) { globalData.staff = newStaff; await saveToCloud(); }
        }

        async function processTime(rows) {
            if(Object.keys(globalData.staff).length === 0) return alert("‡∏•‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡πà‡∏≠‡∏ô");
            
            let hIdx = -1, headers = [];
            for(let i=0; i<rows.length; i++) {
                const r = rows[i].map(x=>String(x).trim());
                if(r.includes('ID') && (r.includes('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å')||r.includes('‡πÄ‡∏ß‡∏•‡∏≤'))) { hIdx=i; headers=r; break; }
            }
            if(hIdx === -1) return alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á");

            let dateStr = null;
            for(let i=0; i<Math.min(rows.length, 10); i++) {
                if(rows[i][4]) { dateStr = rows[i][4]; break; } 
            }
            if(!isNaN(dateStr) && String(dateStr).indexOf('-') === -1) dateStr = parseDate(dateStr);
            else dateStr = parseDate(dateStr);
            if(!dateStr) return alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà");

            globalData.records = globalData.records.filter(r => r.date !== dateStr);

            const scanned = new Set();
            const late=[], earlyArrival=[], earlyLeave=[], hourly=new Array(24).fill(0).map(()=>({in:0,out:0}));
            const missing=[], missingDept={};

            for(let i=hIdx+1; i<rows.length; i++) {
                const r = rows[i];
                if(!r) continue;
                let obj = {}; headers.forEach((h,k) => obj[h]=r[k]);
                const id = String(obj['ID']).trim();
                
                if(!globalData.staff[id]) continue;
                scanned.add(id);

                const timeStr = obj['‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å'] || obj['‡πÄ‡∏ß‡∏•‡∏≤'] || "";
                const times = timeStr.split(';').map(t=>t.trim()).filter(t=>t);

                if(times.length > 0) {
                    const t1 = parseTime(times[0]);
                    if(t1) {
                        hourly[t1.h].in++;
                        
                        // üî• Logic 3: ‡∏°‡∏≤‡∏™‡∏≤‡∏¢ 08:31 - 11:00 (511 - 660 mins)
                        if(t1.mins > 8*60+30 && t1.mins <= 11*60) {
                            late.push({ id, name: globalData.staff[id].name, dept: globalData.staff[id].dept, time: t1.str, lateMins: t1.mins - (8*60+30) });
                        }
                        
                        // üî• Logic 4: ‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡πà‡∏≠‡∏ô 06:00 - 07:59 (360 - 479 mins)
                        if(t1.mins >= 6*60 && t1.mins <= 7*60+59) {
                            earlyArrival.push({ id, name: globalData.staff[id].name, dept: globalData.staff[id].dept, time: t1.str, arriveEarlyMins: (8*60) - t1.mins });
                        }
                    }
                }

                    // --- ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô processTime ‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå admin.html ---
                    // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Early Leave ‡πÅ‡∏•‡πâ‡∏ß‡∏ß‡∏≤‡∏á‡∏ó‡∏±‡∏ö‡∏î‡πâ‡∏ß‡∏¢ Logic ‡∏ô‡∏µ‡πâ‡∏Ñ‡∏£‡∏±‡∏ö

                        if(times.length > 0) {
                    // ‡∏î‡∏∂‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡πÅ‡∏Å‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏ô‡∏ô‡∏±‡πâ‡∏ô‡∏≠‡∏≠‡∏Å‡∏°‡∏≤
                        const lastT = parseTime(times[times.length-1]); 
    
                            if(lastT) {
                                if(times.length > 1) hourly[lastT.h].out++;
        
                                // üî• Logic ‡∏ó‡∏µ‡πà‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥: ‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á 15:00 (900 ‡∏ô‡∏≤‡∏ó‡∏µ) ‡∏ñ‡∏∂‡∏á 16:29 (989 ‡∏ô‡∏≤‡∏ó‡∏µ) ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
                                // ‡πÅ‡∏•‡∏∞‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏ô‡∏≤‡∏ó‡∏µ‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏î (earlyLeaveMins) ‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 0
                                const targetLeaveTime = 16*60 + 30; // 16:30 (990 ‡∏ô‡∏≤‡∏ó‡∏µ)
        
                                if(lastT.mins >= 15*60 && lastT.mins < targetLeaveTime) {
                                    earlyLeave.push({
                                        id: id,
                                        name: globalData.staff[id].name,
                                        dept: globalData.staff[id].dept,
                                        time: lastT.str,
                                        earlyLeaveMins: targetLeaveTime - lastT.mins
                                    });
                                }
                            }
                        }
            }

            Object.values(globalData.staff).forEach(emp => {
                if(!scanned.has(emp.id)) { missing.push(emp); missingDept[emp.dept]=(missingDept[emp.dept]||0)+1; }
            });

            globalData.records.push({
                date: dateStr,
                day: getDayName(dateStr),
                isWeekend: false,
                summary: { total: Object.keys(globalData.staff).length, scanned: scanned.size, checkedOut: 0, leave: 0, missing: missing.length },
                lists: { late, earlyArrival, earlyLeave, missing, missingDept, leave: [] },
                charts: { hourly },
                scannedIds: Array.from(scanned)
            });
            
            const dObj = new Date(dateStr);
            if(dObj.getDay()===0||dObj.getDay()===6) globalData.records[globalData.records.length-1].isWeekend=true;
            globalData.records.sort((a,b)=>new Date(a.date)-new Date(b.date));
            await saveToCloud();
        }

        async function processLeave(rows) {
            const hRows = XLSX.utils.sheet_to_json(XLSX.utils.json_to_sheet(rows));
            let count = 0, dates = new Set();
            hRows.forEach(r => {
                const id = findVal(r, ['ID']);
                const dRaw = findVal(r, ['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà','‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏•‡∏≤']);
                const type = findVal(r, ['‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó']);
                if(id && dRaw) {
                    const dStr = parseDate(dRaw);
                    if(dStr) {
                        dates.add(dStr);
                        let rec = globalData.records.find(d=>d.date===dStr);
                        if(!rec) { /* Dummy create logic if needed */ return; }
                        if(!rec.lists.leave) rec.lists.leave = [];
                        if(!rec.lists.leave.find(l=>l.id==id)) {
                            rec.lists.leave.push({ id, name: globalData.staff[id]?.name||id, type: type||'‡∏•‡∏≤' });
                            count++;
                        }
                    }
                }
            });
            dates.forEach(dStr => {
                const rec = globalData.records.find(d=>d.date===dStr);
                if(rec) {
                    rec.summary.leave = rec.lists.leave.length;
                    const leaveIds = new Set(rec.lists.leave.map(l=>String(l.id)));
                    const scannedIds = new Set(rec.scannedIds);
                    const newMissing = [];
                    const newMissingDept = {};
                    Object.values(globalData.staff).forEach(emp => {
                        if(!scannedIds.has(emp.id) && !leaveIds.has(emp.id)) {
                            newMissing.push(emp);
                            newMissingDept[emp.dept] = (newMissingDept[emp.dept]||0)+1;
                        }
                    });
                    rec.lists.missing = newMissing; rec.lists.missingDept = newMissingDept; rec.summary.missing = newMissing.length;
                }
            });
            if(count>0) { await saveToCloud(); alert(`Updated Leave: ${count}`); } else alert("No match");
        }

        function deleteStaffOnly() { if(confirm("‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠?")) { globalData.staff={}; saveToCloud(); } }
        function deleteDate(d) { if(confirm("‡∏•‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà "+d+"?")) { globalData.records=globalData.records.filter(r=>r.date!==d); saveToCloud(); } }
        function wipeData() { if(confirm("‡∏•‡πâ‡∏≤‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?")) { globalData={staff:{},records:[]}; saveToCloud(); } }
        function findVal(o,k) { for(let i of k) if(o[i]) return o[i]; return null; }
        function parseTime(s) { const [h,m]=s.split(':').map(Number); return {str:s, mins:h*60+m, h}; }
        function parseDate(v) { if(typeof v==='number') return new Date(Math.round((v-25569)*864e5)).toISOString().split('T')[0]; if(typeof v==='string' && v.split(/[-/]/).length===3) { const p=v.split(/[-/]/); return `${parseInt(p[0])>2000?p[0]:(parseInt(p[2])>2400?parseInt(p[2])-543:p[2])}-${p[1].padStart(2,'0')}-${parseInt(p[0])>2000?p[2]:p[0].padStart(2,'0')}`; } return null; }
        function getDayName(d) { return ['‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå','‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå','‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£','‡∏û‡∏∏‡∏ò','‡∏û‡∏§‡∏´‡∏±‡∏™','‡∏®‡∏∏‡∏Å‡∏£‡πå','‡πÄ‡∏™‡∏≤‡∏£‡πå'][new Date(d).getDay()]; }
    </script>
</body>
</html>
