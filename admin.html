<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Fixed Leave Upload)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style> body { font-family: 'Sarabun', sans-serif; } </style>
</head>
<body class="bg-gray-100 p-6">
    <div class="max-w-4xl mx-auto bg-white p-8 rounded-xl shadow-lg border-t-4 border-sky-500">
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-2xl font-bold text-gray-800">‚öôÔ∏è Admin Panel (Final Fixed)</h1>
            <div class="flex items-center gap-3">
                <span id="status" class="text-gray-500 font-bold text-sm">‚è≥ ‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠...</span>
                <button onclick="location.reload()" class="bg-gray-100 px-3 py-1 rounded text-sm font-bold text-gray-600">‚Üª ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button>
            </div>
        </div>

        <div class="p-6 bg-blue-50 rounded-lg border border-blue-200 mb-6">
            <div class="flex justify-between mb-4">
                <h2 class="font-bold text-blue-900">1. ‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô (Staff)</h2>
                <div class="text-right">
                    <span id="cntStaff" class="font-bold text-blue-600 text-xl">-</span> ‡∏Ñ‡∏ô
                    <button onclick="deleteStaffOnly()" class="ml-4 text-xs text-red-500 underline">‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠</button>
                </div>
            </div>
            <input type="file" id="fileStaff" accept=".xlsx, .xls, .csv" class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-white file:text-blue-700 hover:file:bg-blue-100"/>
        </div>

        <div class="grid md:grid-cols-2 gap-6 mb-6">
            <div class="p-4 bg-green-50 rounded-lg border border-green-200">
                <h2 class="font-bold text-green-900 mb-2">2. ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤-‡∏≠‡∏≠‡∏Å (Attendance)</h2>
                <input type="file" id="fileTime" accept=".xlsx, .xls, .csv" class="block w-full text-sm"/>
                <div class="text-xs text-green-700 mt-2 bg-green-100 p-2 rounded">
                    <strong>Logic ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô:</strong><br>
                    ‚è∞ ‡∏™‡∏≤‡∏¢: 08:31 - 11:00<br>
                    üö™ ‡∏Å‡∏•‡∏±‡∏ö‡∏Å‡πà‡∏≠‡∏ô: 15:00 - 16:29<br>
                    ‚òÄÔ∏è ‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡πà‡∏≠‡∏ô: 06:00 - 07:59
                </div>
            </div>
            <div class="p-4 bg-orange-50 rounded-lg border border-orange-200">
                <h2 class="font-bold text-orange-900 mb-2">3. ‡∏Å‡∏≤‡∏£‡∏•‡∏≤ (Leave)</h2>
                <input type="file" id="fileLeave" accept=".xlsx, .xls, .csv" class="block w-full text-sm"/>
                <p class="text-xs text-orange-600 mt-2">* ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</p>
            </div>
        </div>

        <div class="border-t pt-4">
            <p class="text-sm text-gray-500 mb-2">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö: <span id="cntDays" class="font-bold">0</span> ‡∏ß‡∏±‡∏ô</p>
            <div id="dateListContainer" class="bg-gray-50 rounded-lg p-2 max-h-60 overflow-y-auto space-y-2 border border-gray-200"></div>
        </div>

        <div class="mt-6 pt-4 border-t text-center">
            <button onclick="wipeData()" class="text-red-400 text-xs underline">‚ö†Ô∏è ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (Factory Reset)</button>
        </div>
    </div>

    <script>
        const API_URL = "https://bdlh-cs-default-rtdb.asia-southeast1.firebasedatabase.app/data.json"; 
        let globalData = { staff: {}, records: [] };

        (async () => { await checkConnection(); })();

        async function checkConnection() {
            try {
                const res = await fetch(`${API_URL}?t=${Date.now()}`);
                if(res.ok) {
                    const json = await res.json();
                    globalData = json || { staff: {}, records: [] };
                    if(!globalData.staff) globalData.staff = {};
                    if(!globalData.records) globalData.records = [];
                    updateUI();
                    document.getElementById('status').innerText = "‚úÖ ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÅ‡∏•‡πâ‡∏ß";
                    document.getElementById('status').className = "text-green-600 font-bold text-sm";
                }
            } catch (e) { document.getElementById('status').innerText = "‚ùå ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ"; }
        }

        async function saveToCloud() {
            try {
                await fetch(API_URL, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(globalData) });
                updateUI(); alert('‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
            } catch (e) { alert('Error: ' + e.message); }
        }

        function updateUI() {
            document.getElementById('cntStaff').innerText = Object.keys(globalData.staff).length;
            document.getElementById('cntDays').innerText = globalData.records.length;
            const listDiv = document.getElementById('dateListContainer');
            if(globalData.records.length === 0) listDiv.innerHTML = '<p class="text-center text-xs text-gray-400 py-4">‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤</p>';
            else {
                const sorted = [...globalData.records].sort((a,b) => new Date(b.date) - new Date(a.date));
                listDiv.innerHTML = sorted.map(rec => `
                    <div class="flex justify-between items-center bg-white p-2 rounded border border-gray-200 shadow-sm">
                        <div class="text-sm">
                            <span class="font-bold text-gray-700">${rec.date}</span> 
                            <span class="text-xs text-gray-500">(${rec.day})</span>
                            <span class="ml-2 text-[10px] bg-orange-100 text-orange-600 px-1 rounded">‡∏•‡∏≤: ${rec.summary.leave}</span>
                        </div>
                        <button onclick="deleteDate('${rec.date}')" class="text-xs text-red-500 border border-red-200 px-2 py-1 rounded">‡∏•‡∏ö</button>
                    </div>`).join('');
            }
        }

        document.getElementById('fileStaff').addEventListener('change', (e) => processFile(e, 'staff'));
        document.getElementById('fileTime').addEventListener('change', (e) => processFile(e, 'time'));
        document.getElementById('fileLeave').addEventListener('change', (e) => processFile(e, 'leave'));

        function processFile(event, type) {
            const file = event.target.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = (evt) => {
                const data = new Uint8Array(evt.target.result);
                let wb = XLSX.read(data, {type:'array'});
                if(file.name.endsWith('.csv')) {
                    const dec = new TextDecoder('windows-874');
                    const text = dec.decode(data);
                    if(text.includes('ID') || text.includes('id')) wb = XLSX.read(text, {type:'string'});
                }
                const rows = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], {header:1});
                if(type === 'staff') processStaff(rows);
                else if(type === 'time') processTime(rows);
                else if(type === 'leave') processLeave(rows);
            };
            reader.readAsArrayBuffer(file);
        }

        async function processStaff(rows) {
            let hIdx = -1;
            for(let i=0; i<Math.min(rows.length,20); i++) { if(JSON.stringify(rows[i]).toUpperCase().includes("ID")) { hIdx=i; break; } }
            const start = hIdx===-1?0:hIdx+1;
            const newStaff = {};
            for(let i=start; i<rows.length; i++) {
                const r = rows[i];
                if(r && r[0]) {
                    const id = String(r[0]).trim();
                    newStaff[id] = { id, name: `${r[1]||''} ${r[2]||''}`.trim(), dept: String(r[3]||'‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏').trim().replace(/[.#$/[\]]/g, ' - ') };
                }
            }
            if(confirm(`‡∏û‡∏ö ${Object.keys(newStaff).length} ‡∏Ñ‡∏ô ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô?`)) { globalData.staff = newStaff; await saveToCloud(); }
        }

        async function processTime(rows) {
            if(Object.keys(globalData.staff).length === 0) return alert("‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô (Staff) ‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö");
            
            let hIdx = -1, headers = [];
            for(let i=0; i<rows.length; i++) {
                const r = (rows[i] || []).map(x=>String(x).trim());
                if(r.includes('ID') && (r.includes('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å')||r.includes('‡πÄ‡∏ß‡∏•‡∏≤'))) { hIdx=i; headers=r; break; }
            }
            if(hIdx === -1) return alert("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á (‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ ID ‡πÅ‡∏•‡∏∞ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å/‡πÄ‡∏ß‡∏•‡∏≤)");

            let dateStr = null;
            let dateColIdx = headers.indexOf("‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà");
            if(dateColIdx === -1) dateColIdx = 4;

            if(rows.length > hIdx + 1) {
                const firstDataRow = rows[hIdx + 1];
                if(firstDataRow && firstDataRow[dateColIdx]) {
                    dateStr = firstDataRow[dateColIdx];
                }
            }
            if(!dateStr) {
                 for(let i=0; i<hIdx; i++) {
                     const cell = String(rows[i][0]||"");
                     if(cell.includes("‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤:")) {
                         const match = cell.match(/(\d{4}-\d{2}-\d{2})/);
                         if(match) dateStr = match[1];
                     }
                 }
            }

            const validDate = parseDate(dateStr);
            if(!validDate) return alert(`‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ú‡∏¥‡∏î (${dateStr})`);
            
            dateStr = validDate;

            globalData.records = globalData.records.filter(r => r.date !== dateStr);

            const scanned = new Set();
            const late=[], earlyArrival=[], earlyLeave=[], hourly=new Array(24).fill(0).map(()=>({in:0,out:0}));
            const missing=[], missingDept={};

            for(let i=hIdx+1; i<rows.length; i++) {
                const r = rows[i];
                if(!r) continue;
                let obj = {}; headers.forEach((h,k) => obj[h]=r[k]);
                const id = String(obj['ID']).trim();
                
                if(!globalData.staff[id]) continue;
                scanned.add(id);

                const timeStr = obj['‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å'] || obj['‡πÄ‡∏ß‡∏•‡∏≤'] || "";
                const times = timeStr.split(';').map(t=>t.trim()).filter(t=>t);

                if(times.length > 0) {
                    const t1 = parseTime(times[0]);
                    if(t1) {
                        hourly[t1.h].in++;
                        if(t1.mins > 8*60+30 && t1.mins <= 11*60) {
                            late.push({ id, name: globalData.staff[id].name, dept: globalData.staff[id].dept, time: t1.str, lateMins: t1.mins - (8*60+30) });
                        }
                        if(t1.mins >= 6*60 && t1.mins < 8*60) {
                            earlyArrival.push({ id, name: globalData.staff[id].name, dept: globalData.staff[id].dept, time: t1.str, arriveEarlyMins: (8*60) - t1.mins });
                        }
                    }
                }

                if(times.length > 0) {
                    const lastT = parseTime(times[times.length-1]);
                    if(lastT) {
                        if(times.length > 1) hourly[lastT.h].out++;
                        if(lastT.mins >= 15*60 && lastT.mins < 16*60+30) {
                            earlyLeave.push({
                                id,
                                name: globalData.staff[id].name,
                                dept: globalData.staff[id].dept,
                                time: lastT.str,
                                earlyLeaveMins: (16*60+30) - lastT.mins
                            });
                        }
                    }
                }
            }

            Object.values(globalData.staff).forEach(emp => {
                if(!scanned.has(emp.id)) { missing.push(emp); missingDept[emp.dept]=(missingDept[emp.dept]||0)+1; }
            });

            globalData.records.push({
                date: dateStr,
                day: getDayName(dateStr),
                isWeekend: false,
                summary: { total: Object.keys(globalData.staff).length, scanned: scanned.size, checkedOut: 0, leave: 0, missing: missing.length },
                lists: { late, earlyArrival, earlyLeave, missing, missingDept, leave: [] },
                charts: { hourly },
                scannedIds: Array.from(scanned)
            });
            
            const dObj = new Date(dateStr);
            if(dObj.getDay()===0||dObj.getDay()===6) globalData.records[globalData.records.length-1].isWeekend=true;
            globalData.records.sort((a,b)=>new Date(a.date)-new Date(b.date));
            await saveToCloud();
        }

        // üî•üî•üî• UPDATED PROCESS LEAVE FUNCTION üî•üî•üî•
        async function processLeave(rows) {
            // 1. ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á (‡∏´‡∏≤ ID ‡πÅ‡∏•‡∏∞ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏•‡∏≤‡∏á‡∏≤‡∏ô)
            let hIdx = -1;
            let headers = [];
            
            for(let i=0; i<rows.length; i++) {
                const r = (rows[i] || []).map(x => String(x).trim());
                // ‡∏Ñ‡∏µ‡∏¢‡πå‡πÄ‡∏ß‡∏¥‡∏£‡πå‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÉ‡∏ö‡∏•‡∏≤
                if(r.includes('ID') && (r.includes('‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏•‡∏≤‡∏á‡∏≤‡∏ô') || r.includes('‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà') || r.includes('Start Date'))) {
                    hIdx = i;
                    headers = r;
                    break;
                }
            }

            if(hIdx === -1) return alert("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏ö‡∏•‡∏≤ (‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå 'ID' ‡πÅ‡∏•‡∏∞ '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏•‡∏≤‡∏á‡∏≤‡∏ô')");

            // 2. ‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå
            const colID = headers.indexOf('ID');
            let colDate = headers.findIndex(h => h.includes('‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏•‡∏≤‡∏á‡∏≤‡∏ô') || h.includes('‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà') || h.includes('Start Date'));
            let colType = headers.findIndex(h => h.includes('‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó') || h.includes('Type'));

            if(colDate === -1) return alert("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏•‡∏≤‡∏á‡∏≤‡∏ô'");

            let count = 0;
            let processedDates = new Set();

            // 3. ‡∏ß‡∏ô‡∏•‡∏π‡∏õ‡∏≠‡πà‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
            for(let i = hIdx + 1; i < rows.length; i++) {
                const r = rows[i];
                if(!r) continue;

                const id = String(r[colID] || "").trim();
                const dRaw = r[colDate];
                const type = colType !== -1 ? (r[colType] || "‡∏•‡∏≤") : "‡∏•‡∏≤";

                if(id && dRaw) {
                    const dateStr = parseDate(dRaw);
                    if(dateStr) {
                        processedDates.add(dateStr);
                        // ‡∏´‡∏≤ Record ‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏±‡πâ‡∏ô
                        let rec = globalData.records.find(d => d.date === dateStr);
                        
                        if(rec) {
                            if(!rec.lists.leave) rec.lists.leave = [];
                            // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÉ‡∏™‡πà‡∏ã‡πâ‡∏≥
                            if(!rec.lists.leave.find(l => l.id == id)) {
                                rec.lists.leave.push({ 
                                    id: id, 
                                    name: globalData.staff[id]?.name || id, 
                                    type: type 
                                });
                                count++;
                            }
                        }
                    }
                }
            }

            // 4. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Missing ‡πÉ‡∏´‡∏°‡πà ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï‡πÉ‡∏ö‡∏•‡∏≤
            processedDates.forEach(dStr => {
                const rec = globalData.records.find(d => d.date === dStr);
                if(rec) {
                    rec.summary.leave = rec.lists.leave.length;
                    const leaveIds = new Set(rec.lists.leave.map(l => String(l.id)));
                    const scannedIds = new Set(rec.scannedIds);
                    
                    const newMissing = [];
                    const newMissingDept = {};

                    Object.values(globalData.staff).forEach(emp => {
                        // ‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ Scan ‡πÅ‡∏•‡∏∞ ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏•‡∏≤ ‡∏Ñ‡∏∑‡∏≠‡∏Ñ‡∏ô‡∏Ç‡∏≤‡∏î
                        if(!scannedIds.has(emp.id) && !leaveIds.has(emp.id)) {
                            newMissing.push(emp);
                            newMissingDept[emp.dept] = (newMissingDept[emp.dept]||0) + 1;
                        }
                    });

                    rec.lists.missing = newMissing;
                    rec.lists.missingDept = newMissingDept;
                    rec.summary.missing = newMissing.length;
                }
            });

            if(count > 0) {
                await saveToCloud();
                alert(`‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏•‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${count} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`);
            } else {
                alert("‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏ß‡∏•‡∏≤‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏±‡πâ‡∏ô‡πÜ (‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå)");
            }
        }

        function deleteStaffOnly() { if(confirm("‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠?")) { globalData.staff={}; saveToCloud(); } }
        function deleteDate(d) { if(confirm("‡∏•‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà "+d+"?")) { globalData.records=globalData.records.filter(r=>r.date!==d); saveToCloud(); } }
        function wipeData() { if(confirm("‡∏•‡πâ‡∏≤‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?")) { globalData={staff:{},records:[]}; saveToCloud(); } }
        function findVal(o,k) { for(let i of k) if(o[i]) return o[i]; return null; }
        function parseTime(s) { const [h,m]=s.split(':').map(Number); return {str:s, mins:h*60+m, h}; }
        function parseDate(v) { 
            if(!v) return null;
            if(typeof v==='number') return new Date(Math.round((v-25569)*864e5)).toISOString().split('T')[0]; 
            if(typeof v==='string') {
                const p=v.trim().split(/[-/]/); 
                if(p.length===3) return `${parseInt(p[0])>2000?p[0]:(parseInt(p[2])>2400?parseInt(p[2])-543:p[2])}-${p[1].padStart(2,'0')}-${parseInt(p[0])>2000?p[2]:p[0].padStart(2,'0')}`; 
            } 
            return null; 
        }
        function getDayName(d) { return ['‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå','‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå','‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£','‡∏û‡∏∏‡∏ò','‡∏û‡∏§‡∏´‡∏±‡∏™','‡∏®‡∏∏‡∏Å‡∏£‡πå','‡πÄ‡∏™‡∏≤‡∏£‡πå'][new Date(d).getDay()]; }
    </script>
</body>
</html>
