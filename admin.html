<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin System - Force Update</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style> body { font-family: 'Sarabun', sans-serif; } </style>
</head>
<body class="bg-gray-100 p-6">
    <div class="max-w-4xl mx-auto bg-white p-8 rounded-xl shadow-lg border-t-4 border-indigo-600">
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-2xl font-bold text-gray-800">‚öôÔ∏è Admin Panel (‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•)</h1>
            <div class="flex items-center gap-3">
                <span id="status" class="text-gray-500 font-bold text-sm">‚è≥ ‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠...</span>
                <button onclick="location.reload()" class="bg-gray-200 hover:bg-gray-300 px-3 py-1 rounded text-sm font-bold">‚Üª ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button>
            </div>
        </div>

        <div class="p-6 bg-blue-50 rounded-lg border border-blue-200 mb-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="font-bold text-blue-900 text-lg">1. ‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô (Staff)</h2>
                <div class="text-right">
                    <p class="text-xs text-gray-500">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</p>
                    <p id="cntStaff" class="text-3xl font-bold text-blue-600">-</p>
                </div>
            </div>
            <input type="file" id="fileStaff" accept=".xlsx, .xls, .csv" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-white file:text-blue-700 hover:file:bg-blue-100"/>
            <p class="text-xs text-blue-500 mt-2">* ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏•‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Å‡πà‡∏≤‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡∏±‡∏ö‡∏î‡πâ‡∏ß‡∏¢‡πÑ‡∏ü‡∏•‡πå‡∏ô‡∏µ‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ (‡∏≠‡πà‡∏≤‡∏ô Col A-D)</p>
        </div>

        <div class="grid md:grid-cols-2 gap-6 mb-6">
            <div class="p-4 bg-green-50 rounded-lg border border-green-200">
                <h2 class="font-bold text-green-900 mb-2">2. ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤-‡∏≠‡∏≠‡∏Å (Attendance)</h2>
                <input type="file" id="fileTime" accept=".xlsx, .xls, .csv" class="block w-full text-sm"/>
                <p class="text-xs text-green-600 mt-1">* ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ ID ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</p>
            </div>
            <div class="p-4 bg-orange-50 rounded-lg border border-orange-200">
                <h2 class="font-bold text-orange-900 mb-2">3. ‡∏Å‡∏≤‡∏£‡∏•‡∏≤ (Leave)</h2>
                <input type="file" id="fileLeave" accept=".xlsx, .xls, .csv" class="block w-full text-sm"/>
            </div>
        </div>

        <div class="border-t pt-4 flex justify-between items-center">
            <p class="text-sm text-gray-500">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á: <span id="cntDays" class="font-bold text-gray-800">0</span> ‡∏ß‡∏±‡∏ô</p>
            <button onclick="wipeData()" class="text-red-400 text-xs underline hover:text-red-600">‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (Factory Reset)</button>
        </div>
    </div>

    <script>
        // ‚úÖ URL Firebase
        const RAW_URL = "https://bdlh-cs-default-rtdb.asia-southeast1.firebasedatabase.app/"; 
        const API_URL = (RAW_URL.endsWith('/') ? RAW_URL.slice(0, -1) : RAW_URL) + "/data.json";
        
        let globalData = { staff: {}, records: [] };

        // Init
        (async () => { await checkConnection(); })();

        async function checkConnection() {
            const statusEl = document.getElementById('status');
            try {
                // üî• Cache Busting: ‡πÉ‡∏™‡πà timestamp ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏™‡∏°‡∏≠
                const res = await fetch(`${API_URL}?t=${Date.now()}`);
                if(res.ok) {
                    const json = await res.json();
                    globalData = json || { staff: {}, records: [] };
                    if(!globalData.staff) globalData.staff = {};
                    if(!globalData.records) globalData.records = [];
                    updateUI();
                    statusEl.innerText = "‚úÖ ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÅ‡∏•‡πâ‡∏ß";
                    statusEl.className = "text-green-600 font-bold text-sm";
                } else throw new Error();
            } catch (e) {
                statusEl.innerText = "‚ùå ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ";
                statusEl.className = "text-red-600 font-bold text-sm";
            }
        }

        async function saveToCloud() {
            try {
                // ‡πÉ‡∏ä‡πâ PUT ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Overwrite)
                const res = await fetch(API_URL, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(globalData)
                });
                if(res.ok) { alert('‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!'); updateUI(); }
                else alert('‚ùå ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
            } catch (e) { alert('Error: ' + e.message); }
        }

        function updateUI() {
            document.getElementById('cntStaff').innerText = Object.keys(globalData.staff).length;
            document.getElementById('cntDays').innerText = globalData.records.length;
        }

        async function wipeData() {
            if(confirm("‚ö†Ô∏è ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏õ‡πá‡∏ô 0?")) {
                globalData = { staff: {}, records: [] };
                await saveToCloud();
            }
        }

        // --- Logic ‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå ---
        document.getElementById('fileStaff').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = (evt) => {
                const wb = XLSX.read(evt.target.result, {type:'array'});
                const rows = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], {header:1});
                
                // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ Header ID
                let hIdx = -1;
                for(let i=0; i<Math.min(rows.length, 20); i++) {
                    if(rows[i] && rows[i][0] && String(rows[i][0]).includes('ID')) { hIdx = i; break; }
                }
                if(hIdx === -1) return alert("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå ID");

                const newStaff = {};
                let count = 0;
                for(let i = hIdx+1; i<rows.length; i++) {
                    const r = rows[i];
                    if(!r || !r[0]) continue;
                    const id = String(r[0]).trim();
                    const name = `${String(r[1]||'').trim()} ${String(r[2]||'').trim()}`;
                    const dept = String(r[3]||'‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏').trim().replace(/[.#$/[\]]/g, ' - '); // ‡πÅ‡∏Å‡πâ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡∏ï‡πâ‡∏≠‡∏á‡∏´‡πâ‡∏≤‡∏° Firebase
                    
                    newStaff[id] = { id, name, dept };
                    count++;
                }

                if(confirm(`‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠ ${count} ‡∏Ñ‡∏ô\n‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°?`)) {
                    globalData.staff = newStaff;
                    saveToCloud();
                }
            };
            reader.readAsArrayBuffer(file);
        });

        document.getElementById('fileTime').addEventListener('change', (e) => {
            if(Object.keys(globalData.staff).length === 0) return alert("‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Å‡πà‡∏≠‡∏ô");
            
            const file = e.target.files[0];
            if(!file) return;
            
            // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ä‡πà‡∏ß‡∏¢‡∏≠‡πà‡∏≤‡∏ô (‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á XLSX ‡πÅ‡∏•‡∏∞ CSV ‡πÑ‡∏ó‡∏¢)
            const reader = new FileReader();
            reader.onload = (evt) => {
                try {
                    let wb = XLSX.read(evt.target.result, {type:'array'});
                    // ‡πÄ‡∏ä‡πá‡∏Ñ CSV ‡∏†‡∏≤‡∏©‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏î‡∏≤‡∏ß
                    if(file.name.endsWith('.csv')) {
                         const rowsTest = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], {header:1});
                         if(rowsTest.length > 0 && !JSON.stringify(rowsTest[0]).includes('ID')) {
                             // ‡∏≠‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏î‡πâ‡∏ß‡∏¢ TIS-620
                             const textReader = new FileReader();
                             textReader.onload = (tevt) => {
                                 const text = new TextDecoder('windows-874').decode(tevt.target.result);
                                 wb = XLSX.read(text, {type:'string'});
                                 processTimeData(XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], {header:1}));
                             };
                             textReader.readAsArrayBuffer(file);
                             return;
                         }
                    }
                    processTimeData(XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], {header:1}));
                } catch(err) { alert("Error: " + err.message); }
            };
            reader.readAsArrayBuffer(file);
        });

        function processTimeData(rows) {
            let hIdx = -1;
            for(let i=0; i<rows.length; i++) {
                if(JSON.stringify(rows[i]).includes('ID') && JSON.stringify(rows[i]).includes('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å')) { hIdx = i; break; }
            }
            if(hIdx === -1) return alert("‚ùå ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");

            const dateStr = rows[hIdx]['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà'] || (rows[hIdx+1] ? parseDate(rows[hIdx+1][4]) : null);
            if(!dateStr) return alert("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà");

            // ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏±‡∏ô‡πÄ‡∏î‡∏¥‡∏°‡∏≠‡∏≠‡∏Å (Overwrite Day)
            globalData.records = globalData.records.filter(r => r.date !== dateStr);

            const scanned = new Set();
            let checkOut = 0;
            const late = [], hourly = new Array(24).fill(0).map(()=>({in:0,out:0}));

            for(let i=hIdx+1; i<rows.length; i++) {
                const r = rows[i];
                if(!r || !r[3]) continue;
                const id = String(r[3]).trim();

                // üî• KEY FIX: ‡∏Ç‡πâ‡∏≤‡∏° ID ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏ô Staff ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô (‡πÅ‡∏Å‡πâ Error Dashboard)
                if(!globalData.staff[id]) continue;

                scanned.add(id);
                const times = String(r[7]||"").split(';').map(t=>t.trim()).filter(t=>t);
                
                if(times[0]) { // ‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô
                    const t = parseTime(times[0]);
                    hourly[t.h].in++;
                    // ‡∏™‡∏≤‡∏¢: 08:31 - 16:00
                    if(t.mins > 8*60+30 && t.mins <= 16*60) {
                        late.push({
                            id, 
                            name: globalData.staff[id].name, 
                            dept: globalData.staff[id].dept, 
                            time: t.str, 
                            lateMins: t.mins - (8*60+30)
                        });
                    }
                }
                if(times[1]) { // ‡∏≠‡∏≠‡∏Å‡∏á‡∏≤‡∏ô
                    checkOut++;
                    const t = parseTime(times[1]);
                    hourly[t.h].out++;
                }
            }

            // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏ô‡∏Ç‡∏≤‡∏î
            const missing = [], missingDept = {};
            Object.values(globalData.staff).forEach(emp => {
                if(!scanned.has(emp.id)) {
                    missing.push(emp);
                    missingDept[emp.dept] = (missingDept[emp.dept]||0)+1;
                }
            });

            globalData.records.push({
                date: dateStr,
                day: rows[hIdx+1][5] || "",
                isWeekend: (rows[hIdx+1][5]||"").includes('‡πÄ‡∏™‡∏≤‡∏£‡πå') || (rows[hIdx+1][5]||"").includes('‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå'),
                summary: { total: Object.keys(globalData.staff).length, scanned: scanned.size, checkedOut: checkOut, leave: 0, missing: missing.length },
                lists: { late, missing, missingDept, leave: [] },
                charts: { hourly },
                scannedIds: Array.from(scanned)
            });
            
            globalData.records.sort((a,b) => new Date(a.date) - new Date(b.date));
            saveToCloud();
        }

        document.getElementById('fileLeave').addEventListener('change', (e) => {
             // Logic ‡∏Å‡∏≤‡∏£‡∏•‡∏≤‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏° (‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡∏∏‡∏ì‡∏à‡∏∞‡πÉ‡∏´‡πâ‡∏ú‡∏°‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏Å‡πá‡πÑ‡∏î‡πâ ‡πÅ‡∏ï‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏£‡∏∞‡∏ä‡∏±‡∏ö‡∏Ç‡∏≠‡∏•‡∏∞‡πÑ‡∏ß‡πâ ‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÑ‡∏î‡πâ‡∏Ñ‡∏£‡∏±‡∏ö)
             alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏á‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡∏•‡∏á‡πÑ‡∏ü‡∏•‡πå‡∏•‡∏≤‡∏Ñ‡∏£‡∏±‡∏ö");
        });

        // Utils
        function parseDate(val) {
            if(!val) return null;
            if(typeof val === 'number') return new Date(Math.round((val-25569)*864e5)).toISOString().split('T')[0];
            const p = val.trim().split(/[-/]/);
            if(p.length===3) return `${parseInt(p[2])>2400?parseInt(p[2])-543:p[0]}-${p[1].padStart(2,'0')}-${p[2].padStart(2,'0')}`;
            return null;
        }
        function parseTime(s) {
            const [h,m] = s.split(':').map(Number);
            return { str:s, mins: h*60+m, h };
        }
    </script>
</body>
</html>
