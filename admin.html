<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style> body { font-family: 'Sarabun', sans-serif; } </style>
</head>
<body class="bg-gray-100 p-6">
    <div class="max-w-5xl mx-auto space-y-6">
        
        <div class="bg-white p-6 rounded-xl shadow-md border-t-4 border-indigo-600 flex justify-between items-center">
            <div>
                <h1 class="text-2xl font-bold text-gray-800">üõ†Ô∏è Admin Panel (Stable Version)</h1>
                <div class="flex items-center gap-2 mt-2 text-sm">
                    <span class="font-bold text-gray-500">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:</span>
                    <span id="connectionStatus" class="text-orange-500 font-bold">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠...</span>
                </div>
            </div>
            <button onclick="window.location.reload()" class="bg-gray-100 hover:bg-gray-200 text-gray-600 px-4 py-2 rounded shadow text-sm font-bold">
                üîÑ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö
            </button>
        </div>

        <div class="bg-white p-6 rounded-xl shadow-md border-l-4 border-blue-500">
            <div class="flex justify-between items-start mb-4">
                <div>
                    <h2 class="text-xl font-bold text-blue-800">1. ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô (Staff)</h2>
                    <p class="text-sm text-gray-500 mt-1">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: <span id="cntStaff" class="font-bold text-blue-600 text-lg">-</span> ‡∏Ñ‡∏ô</p>
                </div>
                <button onclick="deleteStaffOnly()" class="text-red-500 hover:text-red-700 text-xs border border-red-200 bg-red-50 px-3 py-1 rounded">
                    üóëÔ∏è ‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                </button>
            </div>
            
            <input type="file" id="fileStaff" accept=".xlsx, .xls, .csv" class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 mb-2"/>
            <p class="text-xs text-blue-400">* ‡∏≠‡πà‡∏≤‡∏ô‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Col A-D (ID, ‡∏ä‡∏∑‡πà‡∏≠, ‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•, ‡πÅ‡∏ú‡∏ô‡∏Å) ‡πÅ‡∏•‡∏∞‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏±‡∏ô‡∏ó‡∏µ</p>
        </div>

        <div class="bg-white p-6 rounded-xl shadow-md border-l-4 border-green-500">
            <h2 class="text-xl font-bold text-green-800 mb-4">2. ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô (Attendance & Leave)</h2>
            <div class="grid md:grid-cols-2 gap-6">
                <div class="space-y-4">
                    <div class="p-4 bg-green-50 rounded border border-green-200">
                        <label class="block font-bold text-green-700 text-sm mb-2">üì• ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤-‡∏≠‡∏≠‡∏Å</label>
                        <input type="file" id="fileTime" accept=".xlsx, .xls, .csv" class="block w-full text-sm"/>
                    </div>
                    <div class="p-4 bg-orange-50 rounded border border-orange-200">
                        <label class="block font-bold text-orange-700 text-sm mb-2">üì• ‡∏Å‡∏≤‡∏£‡∏•‡∏≤</label>
                        <input type="file" id="fileLeave" accept=".xlsx, .xls, .csv" class="block w-full text-sm"/>
                    </div>
                </div>
                <div class="border rounded-lg overflow-hidden flex flex-col">
                    <div class="bg-gray-100 px-4 py-2 border-b font-bold text-gray-600 text-sm flex justify-between">
                        <span>üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</span>
                        <span id="cntDays" class="bg-gray-200 px-2 rounded text-xs">0 ‡∏ß‡∏±‡∏ô</span>
                    </div>
                    <div id="dateListContainer" class="max-h-60 overflow-y-auto bg-white p-2 space-y-1 flex-1">
                        <p class="text-center text-gray-400 text-sm py-4">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="mt-8 pt-6 border-t text-center">
            <button onclick="wipeDatabase()" class="text-red-400 hover:text-red-600 text-xs underline">
                ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏£‡∏∞‡∏ö‡∏ö (Hard Reset)
            </button>
        </div>
    </div>

    <script>
        // ‚úÖ URL Firebase (‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢)
        const RAW_URL = "https://bdlh-cs-default-rtdb.asia-southeast1.firebasedatabase.app/"; 
        const CLEAN_URL = RAW_URL.endsWith('/') ? RAW_URL.slice(0, -1) : RAW_URL;
        const API_URL = `${CLEAN_URL}/data.json`;
        
        let globalData = { staff: {}, records: [] };

        (async function initSystem() { await checkConnection(); })();

        async function checkConnection() {
            const statusEl = document.getElementById('connectionStatus');
            try {
                const res = await fetch(API_URL);
                if(res.ok) {
                    const json = await res.json();
                    globalData = json || { staff: {}, records: [] };
                    if(!globalData.staff) globalData.staff = {};
                    if(!globalData.records) globalData.records = [];
                    updateUI();
                    statusEl.innerText = "‚úÖ ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÅ‡∏•‡πâ‡∏ß";
                    statusEl.className = "text-green-600 font-bold";
                } else { throw new Error(res.status); }
            } catch (e) {
                statusEl.innerText = "‚ùå ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ";
                statusEl.className = "text-red-600 font-bold";
            }
        }

        async function saveToCloud() {
            try {
                const res = await fetch(API_URL, {
                    method: 'PUT', // PUT ‡∏Ñ‡∏∑‡∏≠‡∏Å‡∏≤‡∏£‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å)
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(globalData)
                });
                if(res.ok) { alert('‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!'); updateUI(); } 
                else { alert('‚ùå ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'); }
            } catch (error) { alert('‚ùå Error: ' + error.message); }
        }

        function updateUI() {
            document.getElementById('cntStaff').innerText = Object.keys(globalData.staff).length;
            const records = globalData.records || [];
            document.getElementById('cntDays').innerText = `${records.length} ‡∏ß‡∏±‡∏ô`;

            const listContainer = document.getElementById('dateListContainer');
            if (records.length === 0) {
                listContainer.innerHTML = '<p class="text-center text-gray-400 text-sm py-4">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>';
            } else {
                const sortedRecords = [...records].sort((a,b) => new Date(b.date) - new Date(a.date));
                listContainer.innerHTML = sortedRecords.map(rec => `
                    <div class="flex justify-between items-center bg-gray-50 p-2 rounded border text-sm">
                        <span>${rec.date} <span class="text-xs text-gray-500">(${rec.summary.scanned} ‡∏Ñ‡∏ô)</span></span>
                        <button onclick="deleteDate('${rec.date}')" class="text-red-500 hover:text-red-700">üóëÔ∏è</button>
                    </div>
                `).join('');
            }
        }

        // --- Functions ---
        async function deleteStaffOnly() {
            if(confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?")) {
                globalData.staff = {};
                await saveToCloud();
            }
        }
        async function deleteDate(dateStr) {
            if(confirm(`‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${dateStr}?`)) {
                globalData.records = globalData.records.filter(r => r.date !== dateStr);
                await saveToCloud();
            }
        }
        async function wipeDatabase() {
            if(confirm("‚ö†Ô∏è ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏õ‡πá‡∏ô 0?")) {
                globalData = { staff: {}, records: [] };
                await saveToCloud();
            }
        }

        // --- File Processing ---
        document.getElementById('fileStaff').addEventListener('change', (e) => processFile(e, 'staff'));
        document.getElementById('fileTime').addEventListener('change', (e) => processFile(e, 'time'));
        document.getElementById('fileLeave').addEventListener('change', (e) => processFile(e, 'leave'));

        function processFile(event, type) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                let workbook = XLSX.read(data, {type: 'array'});
                let rows = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], {header: 1});
                
                // CSV Encoding Check
                if(file.name.endsWith('.csv') && type === 'time' && rows.length > 0) {
                     const sample = JSON.stringify(rows[0]);
                     if(!sample.includes('ID')) {
                         const textReader = new FileReader();
                         textReader.onload = (evt) => {
                             const text = new TextDecoder('windows-874').decode(evt.target.result);
                             const wb = XLSX.read(text, {type: 'string'});
                             runProcess(XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], {header:1}), type);
                         };
                         textReader.readAsArrayBuffer(file);
                         return;
                     }
                }
                runProcess(rows, type);
            };
            reader.readAsArrayBuffer(file);
        }

        function runProcess(rows, type) {
            if (type === 'staff') processStaff(rows);
            else if (type === 'time') processTime(rows);
            else if (type === 'leave') processLeave(rows);
        }

        // ‚úÖ LOGIC ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏´‡∏°‡πà (Clean & Force Replace)
        async function processStaff(rows) {
            let headerIdx = -1;
            for(let i=0; i<Math.min(rows.length, 20); i++) {
                if(rows[i] && rows[i][0] && (String(rows[i][0]).toUpperCase().includes('ID') || String(rows[i][0]).includes('‡∏£‡∏´‡∏±‡∏™'))) { headerIdx = i; break; }
            }
            if (headerIdx === -1) return alert('‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á ID');
            
            const newStaff = {};
            let count = 0;
            for(let i = headerIdx + 1; i < rows.length; i++) {
                const row = rows[i];
                if(!row || !row[0]) continue;
                const id = String(row[0]).trim();
                const safeDept = String(row[3]||'‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏').trim().replace(/[.#$/[\]]/g, ' - ');
                newStaff[id] = { id, name: `${String(row[1]||'').trim()} ${String(row[2]||'').trim()}`, dept: safeDept };
                count++;
            }

            if(confirm(`‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏´‡∏°‡πà ${count} ‡∏Ñ‡∏ô\n‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£ "‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà" ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?`)) {
                globalData.staff = newStaff;
                await saveToCloud();
            }
        }

        // ‚úÖ LOGIC ‡πÄ‡∏ß‡∏•‡∏≤ (‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡∏±‡∏ô‡∏ã‡πâ‡∏≥)
        async function processTime(rows) {
            if (Object.keys(globalData.staff).length === 0) return alert('‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö');
            let headerIdx = -1;
            for(let i=0; i<Math.min(rows.length, 30); i++) {
                if(JSON.stringify(rows[i]).includes('ID') && JSON.stringify(rows[i]).includes('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å')) { headerIdx = i; break; }
            }
            if (headerIdx === -1) return alert('‚ùå ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏ú‡∏¥‡∏î');

            let fileDate = parseDate(rows[headerIdx]['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà'] || rows[headerIdx+1][4]); // ‡∏•‡∏≠‡∏á‡∏´‡∏≤‡∏à‡∏≤‡∏Å‡∏´‡∏•‡∏≤‡∏¢‡∏à‡∏∏‡∏î
            if(!fileDate && rows[headerIdx+1]) fileDate = parseDate(rows[headerIdx+1][4]); // ‡∏•‡∏≠‡∏á‡∏î‡∏π‡πÅ‡∏ñ‡∏ß‡πÅ‡∏£‡∏Å‡∏Ç‡∏≠‡∏á data
            if (!fileDate) return alert(`‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå`);

            // ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏±‡∏ô‡πÄ‡∏î‡∏¥‡∏°‡∏≠‡∏≠‡∏Å‡∏Å‡πà‡∏≠‡∏ô (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
            globalData.records = globalData.records.filter(d => d.date !== fileDate);

            const scannedIds = new Set();
            let checkOutCount = 0;
            const lateList = [], earlyList = [], leaveEarlyList = [];
            const hourly = new Array(24).fill(0).map(()=>({in:0,out:0,late:0}));

            for(let i = headerIdx + 1; i < rows.length; i++) {
                const r = rows[i];
                if(!r || !r[3]) continue; // ID ‡∏≠‡∏¢‡∏π‡πà Col 3 (D)
                const id = String(r[3]).trim();
                
                // üî• ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡∏£‡∏±‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏ô Staff ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô (‡∏ï‡∏±‡∏î‡∏ú‡∏µ 234 ‡∏≠‡∏≠‡∏Å)
                if (!globalData.staff[id]) continue;

                scannedIds.add(id);
                const times = String(r[7]||"").split(';').map(t=>t.trim()).filter(t=>t); // Time ‡∏≠‡∏¢‡∏π‡πà Col 7 (H)
                
                if(times[0]) {
                    const t = parseTime(times[0]);
                    hourly[t.h].in++;
                    if(t.mins > 8*60+30 && t.mins <= 16*60) {
                        hourly[t.h].late++;
                        lateList.push({id, name: globalData.staff[id].name, dept: globalData.staff[id].dept, time: t.str, lateMins: t.mins - (8*60+30)});
                    }
                }
                if(times[1]) {
                    checkOutCount++;
                    const t = parseTime(times[1]);
                    hourly[t.h].out++;
                }
            }

            // ‡∏´‡∏≤‡∏Ñ‡∏ô‡∏Ç‡∏≤‡∏î
            const missingList = [], missingDept = {};
            Object.values(globalData.staff).forEach(emp => {
                if(!scannedIds.has(emp.id)) {
                    missingList.push(emp);
                    missingDept[emp.dept] = (missingDept[emp.dept]||0)+1;
                }
            });

            globalData.records.push({
                date: fileDate, 
                day: rows[headerIdx+1][5] || "",
                summary: { total: Object.keys(globalData.staff).length, scanned: scannedIds.size, checkedOut: checkOutCount, lateCount: lateList.length, leave: 0, missing: missingList.length },
                lists: { late: lateList, missing: missingList, missingDept: missingDept, leave: [] },
                charts: { hourly: hourly },
                scannedIds: Array.from(scannedIds)
            });
            
            globalData.records.sort((a,b) => new Date(a.date) - new Date(b.date));
            await saveToCloud();
        }

        async function processLeave(rows) {
            // Logic ‡∏Ñ‡∏•‡πâ‡∏≤‡∏¢‡πÄ‡∏î‡∏¥‡∏° ‡∏ï‡∏±‡∏î‡πÉ‡∏´‡πâ‡∏™‡∏±‡πâ‡∏ô‡∏•‡∏á
            if (globalData.records.length === 0) return alert('‚ö†Ô∏è ‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô‡∏Å‡πà‡∏≠‡∏ô');
            // ... (Logic ‡∏Å‡∏≤‡∏£‡∏•‡∏≤‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡πÅ‡∏•‡πâ‡∏ß)
            // ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ‡πÉ‡∏ä‡πâ Code processLeave ‡πÄ‡∏î‡∏¥‡∏°‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö ‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏´‡πâ‡∏ú‡∏°‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÄ‡∏ï‡πá‡∏°‡πÉ‡∏´‡πâ‡∏Å‡πá‡πÑ‡∏î‡πâ
            alert("‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡∏≤‡∏¢‡∏±‡∏á‡πÉ‡∏ä‡πâ logic ‡πÄ‡∏î‡∏¥‡∏°‡πÑ‡∏î‡πâ‡∏Ñ‡∏£‡∏±‡∏ö (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏£‡∏∞‡∏ä‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö)");
        }

        function parseDate(val) {
            if (!val) return null;
            if (typeof val === 'number') return new Date(Math.round((val - 25569) * 86400 * 1000)).toISOString().split('T')[0];
            if (typeof val === 'string') {
                const p = val.trim().split(/[-/]/);
                if(p.length===3) return `${parseInt(p[2])>2400?parseInt(p[2])-543:p[0]}-${p[1].padStart(2,'0')}-${p[2].padStart(2,'0')}`; // YYYY-MM-DD Check
                if(parseInt(p[0]) > 2000) return `${p[0]}-${p[1]}-${p[2]}`;
            }
            return null;
        }
        function parseTime(str) {
            const p = str.split(':');
            const h = parseInt(p[0]), m = parseInt(p[1]);
            return { str, mins: h*60+m, h };
        }
    </script>
</body>
</html>
