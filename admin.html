<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Fixed Leave)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style> body { font-family: 'Sarabun', sans-serif; } </style>
</head>
<body class="bg-gray-100 p-6">
    <div class="max-w-5xl mx-auto space-y-6">
        
        <div class="bg-white p-6 rounded-xl shadow-md border-t-4 border-indigo-600 flex justify-between items-center">
            <div>
                <h1 class="text-2xl font-bold text-gray-800">üõ†Ô∏è Admin Panel (Fixed Leave Upload)</h1>
                <div class="flex items-center gap-2 mt-2 text-sm">
                    <span class="font-bold text-gray-500">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Cloud:</span>
                    <span id="connectionStatus" class="text-orange-500 font-bold">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠...</span>
                </div>
            </div>
            <button onclick="window.location.reload()" class="bg-gray-100 hover:bg-gray-200 text-gray-600 px-4 py-2 rounded shadow text-sm font-bold">
                üîÑ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö
            </button>
        </div>

        <div class="bg-white p-6 rounded-xl shadow-md border-l-4 border-blue-500">
            <div class="flex justify-between items-start mb-4">
                <div>
                    <h2 class="text-xl font-bold text-blue-800">1. ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠ (Staff)</h2>
                    <p class="text-sm text-gray-500 mt-1">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö: <span id="cntStaff" class="font-bold text-blue-600 text-lg">-</span> ‡∏Ñ‡∏ô</p>
                </div>
                <button onclick="deleteStaffOnly()" class="text-red-500 hover:text-red-700 text-sm font-bold border border-red-200 bg-red-50 hover:bg-red-100 px-3 py-1 rounded transition">
                    üóëÔ∏è ‡∏•‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠
                </button>
            </div>
            <input type="file" id="fileStaff" accept=".xlsx, .xls, .csv" class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 mb-2"/>
            <p class="text-xs text-blue-400">* ‡∏≠‡πà‡∏≤‡∏ô Col A-D ‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏±‡∏ô‡∏ó‡∏µ</p>
        </div>

        <div class="bg-white p-6 rounded-xl shadow-md border-l-4 border-green-500">
            <h2 class="text-xl font-bold text-green-800 mb-4">2. ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô (Attendance & Leave)</h2>
            
            <div class="grid md:grid-cols-2 gap-6">
                <div class="space-y-4">
                    <div class="p-4 bg-green-50 rounded border border-green-200">
                        <label class="block font-bold text-green-700 text-sm mb-2">üì• 1. ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤-‡∏≠‡∏≠‡∏Å (Attendance)</label>
                        <input type="file" id="fileTime" accept=".xlsx, .xls, .csv" class="block w-full text-sm"/>
                    </div>
                    <div class="p-4 bg-blue-50 rounded border border-blue-200">
                        <label class="block font-bold text-blue-700 text-sm mb-2">üì• 2. ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏Å‡∏≤‡∏£‡∏•‡∏≤ (Leave)</label>
                        <input type="file" id="fileLeave" accept=".xlsx, .xls, .csv" class="block w-full text-sm"/>
                        <p class="text-xs text-blue-500 mt-1">* ‡∏ï‡πâ‡∏≠‡∏á‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤-‡∏≠‡∏≠‡∏Å (‡∏Ç‡πâ‡∏≠ 1) ‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏±‡πâ‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏™‡∏°‡∏≠</p>
                    </div>
                </div>

                <div class="border rounded-lg overflow-hidden flex flex-col h-64">
                    <div class="bg-gray-100 px-4 py-2 border-b font-bold text-gray-600 text-sm flex justify-between items-center">
                        <span>üìÖ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</span>
                        <span id="cntDays" class="bg-gray-200 text-gray-600 px-2 py-0.5 rounded text-xs">0 ‡∏ß‡∏±‡∏ô</span>
                    </div>
                    <div id="dateListContainer" class="flex-1 overflow-y-auto bg-white p-2 space-y-1">
                        <p class="text-center text-gray-400 text-sm py-4">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="mt-8 pt-6 border-t text-center">
            <button onclick="wipeDatabase()" class="text-red-400 hover:text-red-600 text-xs underline">
                ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏£‡∏∞‡∏ö‡∏ö (Factory Reset)
            </button>
        </div>
    </div>

    <script>
        // ‚úÖ URL Firebase
        const RAW_URL = "https://bdlh-cs-default-rtdb.asia-southeast1.firebasedatabase.app/"; 
        const CLEAN_URL = RAW_URL.endsWith('/') ? RAW_URL.slice(0, -1) : RAW_URL;
        const API_URL = `${CLEAN_URL}/data.json`;
        
        let globalData = { staff: {}, records: [] };

        (async function initSystem() {
            await checkConnection();
        })();

        async function checkConnection() {
            const statusEl = document.getElementById('connectionStatus');
            try {
                const res = await fetch(`${API_URL}?t=${Date.now()}`); // Anti-cache
                if(res.ok) {
                    const json = await res.json();
                    globalData = json || { staff: {}, records: [] };
                    if(!globalData.staff) globalData.staff = {};
                    if(!globalData.records) globalData.records = [];
                    updateUI();
                    statusEl.innerText = "‚úÖ ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÅ‡∏•‡πâ‡∏ß";
                    statusEl.className = "text-green-600 font-bold";
                } else { throw new Error(res.status); }
            } catch (error) {
                statusEl.innerText = "‚ùå ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ";
                statusEl.className = "text-red-600 font-bold";
            }
        }

        async function saveToCloud() {
            try {
                const res = await fetch(API_URL, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(globalData)
                });
                if(res.ok) { alert('‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!'); updateUI(); } 
                else { alert('‚ùå ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'); }
            } catch (error) { alert('‚ùå Error: ' + error.message); }
        }

        // --- Update UI ---
        function updateUI() {
            document.getElementById('cntStaff').innerText = Object.keys(globalData.staff).length;
            const records = globalData.records || [];
            document.getElementById('cntDays').innerText = `${records.length} ‡∏ß‡∏±‡∏ô`;
            
            const listContainer = document.getElementById('dateListContainer');
            if (records.length === 0) {
                listContainer.innerHTML = '<p class="text-center text-gray-400 text-sm py-4">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>';
            } else {
                const sortedRecords = [...records].sort((a,b) => new Date(b.date) - new Date(a.date));
                listContainer.innerHTML = sortedRecords.map(rec => `
                    <div class="flex justify-between items-center bg-gray-50 hover:bg-indigo-50 p-2 rounded border border-gray-200 transition">
                        <div>
                            <span class="font-bold text-gray-700 text-sm">${rec.date}</span>
                            <span class="text-xs text-gray-500 ml-2">(${rec.day})</span>
                            <div class="text-xs text-gray-400 mt-1">
                                ‡∏™‡πÅ‡∏Å‡∏ô: <span class="text-green-600 font-bold">${rec.summary.scanned}</span> | 
                                ‡∏•‡∏≤: <span class="text-blue-600 font-bold">${rec.summary.leave || 0}</span> |
                                ‡∏Ç‡∏≤‡∏î: <span class="text-red-600 font-bold">${rec.summary.missing}</span>
                            </div>
                        </div>
                        <button onclick="deleteDate('${rec.date}')" class="text-red-500 hover:text-red-700 bg-white border border-red-200 p-1 px-2 rounded text-xs shadow-sm">
                            ‡∏•‡∏ö‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ
                        </button>
                    </div>
                `).join('');
            }
        }

        // --- Deletion Functions ---
        async function deleteStaffOnly() {
            if(confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?")) {
                globalData.staff = {};
                await saveToCloud();
            }
        }
        async function deleteDate(dateStr) {
            if(confirm(`‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà "${dateStr}" ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) {
                globalData.records = globalData.records.filter(r => r.date !== dateStr);
                await saveToCloud();
            }
        }
        async function wipeDatabase() {
            if(confirm("‚ö†Ô∏è ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô 0?")) {
                globalData = { staff: {}, records: [] };
                await saveToCloud();
            }
        }

        // --- File Processing ---
        document.getElementById('fileStaff').addEventListener('change', (e) => processFile(e, 'staff'));
        document.getElementById('fileTime').addEventListener('change', (e) => processFile(e, 'time'));
        document.getElementById('fileLeave').addEventListener('change', (e) => processFile(e, 'leave'));

        function processFile(event, type) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                let workbook = XLSX.read(data, {type: 'array'});
                let rows = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], {header: 1});
                
                // CSV Fix for Time file
                if(file.name.endsWith('.csv') && type === 'time' && rows.length > 0 && !JSON.stringify(rows[0]).includes('ID')) {
                     const textReader = new FileReader();
                     textReader.onload = (evt) => {
                         const text = new TextDecoder('windows-874').decode(evt.target.result);
                         const wb = XLSX.read(text, {type: 'string'});
                         runProcess(XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], {header:1}), type);
                     };
                     textReader.readAsArrayBuffer(file);
                     return;
                }
                runProcess(rows, type);
            };
            reader.readAsArrayBuffer(file);
        }

        function runProcess(rows, type) {
            if (type === 'staff') processStaff(rows);
            else if (type === 'time') processTime(rows);
            else if (type === 'leave') processLeave(rows);
        }

        async function processStaff(rows) {
            let headerIdx = -1;
            for(let i=0; i<Math.min(rows.length, 20); i++) {
                if(rows[i] && rows[i][0] && String(rows[i][0]).includes('ID')) { headerIdx = i; break; }
            }
            if (headerIdx === -1) return alert('‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö ID ‡πÉ‡∏ô Column A');
            
            const newStaff = {};
            let count = 0;
            for(let i = headerIdx + 1; i < rows.length; i++) {
                const r = rows[i];
                if(!r || !r[0]) continue;
                const id = String(r[0]).trim();
                const safeDept = String(r[3]||'‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏').trim().replace(/[.#$/[\]]/g, ' - ');
                newStaff[id] = { id, name: `${String(r[1]||'').trim()} ${String(r[2]||'').trim()}`, dept: safeDept };
                count++;
            }
            if(confirm(`‡∏û‡∏ö ${count} ‡∏Ñ‡∏ô ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡∏±‡∏ö?`)) {
                globalData.staff = newStaff;
                await saveToCloud();
            }
        }

        async function processTime(rows) {
            if (Object.keys(globalData.staff).length === 0) return alert('‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Å‡πà‡∏≠‡∏ô');
            let hIdx = -1;
            for(let i=0; i<rows.length; i++) {
                if(JSON.stringify(rows[i]).includes('ID') && JSON.stringify(rows[i]).includes('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å')) { hIdx = i; break; }
            }
            if (hIdx === -1) return alert('‚ùå ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏ú‡∏¥‡∏î');

            let dateStr = rows[hIdx]['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà'] || (rows[hIdx+1] ? parseDate(rows[hIdx+1][4]) : null);
            if(!dateStr && rows[hIdx+1]) dateStr = parseDate(rows[hIdx+1][4]); 
            if (!dateStr) return alert(`‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà`);

            globalData.records = globalData.records.filter(d => d.date !== dateStr); // Overwrite

            const scanned = new Set();
            let checkOut = 0;
            const late = [], hourly = new Array(24).fill(0).map(()=>({in:0,out:0}));

            for(let i = hIdx + 1; i < rows.length; i++) {
                const r = rows[i];
                if(!r || !r[3]) continue;
                const id = String(r[3]).trim();
                
                if (!globalData.staff[id]) continue; // Only existing staff

                scanned.add(id);
                const times = String(r[7]||"").split(';').map(t=>t.trim()).filter(t=>t);
                
                if(times[0]) {
                    const t = parseTime(times[0]);
                    hourly[t.h].in++;
                    if(t.mins > 8*60+30 && t.mins <= 16*60) {
                        late.push({id, name: globalData.staff[id].name, dept: globalData.staff[id].dept, time: t.str, lateMins: t.mins - (8*60+30)});
                    }
                }
                if(times[1]) { checkOut++; const t = parseTime(times[1]); hourly[t.h].out++; }
            }

            const missing = [], missingDept = {};
            Object.values(globalData.staff).forEach(emp => {
                if(!scanned.has(emp.id)) {
                    missing.push(emp);
                    missingDept[emp.dept] = (missingDept[emp.dept]||0)+1;
                }
            });

            globalData.records.push({
                date: dateStr, 
                day: rows[hIdx+1][5] || "",
                isWeekend: (rows[hIdx+1][5]||"").includes('‡πÄ‡∏™‡∏≤‡∏£‡πå') || (rows[hIdx+1][5]||"").includes('‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå'),
                summary: { total: Object.keys(globalData.staff).length, scanned: scanned.size, checkedOut: checkOut, leave: 0, missing: missing.length },
                lists: { late, missing, missingDept, leave: [] },
                charts: { hourly },
                scannedIds: Array.from(scanned)
            });
            globalData.records.sort((a,b) => new Date(a.date) - new Date(b.date));
            await saveToCloud();
        }

        // üî• FIX: Leave Processing üî•
        async function processLeave(rows) {
            if (globalData.records.length === 0) return alert('‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏á‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤-‡∏≠‡∏≠‡∏Å ‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏±‡πâ‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö');
            
            // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ Header ‡∏Ç‡∏≠‡∏á‡πÑ‡∏ü‡∏•‡πå Leave (ID, ... ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏•‡∏≤‡∏á‡∏≤‡∏ô, ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó)
            let hIdx = -1;
            for(let i=0; i<Math.min(rows.length, 20); i++) {
                if(rows[i] && rows[i][0] && String(rows[i][0]).includes('ID') && JSON.stringify(rows[i]).includes('‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó')) { 
                    hIdx = i; break; 
                }
            }
            if(hIdx === -1) return alert("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö Header (ID, ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏•‡∏≤‡∏á‡∏≤‡∏ô, ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó) ‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå Leave");

            // Group ‡πÉ‡∏ö‡∏•‡∏≤‡∏ï‡∏≤‡∏°‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà
            const leavesByDate = {};
            for(let i=hIdx+1; i<rows.length; i++) {
                const r = rows[i];
                if(!r || !r[0]) continue; // ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ ID

                const id = String(r[0]).trim();
                const rawDate = r[4]; // Col E = ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏•‡∏≤‡∏á‡∏≤‡∏ô
                const type = r[5];    // Col F = ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó

                const dateStr = parseDate(rawDate);
                if(dateStr && id && globalData.staff[id]) {
                    if(!leavesByDate[dateStr]) leavesByDate[dateStr] = [];
                    leavesByDate[dateStr].push({
                        id,
                        name: globalData.staff[id].name,
                        type: type || '‡∏•‡∏≤',
                        isHalf: (type||'').includes('‡∏Ñ‡∏£‡∏∂‡πà‡∏á')
                    });
                }
            }

            // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡∏á Record ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Missing ‡πÉ‡∏´‡∏°‡πà
            let updatedCount = 0;
            globalData.records = globalData.records.map(day => {
                if(leavesByDate[day.date]) {
                    updatedCount++;
                    const todayLeaves = leavesByDate[day.date];
                    
                    // 1. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡∏≤
                    day.lists.leave = todayLeaves;
                    day.summary.leave = todayLeaves.length;

                    // 2. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Missing ‡πÉ‡∏´‡∏°‡πà (Missing = Staff - Scanned - Leave)
                    const scannedIds = new Set(day.scannedIds);
                    const leaveIds = new Set(todayLeaves.map(l => l.id));
                    
                    const newMissing = [], newMissingDept = {};
                    Object.values(globalData.staff).forEach(emp => {
                        // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏™‡πÅ‡∏Å‡∏ô ‡πÅ‡∏•‡∏∞ ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏•‡∏≤ = ‡∏Ç‡∏≤‡∏î‡∏á‡∏≤‡∏ô
                        if(!scannedIds.has(emp.id) && !leaveIds.has(emp.id)) {
                            newMissing.push(emp);
                            newMissingDept[emp.dept] = (newMissingDept[emp.dept]||0)+1;
                        }
                    });

                    day.lists.missing = newMissing;
                    day.lists.missingDept = newMissingDept;
                    day.summary.missing = newMissing.length;
                }
                return day;
            });

            if(updatedCount > 0) {
                await saveToCloud();
                alert(`‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏•‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ (${updatedCount} ‡∏ß‡∏±‡∏ô)`);
            } else {
                alert("‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö (‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏•‡∏á‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤-‡∏≠‡∏≠‡∏Å ‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏•‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á)");
            }
        }

        function parseDate(val) {
            if(!val) return null;
            if(typeof val === 'number') return new Date(Math.round((val-25569)*864e5)).toISOString().split('T')[0];
            const p = String(val).trim().split(/[-/]/);
            if(p.length===3) return `${parseInt(p[2])>2400?parseInt(p[2])-543:p[0]}-${p[1].padStart(2,'0')}-${p[2].padStart(2,'0')}`;
            return null;
        }
        function parseTime(s) {
            const [h,m] = s.split(':').map(Number);
            return { str:s, mins: h*60+m, h };
        }
    </script>
</body>
</html>
